name: Django CI with Poetry (Manual Setup)

# События, которые будут запускать этот workflow
on:
  push:
    branches: [ main ] # или master, если у тебя так называется основная ветка
  pull_request:
    branches: [ main ] # или master

jobs:
  build:
    # Тип исполнителя (runner), на котором будет выполняться задание
    # ubuntu-latest - это последняя стабильная версия Ubuntu, предоставляемая GitHub
    runs-on: ubuntu-latest

    strategy:
      # Можно указать несколько версий Python, если хочешь тестировать на них
      matrix:
        python-version: ["3.13"] # Only use Python 3.13

    steps:
    # Шаг 1: Клонирование твоего репозитория
    # Используем готовый action 'actions/checkout'
    - name: Checkout repository
      uses: actions/checkout@v4 # Рекомендуется использовать последнюю мажорную версию

    # Шаг 2: Настройка Python
    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v5
      with:
        python-version: ${{ matrix.python-version }}
        # We remove explicit poetry caching here; snok/install-poetry will handle its installation.
        # Caching the .venv directory (done in a later step) is the most effective caching for dependencies.

    # Шаг 2.1: Установка Poetry с использованием snok/install-poetry
    - name: Install Poetry
      uses: snok/install-poetry@v1.3.4 # Using a specific stable version of the action for reproducibility
      with:
        version: "2.1.3" # Specify the Poetry version that pipx was installing
        virtualenvs-in-project: true # Configure Poetry to create .venv in the project directory
        # The snok/install-poetry action handles adding Poetry to the PATH.

    # Шаг 2.2: Кэширование виртуального окружения Poetry
    # Кэшируем директорию .venv, где Poetry будет создавать окружение
    - name: Cache Poetry virtualenv
      id: cache-poetry-venv # Даем ID для использования в условии следующего шага (если потребуется)
      uses: actions/cache@v4
      with:
        path: .venv # Poetry создаст venv здесь из-за virtualenvs.in-project=true
        key: ${{ runner.os }}-poetry-${{ matrix.python-version }}-${{ hashFiles('**/poetry.lock') }}
        restore-keys: |
          ${{ runner.os }}-poetry-${{ matrix.python-version }}-

    # Шаг 4: Установка зависимостей проекта с помощью Poetry
    - name: Install dependencies
      run: |
        poetry install --no-interaction --no-ansi
        # Если кэш не был восстановлен, poetry install создаст .venv и установит все.
        # Если кэш был восстановлен, poetry install быстро проверит и доустановит недостающее.
        # Если у тебя есть группы зависимостей, например [tool.poetry.group.dev.dependencies]
        # для flake8 и других инструментов разработки, используй:
        # poetry install --with dev --no-interaction --no-ansi

    # Шаг 5: Запуск тестов Django
    - name: Run Django Tests
      run: poetry run python manage.py test

    # Шаг 6: Запуск flake8 для проверки кода
    - name: Lint with Flake8 (Poetry)
      run: poetry run flake8 . --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics
      # --count - количество ошибок
      # --exit-zero - завершить с кодом 0, даже если есть ошибки  
      # --max-complexity=10 - максимальная сложность функции
      # --max-line-length=127 - максимальная длина строки
      # --statistics - статистика по ошибкам
      # poetry run flake8 .
