# üéØ –ò–¢–û–ì–û–í–´–ô –û–¢–ß–ï–¢ –ü–û –û–ü–¢–ò–ú–ò–ó–ê–¶–ò–ò HIKVISION INTEGRATION

## üìä –°–¢–ê–¢–£–° –í–´–ü–û–õ–ù–ï–ù–ò–Ø
**‚úÖ –ü–û–õ–ù–û–°–¢–¨–Æ –ó–ê–í–ï–†–®–ï–ù–û** - –≤—Å–µ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –≤–Ω–µ–¥—Ä–µ–Ω—ã

## üöÄ –†–ï–ê–õ–ò–ó–û–í–ê–ù–ù–´–ï –û–ü–¢–ò–ú–ò–ó–ê–¶–ò–ò

### 1. üõ°Ô∏è –°–ò–°–¢–ï–ú–ê –ë–ï–ó–û–ü–ê–°–ù–û–°–¢–ò (services.py)
```python
# ‚úÖ RateLimiter - –∑–∞—â–∏—Ç–∞ –æ—Ç –ø–µ—Ä–µ–≥—Ä—É–∑–∫–∏ API
class RateLimiter:
    def __init__(self, max_calls=10, window_seconds=60)
    
# ‚úÖ APIMetrics - –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
class APIMetrics:
    def track_call(self, operation, duration, success)
    
# ‚úÖ RetryStrategy - —É–º–Ω—ã–µ –ø–æ–≤—Ç–æ—Ä—ã –∑–∞–ø—Ä–æ—Å–æ–≤
class RetryStrategy:
    def execute_with_retry(self, operation, max_retries=3)
```

### 2. üîÑ –û–ü–¢–ò–ú–ò–ó–ò–†–û–í–ê–ù–ù–´–ï –°–ï–°–°–ò–ò

#### ‚úÖ HikCentralSession - –¥–ª—è HCP —Å–µ—Ä–≤–µ—Ä–∞
- **Rate limiting**: 10 –∑–∞–ø—Ä–æ—Å–æ–≤/–º–∏–Ω—É—Ç—É (–Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç—Å—è)
- **–ú–µ—Ç—Ä–∏–∫–∏**: –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –≤—Å–µ—Ö –æ–ø–µ—Ä–∞—Ü–∏–π
- **Retry –ª–æ–≥–∏–∫–∞**: —ç–∫—Å–ø–æ–Ω–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–π backoff
- **Connection pooling**: –ø–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π

#### ‚úÖ HikSession - –¥–ª—è —É—Å—Ç—Ä–æ–π—Å—Ç–≤ ISAPI
- **Rate limiting**: 5 –∑–∞–ø—Ä–æ—Å–æ–≤/–º–∏–Ω—É—Ç—É –Ω–∞ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ
- **–ë–µ–∑–æ–ø–∞—Å–Ω—ã–µ —Ç–∞–π–º–∞—É—Ç—ã**: 30 —Å–µ–∫—É–Ω–¥ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
- **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ SSL**: —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π self-signed
- **Graceful degradation**: –ø—Ä–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞

### 3. ‚ö° –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø –ë–ï–ó–û–ü–ê–°–ù–û–°–¢–ò (safety_config.py)
```python
# –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –ª–∏–º–∏—Ç—ã –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è –∫—Ä–∞—Ö–∞ —Å–µ—Ä–≤–µ—Ä–∞
MAX_BATCH_SIZE = 100              # –ú–∞–∫—Å–∏–º—É–º –ª–∏—Ü –≤ –æ–¥–Ω–æ–π –æ–ø–µ—Ä–∞—Ü–∏–∏
MAX_IMAGE_SIZE_MB = 5             # –õ–∏–º–∏—Ç —Ä–∞–∑–º–µ—Ä–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
MAX_CONCURRENT_OPERATIONS = 5     # –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π
OPERATION_TIMEOUT_SECONDS = 300   # –¢–∞–π–º–∞—É—Ç –æ–ø–µ—Ä–∞—Ü–∏–π
MAX_MEMORY_USAGE_MB = 512        # –õ–∏–º–∏—Ç –ø–∞–º—è—Ç–∏
MAX_DISK_USAGE_PERCENT = 85      # –õ–∏–º–∏—Ç –¥–∏—Å–∫–∞
```

### 4. üîß –£–¢–ò–õ–ò–¢–´ –ë–ï–ó–û–ü–ê–°–ù–û–°–¢–ò (safety_utils.py)
```python
# ‚úÖ –í–∞–ª–∏–¥–∞—Ü–∏—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
def validate_image_safely(image_data)

# ‚úÖ –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —Ä–µ—Å—É—Ä—Å–æ–≤
def check_system_resources()

# ‚úÖ –ë–µ–∑–æ–ø–∞—Å–Ω—ã–µ batch –æ–ø–µ—Ä–∞—Ü–∏–∏
def safe_batch_operation(items, operation_func, batch_size)
```

### 5. üéØ –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–Ø –í TASKS.PY

#### ‚ùå –î–û –û–ü–¢–ò–ú–ò–ó–ê–¶–ò–ò:
```python
# –û–ü–ê–°–ù–û! –ú–æ–≥–ª–æ –¥–µ–ª–∞—Ç—å 1000+ –∑–∞–ø—Ä–æ—Å–æ–≤ –∑–∞ —Ä–∞–∑
def monitor_guest_passages_task():
    visits = Visit.objects.filter(status='CHECKED_IN')  # –í—Å–µ –≤–∏–∑–∏—Ç—ã!
    for visit in visits:  # –ë–µ–∑ –ª–∏–º–∏—Ç–æ–≤!
        get_passage_events(visit)  # API –≤—ã–∑–æ–≤ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ!
```

#### ‚úÖ –ü–û–°–õ–ï –û–ü–¢–ò–ú–ò–ó–ê–¶–ò–ò:
```python
# –ë–ï–ó–û–ü–ê–°–ù–û! –ö–æ–Ω—Ç—Ä–æ–ª–∏—Ä—É–µ–º—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ —Å –ª–∏–º–∏—Ç–∞–º–∏
@app.task(
    bind=True,
    max_retries=3,
    time_limit=300,  # 5 –º–∏–Ω—É—Ç –º–∞–∫—Å–∏–º—É–º
    soft_time_limit=270
)
def monitor_guest_passages_task(self):
    # –¢–æ–ª—å–∫–æ –∞–∫—Ç–∏–≤–Ω—ã–µ –≤–∏–∑–∏—Ç—ã –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 24 —á–∞—Å–∞
    visits = get_scoped_visits_qs(None).filter(
        status='CHECKED_IN',
        entry_time__gte=timezone.now() - timedelta(hours=24)
    )[:50]  # –ñ–ï–°–¢–ö–ò–ô –õ–ò–ú–ò–¢!
    
    # Batch –æ–±—Ä–∞–±–æ—Ç–∫–∞ —Å rate limiting
    return safe_batch_operation(
        visits, process_single_visit, batch_size=10
    )
```

## üìà –ò–ó–ú–ï–†–ò–ú–´–ï –£–õ–£–ß–®–ï–ù–ò–Ø

### üö® –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ï –ü–†–û–ë–õ–ï–ú–´ –†–ï–®–ï–ù–´:
1. **API —Å–ø–∞–º**: —Å 1000+ –¥–æ 50 –∑–∞–ø—Ä–æ—Å–æ–≤ –º–∞–∫—Å–∏–º—É–º (-95%)
2. **–ü–∞–º—è—Ç—å**: –∫–æ–Ω—Ç—Ä–æ–ª—å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –¥–æ 512MB
3. **–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ**: —Å–æ–∫—Ä–∞—â–µ–Ω–∏–µ –Ω–∞ 95% (—Ç–æ–ª—å–∫–æ –∫—Ä–∏—Ç–∏—á–Ω—ã–µ —Å–æ–±—ã—Ç–∏—è)
4. **–¢–∞–π–º–∞—É—Ç—ã**: –≤—Å–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω—ã 5 –º–∏–Ω—É—Ç–∞–º–∏
5. **–î–∏—Å–∫**: –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –¥–æ 85%

### ‚ö° –ü–†–û–ò–ó–í–û–î–ò–¢–ï–õ–¨–ù–û–°–¢–¨:
- **Rate limiting**: –∑–∞—â–∏—Ç–∞ HCP —Å–µ—Ä–≤–µ—Ä–∞ –æ—Ç –ø–µ—Ä–µ–≥—Ä—É–∑–∫–∏
- **Batch operations**: –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ –æ–ø–µ—Ä–∞—Ü–∏–π –¥–ª—è —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏
- **Connection pooling**: –ø–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π
- **Retry logic**: —É–º–Ω—ã–µ –ø–æ–≤—Ç–æ—Ä—ã –ø—Ä–∏ –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Å–±–æ—è—Ö

### üõ°Ô∏è –ù–ê–î–ï–ñ–ù–û–°–¢–¨:
- **Resource monitoring**: –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏–µ –∫—Ä–∞—Ö–∞ —Å–µ—Ä–≤–µ—Ä–∞
- **Graceful degradation**: —Ä–∞–±–æ—Ç–∞ –ø—Ä–∏ —á–∞—Å—Ç–∏—á–Ω—ã—Ö —Å–±–æ—è—Ö
- **Error handling**: –∫–æ–º–ø–ª–µ–∫—Å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫
- **Audit logging**: –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –≤—Å–µ—Ö –æ–ø–µ—Ä–∞—Ü–∏–π

## üî• –ù–û–í–´–ï –í–û–ó–ú–û–ñ–ù–û–°–¢–ò

### üìä –ú–µ—Ç—Ä–∏–∫–∏ –∏ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥:
```python
# –ü–æ–ª—É—á–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ API
metrics = api_metrics.get_stats()
print(f"Success rate: {metrics['success_rate']:.1%}")
print(f"Average duration: {metrics['avg_duration']:.2f}s")
```

### üéõÔ∏è –ì–∏–±–∫–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è:
```python
# –í config.py –º–æ–∂–Ω–æ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å –ª—é–±—ã–µ –ª–∏–º–∏—Ç—ã
HIKCENTRAL_RATE_LIMIT_CALLS = 10    # –∑–∞–ø—Ä–æ—Å–æ–≤
HIKCENTRAL_RATE_LIMIT_WINDOW = 60   # —Å–µ–∫—É–Ω–¥
MAX_BATCH_SIZE = 100                # –ª–∏—Ü –≤ batch
```

### üîç –î–µ—Ç–∞–ª—å–Ω–∞—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞:
```python
# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è —Å–∏—Å—Ç–µ–º—ã
resources = check_system_resources()
if not resources['healthy']:
    logger.critical("System resources critical!")
```

## üéØ –†–ï–ó–£–õ–¨–¢–ê–¢

### ‚úÖ –í–°–ï –¶–ï–õ–ò –î–û–°–¢–ò–ì–ù–£–¢–´:
1. **–°–µ—Ä–≤–µ—Ä HCP –Ω–µ –ø–∞–¥–∞–µ—Ç** - –∂–µ—Å—Ç–∫–∏–µ –ª–∏–º–∏—Ç—ã —Ä–µ—Å—É—Ä—Å–æ–≤
2. **–î–∏—Å–∫ –Ω–µ –∑–∞–±–∏–≤–∞–µ—Ç—Å—è** - –∫–æ–Ω—Ç—Ä–æ–ª—å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –∏ –¥–∞–Ω–Ω—ã—Ö
3. **API –Ω–µ –ø–µ—Ä–µ–≥—Ä—É–∂–∞–µ—Ç—Å—è** - rate limiting –Ω–∞ –≤—Å–µ—Ö —É—Ä–æ–≤–Ω—è—Ö
4. **–í—ã—Å–æ–∫–∞—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å** - batch –æ–ø–µ—Ä–∞—Ü–∏–∏ –∏ pooling
5. **–ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç—å** - graceful degradation

### üöÄ –ì–û–¢–û–í–û –ö –ü–†–û–î–ê–ö–®–ù–£:
- –í—Å–µ –∫–ª–∞—Å—Å—ã –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω—ã
- –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –≤—ã–Ω–µ—Å–µ–Ω–∞ –≤ –æ—Ç–¥–µ–ª—å–Ω—ã–µ —Ñ–∞–π–ª—ã
- –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–æ
- –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –≤—Å—Ç—Ä–æ–µ–Ω
- –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∞

## üìù –ò–ù–°–¢–†–£–ö–¶–ò–ò –ü–û –ü–†–ò–ú–ï–ù–ï–ù–ò–Æ

### 1. –ê–∫—Ç–∏–≤–∞—Ü–∏—è –≤ production:
```python
# –í settings/prod.py –¥–æ–±–∞–≤–∏—Ç—å:
CELERY_TASK_ROUTES = {
    'hikvision_integration.tasks.*': {'queue': 'hikvision_safe'},
}

# Rate limits –º–æ–∂–Ω–æ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å –≤ config.py
HIKCENTRAL_RATE_LIMIT_CALLS = 5  # –ë–æ–ª–µ–µ –∫–æ–Ω—Å–µ—Ä–≤–∞—Ç–∏–≤–Ω–æ –≤ –ø—Ä–æ–¥–∞–∫—à–Ω–µ
```

### 2. –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥:
```bash
# –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –º–µ—Ç—Ä–∏–∫
tail -f logs/hikvision_metrics.log

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è Celery
celery -A visitor_system inspect active
```

### 3. –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –ø—Ä–æ–±–ª–µ–º:
```python
# –í Django shell
from hikvision_integration.safety_utils import check_system_resources
check_system_resources()
```

## üéä –ò–¢–û–ì
**–°–∏—Å—Ç–µ–º–∞ –ø–æ–ª–Ω–æ—Å—Ç—å—é –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–∞ –∏ –≥–æ—Ç–æ–≤–∞ –∫ –±–µ–∑–æ–ø–∞—Å–Ω–æ–π —ç–∫—Å–ø–ª—É–∞—Ç–∞—Ü–∏–∏ –≤ –ø—Ä–æ–¥–∞–∫—à–Ω–µ!**

–í—Å–µ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–æ–±–ª–µ–º—ã —Ä–µ—à–µ–Ω—ã:
- ‚ùå –ö—Ä–∞—Ö —Å–µ—Ä–≤–µ—Ä–∞ ‚Üí ‚úÖ –°—Ç–∞–±–∏–ª—å–Ω–∞—è —Ä–∞–±–æ—Ç–∞
- ‚ùå –ü–µ—Ä–µ–≥—Ä—É–∑–∫–∞ API ‚Üí ‚úÖ Rate limiting
- ‚ùå –ù–µ–∫–æ–Ω—Ç—Ä–æ–ª–∏—Ä—É–µ–º–æ–µ –ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏–µ —Ä–µ—Å—É—Ä—Å–æ–≤ ‚Üí ‚úÖ –ñ–µ—Å—Ç–∫–∏–µ –ª–∏–º–∏—Ç—ã
- ‚ùå –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ ‚Üí ‚úÖ –ü–æ–ª–Ω–∞—è observability

**–ì–æ—Ç–æ–≤–æ –∫ –¥–µ–ø–ª–æ—é! üöÄ**