#!/bin/sh
# ?????????????????????? /bin/sh ?????? ?????????????? ?????????????????????????? ?? ???????????????? ???????????????? Alpine

set -e # ???????????????? ????????????????????, ???????? ?????????????? ?????????????????????? ?? ??????????????

# ???????????????? ???? ??????????????????, ?????????? ???????? ???????????????????????????? ?????????????????????? ??????????????????
DB_HOST="${POSTGRES_HOST:-db}"
DB_PORT="${POSTGRES_PORT:-5432}"
DB_USER="${POSTGRES_USER:-visitor_system_user}" # ???????????????????? ???????? ???? ????????????????????????, ?????? ?? ?? settings_docker.py
DB_NAME="${POSTGRES_DB:-visitor_system_db}"
DB_PASSWORD="${POSTGRES_PASSWORD:-Sako2020}"

echo "???????????????? ?????????????????????? ???????? ???????????? ???? ?????????? $DB_HOST ?? ?????????? $DB_PORT..."

# ???????? ???? ?????? ??????, ???????? pg_isready ???? ???????????? 0 (??????????)
# ?????????????? ?????????? ?????????????????????????? ???????????????????? ??????????????
attempts=0
max_attempts=60 # ????????????????, 60 ?????????????? ?? ?????????????????? 1 ?????????????? = 1 ????????????
until pg_isready -h "$DB_HOST" -p "$DB_PORT" -d "$DB_NAME" -U "$DB_USER" -q || [ "$attempts" -eq 10 ]; do
  attempts=$((attempts+1))
  if [ "$attempts" -gt "$max_attempts" ]; then
    echo "?????????????? ?????????????????????? ?? ???????? ???????????? ?????????? $max_attempts ??????????????."
    exit 1
  fi
  echo "???????? ???????????? ???????????????????? - ???????????????? 1 ?????????????? (?????????????? $attempts/$max_attempts)"
  sleep 1
done

echo "???????? ???????????? ????????????????."

# ????????????????, ?????? DJANGO_SETTINGS_MODULE ???????????????????? (???????? ?????????? ?????? ???????????? ?? docker-compose.yml)
export DJANGO_SETTINGS_MODULE=${DJANGO_SETTINGS_MODULE:-visitor_system.settings_docker}
echo "???????????????????????? ?????????????????? Django: $DJANGO_SETTINGS_MODULE"

echo "???????????????????? ???????????????? ???????? ????????????..."
poetry run python manage.py migrate --noinput

echo "???????????????? ??????????????????."

# ???????????? ???????????????? ?????????????? ???????????????????? (????????????????, Gunicorn), ???????????????????? ?????????? CMD
echo "???????????? ??????????????: $@"
exec "$@"
