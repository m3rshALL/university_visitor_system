{% extends 'base.html' %}
{% load widget_tweaks %}
{% block content %}
<div class="page-wrapper">
    <div class="page-header d-print-none">
        <div class="container-xl">
            <div class="row g-2 align-items-center">
                <div class="col">
                    <div class="page-pretitle">
                        Система управления посетителями
                    </div>
                    <h2 class="page-title">
                        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-users" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                            <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
                            <circle cx="9" cy="7" r="4"/>
                            <path d="M3 21v-2a4 4 0 0 1 4 -4h4a4 4 0 0 1 4 4v2"/>
                            <path d="M16 3.13a4 4 0 0 1 0 7.75"/>
                            <path d="M21 21v-2a4 4 0 0 0 -3 -3.85"/>
                        </svg>
                        Заполнение данных гостей
                    </h2>
                </div>
            </div>
        </div>
    </div>
    
    <div class="page-body">
        <div class="container-xl">
            <div class="row justify-content-center">                
                <div class="col-12 col-lg-10">
                                        
                    <!-- Информация о визите -->
                    <div class="card mb-4">
                        <div class="card-status-top bg-blue"></div>
                        <div class="card-header">
                            <h3 class="card-title">
                                <svg xmlns="http://www.w3.org/2000/svg" class="icon me-2" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                                    <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
                                    <circle cx="12" cy="12" r="9"/>
                                    <line x1="12" y1="8" x2="12.01" y2="8"/>
                                    <polyline points="11,12 12,12 12,16 13,16"/>
                                </svg>
                                Информация о визите
                            </h3>
                        </div>
                        <div class="card-body">
                            <div class="row g-3">
                                <div class="col-md-4">
                                    <div class="d-flex align-items-center">
                                        <span class="avatar avatar-sm bg-blue text-white me-3">
                                            <svg xmlns="http://www.w3.org/2000/svg" class="icon" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                                                <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
                                                <circle cx="12" cy="7" r="4"/>
                                                <path d="M6 21v-2a4 4 0 0 1 4 -4h4a4 4 0 0 1 4 4v2"/>
                                            </svg>
                                        </span>
                                        <div>
                                            <div class="font-weight-medium">Пригласивший</div>
                                            <div class="text-muted">{{ group_invitation.employee.get_full_name|default:group_invitation.employee.username }}</div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="d-flex align-items-center">
                                        <span class="avatar avatar-sm bg-green text-white me-3">
                                            <svg xmlns="http://www.w3.org/2000/svg" class="icon" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                                                <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
                                                <path d="M9 12l2 2l4 -4"/>
                                                <circle cx="12" cy="12" r="9"/>
                                            </svg>
                                        </span>
                                        <div>
                                            <div class="font-weight-medium">Статус</div>
                                            <div class="text-muted">
                                                {% if group_invitation.status %}
                                                    <span class="badge bg-success-lt">{{ group_invitation.get_status_display }}</span>
                                                {% else %}
                                                    <span class="badge bg-warning-lt">Ожидает заполнения</span>
                                                {% endif %}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="d-flex align-items-center">
                                        <span class="avatar avatar-sm bg-purple text-white me-3">
                                            <svg xmlns="http://www.w3.org/2000/svg" class="icon" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                                                <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
                                                <rect x="4" y="5" width="16" height="16" rx="2"/>
                                                <line x1="16" y1="3" x2="16" y2="7"/>
                                                <line x1="8" y1="3" x2="8" y2="7"/>
                                                <line x1="4" y1="11" x2="20" y2="11"/>
                                            </svg>
                                        </span>
                                        <div class="d-flex flex-column justify-content-center">
                                            <div class="font-weight-medium">Создано</div>
                                            <div class="text-muted">
                                                {% if group_invitation.created_at %}
                                                    {{ group_invitation.created_at|date:"d.m.Y H:i" }}
                                                {% else %}
                                                    <span class="badge bg-secondary">Неизвестно</span>
                                                {% endif %}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>                    
                    </div>
                    
                    <!-- Основная форма для заполнения данных гостей и деталей визита -->
                    <form method="post" id="group-form" enctype="multipart/form-data">
                        {% csrf_token %}
                        {{ formset.management_form }}
                        
                        <!-- Редактирование деталей визита -->
                        <div class="card mb-4 border border-purple">
                            <div class="card-status-top bg-purple"></div>
                            <div class="card-header bg-purple-lt">
                                <h3 class="card-title">
                                    <svg  xmlns="http://www.w3.org/2000/svg"  width="24"  height="24"  viewBox="0 0 24 24"  fill="none"  stroke="currentColor"  stroke-width="2"  stroke-linecap="round"  stroke-linejoin="round"  class="icon icon-tabler icons-tabler-outline icon-tabler-progress-alert"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M10 20.777a8.942 8.942 0 0 1 -2.48 -.969" /><path d="M14 3.223a9.003 9.003 0 0 1 0 17.554" /><path d="M4.579 17.093a8.961 8.961 0 0 1 -1.227 -2.592" /><path d="M3.124 10.5c.16 -.95 .468 -1.85 .9 -2.675l.169 -.305" /><path d="M6.907 4.579a8.954 8.954 0 0 1 3.093 -1.356" /><path d="M12 8v4" /><path d="M12 16v.01" /></svg>
                                    Введите детали визита (обязательно)
                                </h3>
                            </div>
                            <div class="card-body">
                                <div class="alert alert-info mb-3">
                                    <div class="d-flex align-items-center">
                                        <div>
                                            <svg xmlns="http://www.w3.org/2000/svg" class="icon alert-icon me-2" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                                                <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
                                                <circle cx="12" cy="12" r="9"></circle>
                                                <line x1="12" y1="8" x2="12.01" y2="8"></line>
                                                <polyline points="11,12 12,12 12,16 13,16"></polyline>
                                            </svg>
                                        </div>
                                        <div>Пожалуйста, заполните время визита и его цель. Без этих данных форма не будет отправлена.</div>
                                    </div>
                                </div>
                                <div class="row g-3 mb-3">
                                    <div class="col-md-6">
                                        <label class="form-label required">Время прибытия</label>
                                        <input type="datetime-local" name="visit_time" class="form-control" value="{% if group_invitation.visit_time %}{{ group_invitation.visit_time|date:'Y-m-d'}}T{{ group_invitation.visit_time|time:'H:i' }}{% endif %}" required />
                                        <small class="form-hint">Укажите дату и время ожидаемого прибытия группы</small>
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label required">Цель визита</label>
                                        <textarea name="purpose" class="form-control" rows="3" required>{{ group_invitation.purpose }}</textarea>
                                        <small class="form-hint">Опишите цель посещения учреждения</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Форма добавления гостей -->
                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="icon me-2" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                                        <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
                                        <circle cx="9" cy="7" r="4"/>
                                        <path d="M3 21v-2a4 4 0 0 1 4 -4h4a4 4 0 0 1 4 4v2"/>
                                        <path d="M16 11h6m-3 -3v6"/>
                                    </svg>
                                    Добавление гостей
                                </h3>
                                <div class="card-actions">
                                    <span class="badge bg-blue-lt ms-auto" id="guest-counter">Гостей: 1</span>
                                </div>
                            </div>                        
                            <div class="card-body">
                                <!-- Контейнер для гостей -->
                                <div id="guests-formset">
                                    <!-- Первая форма гостя -->
                                    <div class="card border mb-3 guest-form-row">
                                        <div class="card-status-start bg-blue"></div>
                                        <div class="card-header">
                                            <h4 class="card-title">Гость #1</h4>
                                            <div class="card-actions">
                                                <button type="button" class="btn btn-outline-danger btn-sm remove-guest-btn" title="Удалить гостя" style="display: none;">
                                                    <svg xmlns="http://www.w3.org/2000/svg" class="icon" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                                                        <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
                                                        <path d="M4 7l16 0"/>
                                                        <path d="M10 11v6"/>
                                                        <path d="M14 11v6"/>
                                                        <path d="M5 7l1 12a2 2 0 0 0 2 2h8a2 2 0 0 0 2 -2l1 -12"/>
                                                        <path d="M9 7v-3a1 1 0 0 1 1 -1h4a1 1 0 0 1 1 1v3"/>
                                                    </svg>
                                                    Удалить
                                                </button>
                                            </div>
                                        </div>
                                        <div class="card-body">
                                            <div class="row g-3 mb-3">
                                                <div class="col-md-6">
                                                    <label class="form-label required">ФИО</label>
                                                    {% if formset.0.full_name %}
                                                        {{ formset.0.full_name|add_class:'form-control'|attr:'placeholder:Иванов Иван Иванович'}}
                                                    {% else %}
                                                        <input type="text" name="form-0-full_name" class="form-control" maxlength="255" required />
                                                    {% endif %}
                                                    <small class="form-hint">Полное имя гостя</small>
                                                </div>
                                                <div class="col-md-6">
                                                    <label class="form-label required">Email</label>
                                                    {% if formset.0.email %}
                                                        {{ formset.0.email|add_class:'form-control' |attr:'placeholder:example@mail.ru' }}
                                                    {% else %}
                                                        <input type="email" name="form-0-email" class="form-control" maxlength="255" required />
                                                    {% endif %}
                                                    <small class="form-hint">Электронная почта для уведомлений</small>
                                                </div>
                                            </div>
                                            <div class="row g-3 mb-3">
                                                <div class="col-md-6">
                                                    <label class="form-label">Телефон</label>
                                                    {% if formset.0.phone_number %}
                                                        {{ formset.0.phone_number|add_class:'form-control'|attr:'placeholder:+7 (___) ___-__-__'|attr:'maxlength:20' }}
                                                    {% else %}
                                                        <input type="text" name="form-0-phone_number" class="form-control" maxlength="20" placeholder="+7 (___) ___-__-__" />
                                                    {% endif %}
                                                    <small class="form-hint">Контактный номер телефона</small>
                                                </div>
                                                <div class="col-md-6">
                                                    <label class="form-label required">ИИН</label>
                                                    {% if formset.0.iin %}
                                                        {{ formset.0.iin|add_class:'form-control'|attr:'placeholder:000000000000'|attr:'maxlength:12' }}
                                                    {% else %}
                                                        <input type="text" name="form-0-iin" class="form-control" maxlength="12" placeholder="000000000000" required />
                                                    {% endif %}
                                                    <small class="form-hint">12-значный ИИН</small>
                                                </div>
                                            </div>
                                            <div class="row g-3">
                                                <div class="col-md-8">
                                                    <label class="form-label">Фото гостя</label>
                                                    {% if formset.0.photo %}
                                                        <div class="input-group">
                                                            {{ formset.0.photo|add_class:'form-control' }}
                                                        </div>
                                                    {% else %}
                                                        <input type="file" name="form-0-photo" class="form-control" accept="image/*" />
                                                    {% endif %}
                                                    <small class="form-hint">Загрузите фотографию 3x4 для пропуска (JPG, PNG)</small>
                                                </div>
                                                {% if formset.0.photo.value %}
                                                <div class="col-md-4">
                                                    <label class="form-label">Текущее фото</label>
                                                    <div class="avatar avatar-xl">
                                                        <img src="{{ formset.0.photo.value.url }}" alt="Фото гостя" class="rounded">
                                                    </div>
                                                </div>
                                                {% endif %}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Кнопка добавления гостя -->
                                <div class="mb-4">
                                    <button type="button" class="btn btn-outline-primary btn-pill" id="add-guest-btn">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="icon me-2" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                                            <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
                                            <circle cx="9" cy="7" r="4"/>
                                            <path d="M3 21v-2a4 4 0 0 1 4 -4h4a4 4 0 0 1 4 4v2"/>
                                            <path d="M16 11h6m-3 -3v6"/>
                                        </svg>
                                        Добавить ещё гостя
                                    </button>
                                    <small class="text-muted ms-2">Максимум 10 гостей</small>
                                </div>
                                
                                <!-- Кнопки действий -->
                                <div class="d-flex gap-2">
                                    <button type="submit" class="btn btn-success">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="icon me-2" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                                            <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
                                            <path d="M5 12l5 5l10 -10"/>
                                        </svg>
                                        Сохранить гостей
                                    </button>
                                    <button type="button" class="btn btn-outline-secondary" onclick="history.back()">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="icon me-2" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                                            <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
                                            <path d="M9 14l-4 -4l4 -4"/>
                                            <path d="M5 10h11a4 4 0 1 1 0 8h-1"/>
                                        </svg>
                                        Отмена
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Переменные для управления формой
let guestCounter = 1;
const maxGuests = 10;
const totalFormsInput = document.getElementById('id_form-TOTAL_FORMS');
const addBtn = document.getElementById('add-guest-btn');
const formsetDiv = document.getElementById('guests-formset');
const counterBadge = document.getElementById('guest-counter');

// Функция обновления счетчика гостей
function updateGuestCounter() {
    const currentCount = document.querySelectorAll('.guest-form-row').length;
    counterBadge.textContent = `Гостей: ${currentCount}`;
    
    // Обновляем номера гостей в заголовках
    document.querySelectorAll('.guest-form-row').forEach((row, index) => {
        const title = row.querySelector('.card-title');
        if (title) {
            title.textContent = `Гость #${index + 1}`;
        }
    });
    
    // Показываем/скрываем кнопку добавления
    if (currentCount >= maxGuests) {
        addBtn.style.display = 'none';
    } else {
        addBtn.style.display = 'inline-flex';
    }
}

// Функция для добавления нового гостя
function addNewGuest() {
    const currentCount = document.querySelectorAll('.guest-form-row').length;
    if (currentCount >= maxGuests) return;
    
    const formCount = currentCount;
    const colors = ['blue', 'green', 'purple', 'orange', 'yellow', 'red', 'pink', 'indigo', 'teal', 'cyan'];
    const color = colors[formCount % colors.length];
    
    const newGuestHtml = `
    <div class="card border mb-3 guest-form-row">
        <div class="card-status-start bg-${color}"></div>
        <div class="card-header">
            <h4 class="card-title">Гость #${formCount + 1}</h4>
            <div class="card-actions">
                <button type="button" class="btn btn-outline-danger btn-sm remove-guest-btn" title="Удалить гостя">
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                        <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
                        <path d="M4 7l16 0"/>
                        <path d="M10 11v6"/>
                        <path d="M14 11v6"/>
                        <path d="M5 7l1 12a2 2 0 0 0 2 2h8a2 2 0 0 0 2 -2l1 -12"/>
                        <path d="M9 7v-3a1 1 0 0 1 1 -1h4a1 1 0 0 1 1 1v3"/>
                    </svg>
                    Удалить
                </button>
            </div>
        </div>
        <div class="card-body">
            <div class="row g-3 mb-3">
                <div class="col-md-6">
                    <label class="form-label required">ФИО</label>
                    <input type="text" name="form-${formCount}-full_name" class="form-control" maxlength="255" required />
                    <small class="form-hint">Полное имя гостя</small>
                </div>
                <div class="col-md-6">
                    <label class="form-label required">Email</label>
                    <input type="email" name="form-${formCount}-email" class="form-control" maxlength="255" required />
                    <small class="form-hint">Электронная почта для уведомлений</small>
                </div>
            </div>
            <div class="row g-3 mb-3">
                <div class="col-md-6">
                    <label class="form-label">Телефон</label>
                    <input type="text" name="form-${formCount}-phone_number" class="form-control" maxlength="20" placeholder="+7 (___) ___-__-__" />
                    <small class="form-hint">Контактный номер телефона</small>
                </div>
                <div class="col-md-6">
                    <label class="form-label required">ИИН</label>
                    <input type="text" name="form-${formCount}-iin" class="form-control" maxlength="12" placeholder="000000000000" required />
                    <small class="form-hint">12-значный ИИН</small>
                </div>
            </div>
            <div class="row g-3">
                <div class="col-md-12">
                    <label class="form-label">Фото гостя</label>
                    <input type="file" name="form-${formCount}-photo" class="form-control" accept="image/*" />
                    <small class="form-hint">Загрузите фотографию 3x4 для пропуска (JPG, PNG)</small>
                </div>
            </div>
        </div>
    </div>`;
    
    formsetDiv.insertAdjacentHTML('beforeend', newGuestHtml);
    
    // Обновляем общее количество форм
    totalFormsInput.value = parseInt(totalFormsInput.value) + 1;
    
    updateGuestCounter();
    updateRemoveButtons();
    
    // Показываем уведомление
    showToast(`Добавлен гость #${formCount + 1}`, 'success');
    
    // Прокручиваем к новой форме
    const newCard = formsetDiv.lastElementChild;
    newCard.scrollIntoView({ behavior: 'smooth', block: 'center' });
}

// Функция для удаления гостя
function removeGuest(button) {
    const guestRow = button.closest('.guest-form-row');
    const currentCount = document.querySelectorAll('.guest-form-row').length;
    
    if (currentCount <= 1) {
        showToast('Должен остаться хотя бы один гость', 'warning');
        return;
    }
    
    // Анимация удаления
    guestRow.style.transition = 'opacity 0.3s ease';
    guestRow.style.opacity = '0';
    
    setTimeout(() => {
        guestRow.remove();
        totalFormsInput.value = parseInt(totalFormsInput.value) - 1;
        updateGuestCounter();
        updateRemoveButtons();
        showToast('Гость удален', 'info');
    }, 300);
}

// Функция обновления кнопок удаления
function updateRemoveButtons() {
    const removeButtons = document.querySelectorAll('.remove-guest-btn');
    const guestCount = document.querySelectorAll('.guest-form-row').length;
    
    removeButtons.forEach(btn => {
        if (guestCount <= 1) {
            btn.style.display = 'none';
        } else {
            btn.style.display = 'inline-flex';
        }
        
        // Переназначаем обработчик событий
        btn.onclick = function() {
            removeGuest(this);
        };
    });
}

// Функция показа уведомлений
function showToast(message, type = 'info') {
    const colors = {
        success: 'bg-success',
        warning: 'bg-warning',
        error: 'bg-danger',
        info: 'bg-primary'
    };
    
    let toastContainer = document.getElementById('toast-container');
    if (!toastContainer) {
        toastContainer = document.createElement('div');
        toastContainer.id = 'toast-container';
        toastContainer.className = 'toast-container position-fixed bottom-0 end-0 p-3';
        document.body.appendChild(toastContainer);
    }
    
    const toast = document.createElement('div');
    toast.className = `toast align-items-center text-white ${colors[type]} border-0`;
    toast.setAttribute('role', 'alert');
    toast.setAttribute('aria-live', 'assertive');
    toast.setAttribute('aria-atomic', 'true');
    
    toast.innerHTML = `
        <div class="d-flex">
            <div class="toast-body">
                <svg xmlns="http://www.w3.org/2000/svg" class="icon me-2" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                    <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
                    <circle cx="12" cy="12" r="9"/>
                    <line x1="12" y1="8" x2="12.01" y2="8"/>
                    <polyline points="11,12 12,12 12,16 13,16"/>
                </svg>
                ${message}
            </div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
    `;
    
    toastContainer.appendChild(toast);
    const bsToast = new bootstrap.Toast(toast, { delay: 3000 });
    bsToast.show();
    
    toast.addEventListener('hidden.bs.toast', function() {
        toast.remove();
    });
}

// Валидация ИИН
function validateIIN(input) {
    const iin = input.value.replace(/\D/g, '');
    if (iin.length > 12) {
        input.value = iin.substring(0, 12);
    } else {
        input.value = iin;
    }
    
    if (iin.length === 12) {
        input.classList.remove('is-invalid');
        input.classList.add('is-valid');
    } else {
        input.classList.remove('is-valid');
        if (iin.length > 0) {
            input.classList.add('is-invalid');
        }
    }
}

// Форматирование телефона
function formatPhone(input) {
    let phone = input.value.replace(/\D/g, '');
    
    // Конвертируем 8 в 7
    if (phone.startsWith('8')) {
        phone = '7' + phone.substring(1);
    }
    
    // Если номер не начинается с 7 и есть цифры, добавляем 7
    if (phone.length > 0 && !phone.startsWith('7')) {
        phone = '7' + phone;
    }
    
    // Ограничиваем до 11 цифр
    if (phone.length > 11) {
        phone = phone.substring(0, 11);
    }
    
    // Форматируем номер
    let formatted = '';
    if (phone.length > 0) {
        formatted = '+7';
        if (phone.length > 1) {
            formatted += ' (' + phone.substring(1, 4);
            if (phone.length > 4) {
                formatted += ') ' + phone.substring(4, 7);
                if (phone.length > 7) {
                    formatted += '-' + phone.substring(7, 9);
                    if (phone.length > 9) {
                        formatted += '-' + phone.substring(9, 11);
                    }
                }
            }
        }
    }
    
    input.value = formatted;
    
    // Валидация для визуального отображения
    input.classList.remove('is-valid', 'is-invalid');
    
    if (phone.length === 0) {
        // Пустое поле - убираем все классы валидации
        return;
    } else if (phone.length === 11 && phone.startsWith('7')) {
        // Полный корректный номер - показываем зеленый
        input.classList.add('is-valid');
    } else if (phone.length > 0) {
        // Частично заполненный или некорректный номер - не показываем валидацию
        // Не добавляем is-invalid, чтобы не показывать красный до завершения ввода
    }
}

// Инициализация при загрузке страницы
document.addEventListener('DOMContentLoaded', function() {
    // Добавляем обработчик для кнопки добавления гостя
    addBtn.addEventListener('click', addNewGuest);
    
    // Обновляем начальное состояние
    updateGuestCounter();
    updateRemoveButtons();
    
    // Добавляем валидацию для существующих полей
    document.addEventListener('input', function(e) {
        if (e.target.name && e.target.name.includes('-iin')) {
            validateIIN(e.target);
        }
        if (e.target.name && e.target.name.includes('-phone_number')) {
            formatPhone(e.target);
        }
    });
    
    // Валидация формы перед отправкой
    const form = document.getElementById('group-form');
    form.addEventListener('submit', function(e) {
        const guestForms = document.querySelectorAll('.guest-form-row');
        let hasErrors = false;
          guestForms.forEach((guestForm, index) => {
            const fullName = guestForm.querySelector(`[name="form-${index}-full_name"]`);
            const email = guestForm.querySelector(`[name="form-${index}-email"]`);
            const iin = guestForm.querySelector(`[name="form-${index}-iin"]`);
            const phone = guestForm.querySelector(`[name="form-${index}-phone_number"]`);
            
            // Проверяем обязательные поля (телефон не обязательный)
            [fullName, email, iin].forEach(field => {
                if (field && !field.value.trim()) {
                    field.classList.add('is-invalid');
                    hasErrors = true;
                } else if (field) {
                    field.classList.remove('is-invalid');
                }
            });
            
            // Проверяем ИИН (должен быть 12 цифр)
            if (iin && iin.value.replace(/\D/g, '').length !== 12 && iin.value.trim() !== '') {
                iin.classList.add('is-invalid');
                hasErrors = true;
            }
            
            // Проверяем телефон (если заполнен, должен быть корректным)
            if (phone && phone.value.trim() !== '') {
                const phoneDigits = phone.value.replace(/\D/g, '');
                if (phoneDigits.length !== 11 || !phoneDigits.startsWith('7')) {
                    phone.classList.add('is-invalid');
                    hasErrors = true;
                } else {
                    phone.classList.remove('is-invalid');
                }
            }
        });
        
        if (hasErrors) {
            e.preventDefault();
            showToast('Пожалуйста, заполните все обязательные поля корректно', 'error');
            
            // Прокручиваем к первому полю с ошибкой
            const firstError = form.querySelector('.is-invalid');
            if (firstError) {
                firstError.scrollIntoView({ behavior: 'smooth', block: 'center' });
                firstError.focus();
            }
        }
    });
});
</script>
{% endblock %}