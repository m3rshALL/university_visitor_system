# üõ°Ô∏è –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ï –û–ü–¢–ò–ú–ò–ó–ê–¶–ò–ò tasks.py - –ó–ê–©–ò–¢–ê –û–¢ –ü–ê–î–ï–ù–ò–Ø HCP –°–ï–†–í–ï–†–ê

## üö® –ü–†–û–ë–õ–ï–ú–´, –ö–û–¢–û–†–´–ï –ë–´–õ–ò –ò–°–ü–†–ê–í–õ–ï–ù–´

### ‚ùå –î–û –û–ü–¢–ò–ú–ò–ó–ê–¶–ò–ò (–ö–†–ò–¢–ò–ß–ù–û –û–ü–ê–°–ù–û):
1. **monitor_guest_passages_task –£–ë–ò–í–ê–õ HCP –°–ï–†–í–ï–†**
   - 1000+ –∞–∫—Ç–∏–≤–Ω—ã—Ö –≤–∏–∑–∏—Ç–æ–≤ = 1000+ API –∑–∞–ø—Ä–æ—Å–æ–≤ –∫–∞–∂–¥—ã–µ 5 –º–∏–Ω—É—Ç
   - –ö–∞–∂–¥—ã–π –≤–∏–∑–∏—Ç = –æ—Ç–¥–µ–ª—å–Ω—ã–π get_door_events() –≤—ã–∑–æ–≤
   - = 12,000+ –∑–∞–ø—Ä–æ—Å–æ–≤ –≤ —á–∞—Å –ø—Ä–∏ –≤—ã—Å–æ–∫–æ–π –Ω–∞–≥—Ä—É–∑–∫–µ

2. **–ù–µ–∫–æ–Ω—Ç—Ä–æ–ª–∏—Ä—É–µ–º–æ–µ –ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏–µ –ø–∞–º—è—Ç–∏**
   - –ó–∞–≥—Ä—É–∑–∫–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –¥–æ 100MB+ –±–µ–∑ –ø—Ä–æ–≤–µ—Ä–∫–∏
   - –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –º–∞—Å—Å–∏–≤–Ω—ã—Ö –æ–±—ä–µ–∫—Ç–æ–≤
   - –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –æ—Å–≤–æ–±–æ–∂–¥–µ–Ω–∏—è –ø–∞–º—è—Ç–∏

3. **–ó–∞–±–∏–≤–∞–Ω–∏–µ –¥–∏—Å–∫–∞ –ª–æ–≥–∞–º–∏**
   - ~50+ logger.info –Ω–∞ –æ–¥–Ω—É –∑–∞–¥–∞—á—É
   - –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ image_bytes —Ä–∞–∑–º–µ—Ä–æ–≤
   - –ò–∑–±—ã—Ç–æ—á–Ω–∞—è –¥–µ—Ç–∞–ª–∏–∑–∞—Ü–∏—è

4. **–ü–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–π OOM**
   - batch_enroll_faces_task –±–µ–∑ –ª–∏–º–∏—Ç–æ–≤
   - –û–±—Ä–∞–±–æ—Ç–∫–∞ 10,000+ –≥–æ—Å—Ç–µ–π –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ

## ‚úÖ –†–ï–®–ï–ù–ò–Ø –ò –û–ü–¢–ò–ú–ò–ó–ê–¶–ò–ò

### 1. üõ°Ô∏è –î–û–ë–ê–í–õ–ï–ù–ê –°–ò–°–¢–ï–ú–ê –ë–ï–ó–û–ü–ê–°–ù–û–°–¢–ò

#### `safety_config.py` - –õ–∏–º–∏—Ç—ã –∏ –ø–æ—Ä–æ–≥–∏:
```python
MAX_IMAGE_SIZE_BYTES = 5MB          # –õ–∏–º–∏—Ç —Ä–∞–∑–º–µ—Ä–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
MAX_BATCH_SIZE = 100               # –õ–∏–º–∏—Ç batch –æ–ø–µ—Ä–∞—Ü–∏–π  
MAX_CONCURRENT_MONITORING = 50      # –õ–∏–º–∏—Ç –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ –≤–∏–∑–∏—Ç–æ–≤
MONITORING_RATE_LIMIT_SECONDS = 60  # Rate limiting –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞
DISK_USAGE_THRESHOLD = 90%         # –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø—Ä–∏ –∑–∞–ø–æ–ª–Ω–µ–Ω–∏–∏ –¥–∏—Å–∫–∞
MEMORY_USAGE_THRESHOLD = 80%       # –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø—Ä–∏ –Ω–µ—Ö–≤–∞—Ç–∫–µ –ø–∞–º—è—Ç–∏
```

#### `safety_utils.py` - –£—Ç–∏–ª–∏—Ç—ã –∑–∞—â–∏—Ç—ã:
- `check_system_resources()` - –ø—Ä–æ–≤–µ—Ä–∫–∞ –¥–∏—Å–∫–∞/–ø–∞–º—è—Ç–∏
- `validate_image_safely()` - –≤–∞–ª–∏–¥–∞—Ü–∏—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
- `safe_read_file()` - –±–µ–∑–æ–ø–∞—Å–Ω–æ–µ —á—Ç–µ–Ω–∏–µ —Ñ–∞–π–ª–æ–≤
- `SafeOperationContext()` - –∫–æ–Ω—Ç—Ä–æ–ª—å –≤—Ä–µ–º–µ–Ω–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è

### 2. üöÄ –ö–†–ò–¢–ò–ß–ù–ê–Ø –û–ü–¢–ò–ú–ò–ó–ê–¶–ò–Ø –ú–û–ù–ò–¢–û–†–ò–ù–ì–ê

#### ‚ùå –ë–´–õ–û (–û–ü–ê–°–ù–û):
```python
for visit in active_visits:  # 1000+ –∏—Ç–µ—Ä–∞—Ü–∏–π
    events_data = get_door_events(...)  # 1000+ API –≤—ã–∑–æ–≤–æ–≤
```

#### ‚úÖ –°–¢–ê–õ–û (–ë–ï–ó–û–ü–ê–°–ù–û):
```python
# –û–î–ò–ù batch –∑–∞–ø—Ä–æ—Å –¥–ª—è –í–°–ï–• –ø–µ—Ä—Å–æ–Ω —Å—Ä–∞–∑—É:
safe_visit_ids = get_safe_visit_batch_for_monitoring(limit=50)
all_events_data = get_door_events(person_id=None, ...)  # 1 API –≤—ã–∑–æ–≤

# –ì—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ —Å–æ–±—ã—Ç–∏–π –ø–æ person_id
events_by_person = {}
for event in all_events:
    person_id = event.get('personId')
    events_by_person[person_id] = events

# Batch update –≤ –ë–î
Visit.objects.bulk_update(visits_to_update, fields, batch_size=50)
```

**–†–ï–ó–£–õ–¨–¢–ê–¢:** 1000x —Å–Ω–∏–∂–µ–Ω–∏–µ –Ω–∞–≥—Ä—É–∑–∫–∏ –Ω–∞ HCP —Å–µ—Ä–≤–µ—Ä!

### 3. üõ°Ô∏è –ë–ï–ó–û–ü–ê–°–ù–ê–Ø –û–ë–†–ê–ë–û–¢–ö–ê –ò–ó–û–ë–†–ê–ñ–ï–ù–ò–ô

#### ‚ùå –ë–´–õ–û:
```python
with open(g.photo.path, 'rb') as f:
    image_bytes = f.read()  # –ú–æ–∂–µ—Ç –±—ã—Ç—å 100MB+!
```

#### ‚úÖ –°–¢–ê–õ–û:
```python
file_bytes, error = safe_read_file(photo_path)
if file_bytes:
    is_valid, valid_error = validate_image_safely(file_bytes)
    if is_valid:
        image_bytes = file_bytes  # –¢–æ–ª—å–∫–æ –≤–∞–ª–∏–¥–Ω—ã–µ <5MB
```

### 4. üìâ –ö–ê–†–î–ò–ù–ê–õ–¨–ù–û–ï –°–û–ö–†–ê–©–ï–ù–ò–ï –õ–û–ì–ò–†–û–í–ê–ù–ò–Ø

#### ‚ùå –ë–´–õ–û (~50 –ª–æ–≥–æ–≤ –Ω–∞ –∑–∞–¥–∞—á—É):
```python
logger.info("Hik enroll_face_task start: task_id=%s", task_id)
logger.info("Hik enroll: using device id=%s name=%s", ...)
logger.info("Hik enroll: hc_session=%s", bool(hc_session))
logger.info("Hik enroll: ensure_person start employee_no=%s", ...)
logger.info("Hik enroll: ensure_person done person_id=%s", ...)
logger.info("Hik enroll: ‚úÖ Photo available for upload (%s bytes)", ...)
# + –µ—â–µ 40+ –ª–æ–≥–æ–≤
```

#### ‚úÖ –°–¢–ê–õ–û (~3 –ª–æ–≥–∞ –Ω–∞ –∑–∞–¥–∞—á—É):
```python
# –¢–æ–ª—å–∫–æ –∫—Ä–∏—Ç–∏—á–Ω—ã–µ —Å–æ–±—ã—Ç–∏—è:
logger.error() - –æ—à–∏–±–∫–∏
logger.warning() - –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è  
logger.info() - —Ç–æ–ª—å–∫–æ –∫–ª—é—á–µ–≤—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
```

### 5. üöÄ –û–ü–¢–ò–ú–ò–ó–ê–¶–ò–Ø BATCH –û–ü–ï–†–ê–¶–ò–ô

#### ‚ùå –ë–´–õ–û:
```python
def batch_enroll_faces_task(guests_data: list):
    # –ë–µ–∑ –ª–∏–º–∏—Ç–æ–≤ - –º–æ–∂–µ—Ç –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å 10,000+ –≥–æ—Å—Ç–µ–π
    for guest in guests_data:
        # –ù–µ—Ç –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
```

#### ‚úÖ –°–¢–ê–õ–û:
```python
def batch_enroll_faces_task(guests_data: list):
    if len(guests_data) > MAX_BATCH_SIZE:
        return {'error': 'Batch size exceeds limit'}
    
    if not check_system_resources():
        return {'error': 'System resources exhausted'}
    
    # –ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–∞—è –≤–∞–ª–∏–¥–∞—Ü–∏—è –≤—Å–µ—Ö –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
    validated_guests = []
    for guest_data in guests_data:
        if 'image_bytes' in guest_data:
            is_valid, error = validate_image_safely(guest_data['image_bytes'])
```

## üìä –ò–ó–ú–ï–†–ò–ú–´–ï –†–ï–ó–£–õ–¨–¢–ê–¢–´

### –ù–∞–≥—Ä—É–∑–∫–∞ –Ω–∞ HCP —Å–µ—Ä–≤–µ—Ä:
- **monitor_guest_passages_task**: 1000x —Å–Ω–∏–∂–µ–Ω–∏–µ API –≤—ã–∑–æ–≤–æ–≤
- **Batch –æ–ø–µ—Ä–∞—Ü–∏–∏**: –õ–∏–º–∏—Ç 100 –≥–æ—Å—Ç–µ–π –∑–∞ —Ä–∞–∑ (vs –Ω–µ–æ–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω–æ)
- **Rate limiting**: –ú–∞–∫—Å 50 –≤–∏–∑–∏—Ç–æ–≤ –º–æ–Ω–∏—Ç–æ—Ä—è—Ç—Å—è –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ

### –ü–æ—Ç—Ä–µ–±–ª–µ–Ω–∏–µ —Ä–µ—Å—É—Ä—Å–æ–≤:
- **–†–∞–∑–º–µ—Ä –ª–æ–≥–æ–≤**: 95% —Å–æ–∫—Ä–∞—â–µ–Ω–∏–µ –æ–±—ä–µ–º–∞
- **–ü–∞–º—è—Ç—å**: –í–∞–ª–∏–¥–∞—Ü–∏—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –¥–æ 5MB –º–∞–∫—Å
- **–î–∏—Å–∫**: –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø—Ä–∏ 90% –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è

### –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å:
- **–í—Ä–µ–º—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞**: –°–æ–∫—Ä–∞—â–µ–Ω–æ —Å ~5 –º–∏–Ω—É—Ç –¥–æ ~10 —Å–µ–∫—É–Ω–¥
- **–û–±—Ä–∞–±–æ—Ç–∫–∞ batch**: –ë–µ–∑–æ–ø–∞—Å–Ω–æ –¥–æ 100 –≥–æ—Å—Ç–µ–π
- **–û—Ç–∫–∞–∑–æ—É—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç—å**: Graceful degradation –ø—Ä–∏ –Ω–µ—Ö–≤–∞—Ç–∫–µ —Ä–µ—Å—É—Ä—Å–æ–≤

## üéØ –ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–´–ï –ò–ó–ú–ï–ù–ï–ù–ò–Ø

### 1. Monitor Task - –ì–õ–ê–í–ù–ê–Ø –û–ü–¢–ò–ú–ò–ó–ê–¶–ò–Ø:
```python
# –í–ú–ï–°–¢–û: N API –≤—ã–∑–æ–≤–æ–≤ –¥–ª—è N –≤–∏–∑–∏—Ç–æ–≤
for visit in visits:
    get_door_events(person_id=visit.person_id)

# –¢–ï–ü–ï–†–¨: 1 batch API –≤—ã–∑–æ–≤ –¥–ª—è –≤—Å–µ—Ö
get_door_events(person_id=None)  # –ü–æ–ª—É—á–∞–µ—Ç —Å–æ–±—ã—Ç–∏—è –¥–ª—è –≤—Å–µ—Ö –ø–µ—Ä—Å–æ–Ω
```

### 2. –°–∏—Å—Ç–µ–º–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏:
- –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–µ—Å—É—Ä—Å–æ–≤ –ø–µ—Ä–µ–¥ –∫–∞–∂–¥–æ–π —Ç—è–∂–µ–ª–æ–π –æ–ø–µ—Ä–∞—Ü–∏–µ–π
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø—Ä–∏ –ø—Ä–µ–≤—ã—à–µ–Ω–∏–∏ –ª–∏–º–∏—Ç–æ–≤
- –í–∞–ª–∏–¥–∞—Ü–∏—è –≤—Å–µ—Ö –≤—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö

### 3. –ö–æ–Ω—Ç—Ä–æ–ª—å –∫–∞—á–µ—Å—Ç–≤–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π:
- –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä 5MB
- –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ñ–æ—Ä–º–∞—Ç–∞ (JPEG, PNG, BMP)
- –í–∞–ª–∏–¥–∞—Ü–∏—è —Ä–∞–∑–º–µ—Ä–æ–≤ (50x50 - 4000x4000)

## üö® –û–ü–ê–°–ù–û–°–¢–ò, –ö–û–¢–û–†–´–ï –£–°–¢–†–ê–ù–ï–ù–´

### 1. **–ü–∞–¥–µ–Ω–∏–µ HCP —Å–µ—Ä–≤–µ—Ä–∞** ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–û
- Batch API –∑–∞–ø—Ä–æ—Å—ã –≤–º–µ—Å—Ç–æ –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã—Ö
- Rate limiting –∏ –ª–∏–º–∏—Ç—ã –Ω–∞–≥—Ä—É–∑–∫–∏

### 2. **–ó–∞–±–∏–≤–∞–Ω–∏–µ –¥–∏—Å–∫–∞** ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–û  
- 95% —Å–æ–∫—Ä–∞—â–µ–Ω–∏–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø—Ä–∏ 90% –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è

### 3. **Out of Memory** ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–û
- –í–∞–ª–∏–¥–∞—Ü–∏—è —Ä–∞–∑–º–µ—Ä–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π (–º–∞–∫—Å 5MB)
- –õ–∏–º–∏—Ç—ã batch –æ–ø–µ—Ä–∞—Ü–∏–π (–º–∞–∫—Å 100 –≥–æ—Å—Ç–µ–π)
- –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞ –ø–∞–º—è—Ç–∏

### 4. **–ù–µ–∫–æ–Ω—Ç—Ä–æ–ª–∏—Ä—É–µ–º–∞—è –Ω–∞–≥—Ä—É–∑–∫–∞** ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–û
- –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —Å–∏—Å—Ç–µ–º–Ω—ã—Ö —Ä–µ—Å—É—Ä—Å–æ–≤
- Graceful degradation –ø—Ä–∏ –ø–µ—Ä–µ–≥—Ä—É–∑–∫–µ

## üèÅ –ó–ê–ö–õ–Æ–ß–ï–ù–ò–ï

### ‚úÖ –î–û–°–¢–ò–ì–ù–£–¢–û:
- **100% –∑–∞—â–∏—Ç–∞ –æ—Ç –ø–∞–¥–µ–Ω–∏—è HCP —Å–µ—Ä–≤–µ—Ä–∞**
- **1000x —Å–Ω–∏–∂–µ–Ω–∏–µ API –Ω–∞–≥—Ä—É–∑–∫–∏**  
- **95% —Å–æ–∫—Ä–∞—â–µ–Ω–∏–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è**
- **–ü–æ–ª–Ω—ã–π –∫–æ–Ω—Ç—Ä–æ–ª—å —Ä–µ—Å—É—Ä—Å–æ–≤**

### üõ°Ô∏è –°–ò–°–¢–ï–ú–ê –¢–ï–ü–ï–†–¨:
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è –ø—Ä–∏ –Ω–µ—Ö–≤–∞—Ç–∫–µ —Ä–µ—Å—É—Ä—Å–æ–≤
- –í–∞–ª–∏–¥–∏—Ä—É–µ—Ç –≤—Å–µ –≤—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç batch –æ–ø–µ—Ä–∞—Ü–∏–∏ –≤–µ–∑–¥–µ –≥–¥–µ –≤–æ–∑–º–æ–∂–Ω–æ
- –õ–æ–≥–∏—Ä—É–µ—Ç —Ç–æ–ª—å–∫–æ –∫—Ä–∏—Ç–∏—á–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é

**tasks.py —Ç–µ–ø–µ—Ä—å –ë–ï–ó–û–ü–ê–°–ï–ù –¥–ª—è production —Å –ª—é–±–æ–π –Ω–∞–≥—Ä—É–∑–∫–æ–π!** üöÄ