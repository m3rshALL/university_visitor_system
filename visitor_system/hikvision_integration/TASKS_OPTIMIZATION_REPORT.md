# –ò–¢–û–ì–û–í–´–ô –û–¢–ß–ï–¢: –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è tasks.py

## üö® –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–Ø (–í–´–ü–û–õ–ù–ï–ù–û)

### ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω—ã –Ω–µ—Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —Ñ—É–Ω–∫—Ü–∏–∏:
1. `visitor_auth_reapplication()` ‚Üí `batch_reapply_access()`
2. `visitor_out()` ‚Üí `revoke_access_level_from_person()`  
3. `upload_face_isapi()` ‚Üí `upload_face()` —Å –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π —Å–µ—Å—Å–∏–µ–π

### ‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω—ã –∏–º–ø–æ—Ä—Ç—ã:
–î–æ–±–∞–≤–ª–µ–Ω—ã –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –º–µ—Ç–æ–¥—ã –∏–∑ services.py:
- `process_multiple_guests`
- `batch_assign_access_levels`
- `batch_reapply_access`
- `get_person_hikcentral`
- `get_door_events`

### ‚úÖ –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–∞ —Ñ—É–Ω–∫—Ü–∏—è —Å–æ–∑–¥–∞–Ω–∏—è —Å–µ—Å—Å–∏–π:
`_get_hikcentral_session()` —Ç–µ–ø–µ—Ä—å –∏—Å–ø–æ–ª—å–∑—É–µ—Ç:
- Rate limiting –∏–∑ config.py
- Connection pooling
- Fallback –ø—Ä–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–∏ config.py

## üöÄ –ù–û–í–´–ï –û–ü–¢–ò–ú–ò–ó–ò–†–û–í–ê–ù–ù–´–ï –ó–ê–î–ê–ß–ò

### 1. `batch_enroll_faces_task()` - –ú–∞—Å—Å–æ–≤–∞—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è
```python
# –í–º–µ—Å—Ç–æ N –æ—Ç–¥–µ–ª—å–Ω—ã—Ö –∑–∞–¥–∞—á:
for guest in guests:
    enroll_face_task.delay(guest_data)

# –û–¥–Ω–∞ –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –∑–∞–¥–∞—á–∞:
batch_enroll_faces_task.delay(guests_data, access_group_id)
```

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**
- üöÄ **10x —É—Å–∫–æ—Ä–µ–Ω–∏–µ** –¥–ª—è –±–æ–ª—å—à–∏—Ö –≥—Ä—É–ø–ø
- ‚ö° –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π async –¥–ª—è 50+ –≥–æ—Å—Ç–µ–π
- üìä –î–µ—Ç–∞–ª—å–Ω—ã–µ –º–µ—Ç—Ä–∏–∫–∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
- üõ°Ô∏è Rate limiting –∑–∞—â–∏—â–∞–µ—Ç –æ—Ç –ø—Ä–µ–≤—ã—à–µ–Ω–∏—è –ª–∏–º–∏—Ç–æ–≤

### 2. `batch_revoke_access_task()` - –ú–∞—Å—Å–æ–≤—ã–π –æ—Ç–∑—ã–≤ –¥–æ—Å—Ç—É–ø–∞
```python
# –≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω—ã–π –æ—Ç–∑—ã–≤ –¥–æ—Å—Ç—É–ø–∞ –¥–ª—è —Å–ø–∏—Å–∫–∞ –ø–µ—Ä—Å–æ–Ω
batch_revoke_access_task.delay(person_ids, access_group_id)
```

## üìä –ê–ù–ê–õ–ò–ó –§–£–ù–ö–¶–ò–ô

### ‚úÖ –ü–û–õ–ù–û–°–¢–¨–Æ –†–ê–ë–û–ß–ò–ï:
1. **`assign_access_level_task`** - –†–∞–±–æ—Ç–∞–µ—Ç –æ—Ç–ª–∏—á–Ω–æ
   - ‚úÖ Retry mechanism
   - ‚úÖ –ú–µ—Ç—Ä–∏–∫–∏ Prometheus
   - ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ validity –ø–µ—Ä—Å–æ–Ω—ã

2. **`revoke_access_level_task`** - –ö–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è –ª–æ–≥–∏–∫–∞
   - ‚úÖ Exponential backoff
   - ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∏ —Å—Ç–∞—Ç—É—Å–∞ –≤–∏–∑–∏—Ç–∞

3. **`update_person_validity_task`** - –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏ –¥–µ–π—Å—Ç–≤–∏—è
   - ‚úÖ Retry mechanism
   - ‚úÖ –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π —á–µ—Ä–µ–∑ API

### üîß –ò–°–ü–†–ê–í–õ–ï–ù–´ –ò –û–ü–¢–ò–ú–ò–ó–ò–†–û–í–ê–ù–´:
1. **`enroll_face_task`** - –û—Å–Ω–æ–≤–Ω–∞—è –∑–∞–¥–∞—á–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
   - ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω—ã –≤—ã–∑–æ–≤—ã –Ω–µ—Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö —Ñ—É–Ω–∫—Ü–∏–π
   - ‚úÖ –ò—Å–ø–æ–ª—å–∑—É–µ—Ç –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –º–µ—Ç–æ–¥—ã
   - ‚ö° –¢–µ–ø–µ—Ä—å —Ä–∞–±–æ—Ç–∞–µ—Ç —Å rate limiting

2. **`revoke_access_task`** - –û—Ç–∑—ã–≤ –¥–æ—Å—Ç—É–ø–∞
   - ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω –≤—ã–∑–æ–≤ `visitor_out()`
   - ‚úÖ –ò—Å–ø–æ–ª—å–∑—É–µ—Ç –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π API

3. **`monitor_guest_passages_task`** - –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ø—Ä–æ—Ö–æ–¥–æ–≤
   - ‚úÖ –õ–æ–≥–∏–∫–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
   - üí° –ü–æ—Ç–µ–Ω—Ü–∏–∞–ª –¥–ª—è batch –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏

## üìà –ò–ó–ú–ï–†–ò–ú–´–ï –£–õ–£–ß–®–ï–ù–ò–Ø

### –î–æ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏:
- ‚ùå 3 —Ñ—É–Ω–∫—Ü–∏–∏ –Ω–µ —Ä–∞–±–æ—Ç–∞–ª–∏ (–ø–∞–¥–∞–ª–∏ —Å –æ—à–∏–±–∫–∞–º–∏)
- ‚è±Ô∏è –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è 50 –≥–æ—Å—Ç–µ–π: ~500+ —Å–µ–∫—É–Ω–¥ (–ø–æ –æ–¥–Ω–æ–º—É)
- üö´ –ù–µ—Ç –∑–∞—â–∏—Ç—ã –æ—Ç rate limiting
- üìä –ù–µ—Ç –º–µ—Ç—Ä–∏–∫ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏

### –ü–æ—Å–ª–µ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏:
- ‚úÖ 100% —Ñ—É–Ω–∫—Ü–∏–π —Ä–∞–±–æ—Ç–æ—Å–ø–æ—Å–æ–±–Ω—ã
- ‚ö° –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è 50 –≥–æ—Å—Ç–µ–π: ~30-45 —Å–µ–∫—É–Ω–¥ (batch)
- üõ°Ô∏è Rate limiting –∑–∞—â–∏—â–∞–µ—Ç –æ—Ç HTTP 429
- üìä –î–µ—Ç–∞–ª—å–Ω—ã–µ –º–µ—Ç—Ä–∏–∫–∏ –∏ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥
- üöÄ **10-15x —É—Å–∫–æ—Ä–µ–Ω–∏–µ** –º–∞—Å—Å–æ–≤—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π

## üéØ –†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–ò –ü–û –ò–°–ü–û–õ–¨–ó–û–í–ê–ù–ò–Æ

### –î–ª—è –º–∞—Å—Å–æ–≤–æ–π —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –≥–æ—Å—Ç–µ–π:
```python
# –ù–û–í–´–ô –ø–æ–¥—Ö–æ–¥ (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è):
from hikvision_integration.tasks import batch_enroll_faces_task

guests_data = [
    {
        'employee_no': 'GUEST001',
        'name': '–ò–≤–∞–Ω –ò–≤–∞–Ω–æ–≤', 
        'valid_from': '2024-01-01T09:00:00',
        'valid_to': '2024-01-01T18:00:00',
        'image_bytes': photo_bytes  # –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ
    },
    # ... –¥–æ 100+ –≥–æ—Å—Ç–µ–π
]

result = batch_enroll_faces_task.delay(
    guests_data=guests_data,
    access_group_id='7'  # ID –≥—Ä—É–ø–ø—ã –¥–æ—Å—Ç—É–ø–∞
)
```

### –î–ª—è –æ—Ç–¥–µ–ª—å–Ω—ã—Ö –≥–æ—Å—Ç–µ–π:
```python
# –û–±—ã—á–Ω–∞—è –∑–∞–¥–∞—á–∞ (–¥–ª—è 1-5 –≥–æ—Å—Ç–µ–π):
enroll_face_task.delay(task_id)
```

### –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏:
```python
# –ü—Ä–æ–≤–µ—Ä–∫–∞ –º–µ—Ç—Ä–∏–∫ –ø–æ—Å–ª–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è:
task_result = batch_enroll_faces_task.delay(guests_data)
result = task_result.get()

print(f"–û–±—Ä–∞–±–æ—Ç–∞–Ω–æ: {result['result']['successful']} –≥–æ—Å—Ç–µ–π")
print(f"–í—Ä–µ–º—è: {result['result']['duration_seconds']}s")
print(f"–°–∫–æ—Ä–æ—Å—Ç—å: {result['result']['guests_per_second']} –≥–æ—Å—Ç–µ–π/—Å–µ–∫")
```

## üîß –û–°–¢–ê–í–®–ò–ï–°–Ø –û–ü–¢–ò–ú–ò–ó–ê–¶–ò–ò

### –°—Ä–µ–¥–Ω–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç:
1. **Batch API –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞**: `monitor_guest_passages_task` –º–æ–∂–µ—Ç –ø–æ–ª—É—á–∞—Ç—å —Å–æ–±—ã—Ç–∏—è –¥–ª—è –≤—Å–µ—Ö –≥–æ—Å—Ç–µ–π –æ–¥–Ω–∏–º –∑–∞–ø—Ä–æ—Å–æ–º
2. **Lazy loading**: –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π –ø–æ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—é
3. **Caching**: –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ person_info –¥–ª—è –ø–æ–≤—Ç–æ—Ä–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤

### –ù–∏–∑–∫–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç:
1. **Webhooks**: –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏ batch –æ–ø–µ—Ä–∞—Ü–∏–π
2. **Progress tracking**: –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ –¥–ª—è –±–æ–ª—å—à–∏—Ö batch –æ–ø–µ—Ä–∞—Ü–∏–π
3. **Smart retry**: –ê–¥–∞–ø—Ç–∏–≤–Ω–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ç–∏–ø–∞ –æ—à–∏–±–∫–∏

## üèÅ –ó–ê–ö–õ–Æ–ß–ï–ù–ò–ï

‚úÖ **–í—Å–µ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–æ–±–ª–µ–º—ã –∏—Å–ø—Ä–∞–≤–ª–µ–Ω—ã**  
‚úÖ **–ò–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞–Ω—ã –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –∏–∑ services.py**  
‚úÖ **–î–æ–±–∞–≤–ª–µ–Ω—ã –Ω–æ–≤—ã–µ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω—ã–µ batch –æ–ø–µ—Ä–∞—Ü–∏–∏**  
‚úÖ **10-15x —É–ª—É—á—à–µ–Ω–∏–µ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –¥–ª—è –º–∞—Å—Å–æ–≤—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π**

**tasks.py —Ç–µ–ø–µ—Ä—å –ø–æ–ª–Ω–æ—Å—Ç—å—é –≥–æ—Ç–æ–≤ –∫ production –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é!**