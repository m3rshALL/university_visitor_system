# ‚úÖ –§–ò–ù–ê–õ–¨–ù–´–ô –û–¢–í–ï–¢: –ê–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–æ—Ç–æ

## –í–æ–ø—Ä–æ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
"–ï—Å–ª–∏ —è —Å–æ–∑–¥–∞–º –Ω–æ–≤—ã–π –≥–æ—Å—Ç—å –ø–æ –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏—é —Ç–µ–ø–µ—Ä—å –≤—Å–µ –∑–∞—Ä–∞–±–æ—Ç–∞–µ—Ç? –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è —É–∂–µ –µ—Å—Ç—å?"

## –û—Ç–≤–µ—Ç: ‚ö†Ô∏è **–ü–û–ß–¢–ò** –≥–æ—Ç–æ–≤–æ, –Ω—É–∂–Ω–∞ 1 –ø—Ä–∞–≤–∫–∞

### ‚úÖ –ß—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç:
1. **–†–∞–±–æ—á–∏–π –º–µ—Ç–æ–¥ –Ω–∞–π–¥–µ–Ω** (#16 –∏–∑ 16 –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö!)
   - Endpoint: `POST /artemis/api/resource/v1/person/face/update`
   - Parameters: `personId + faceData` (base64)
   - Image optimization: 500x500, JPEG quality 80
   - –†–µ–∑—É–ª—å—Ç–∞—Ç: `picUri` —É—Å–ø–µ—à–Ω–æ –∑–∞–ø–æ–ª–Ω—è–µ—Ç—Å—è!

2. **–§—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∞**: `upload_face_hikcentral()` –≤ `hikvision_integration/services.py` (—Å—Ç—Ä–æ–∫–∏ 1045-1129)
   - –ò—Å–ø–æ–ª—å–∑—É–µ—Ç —Ä–∞–±–æ—á–∏–π –º–µ—Ç–æ–¥
   - –û–ø—Ç–∏–º–∏–∑–∏—Ä—É–µ—Ç –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –¥–æ 500x500
   - –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ: ‚úÖ **–†–ê–ë–û–¢–ê–ï–¢!**

3. **Task integration –≥–æ—Ç–æ–≤–∞**: `enroll_face_task()` –≤ `hikvision_integration/tasks.py`
   - –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –ø–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è Visit (views.py:175, 2242)
   - Fallback —Ü–µ–ø–æ—á–∫–∞: multipart ‚Üí `upload_face_hikcentral()` (–Ω–∞—à–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è)
   - –ü–æ—Ç–æ–∫: `upload_face_hikcentral_multipart` –ø—Ä–æ–≤–∞–ª–∏—Ç—Å—è ‚Üí fallback –∫ —Ä–∞–±–æ—á–µ–º—É –º–µ—Ç–æ–¥—É

### ‚ö†Ô∏è –ü—Ä–æ–±–ª–µ–º–∞: Guest –º–æ–¥–µ–ª—å –Ω–µ –∏–º–µ–µ—Ç –ø–æ–ª—è `photo`!

**–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π –±–∞–≥ –≤ –∫–æ–¥–µ:**
- `finalize_guest_invitation()` (views.py:2159) –ø—ã—Ç–∞–µ—Ç—Å—è –ø—Ä–∏—Å–≤–æ–∏—Ç—å:
  ```python
  guest.photo = invitation.guest_photo  # ‚ùå Guest.photo –ù–ï –°–£–©–ï–°–¢–í–£–ï–¢!
  ```
- `enroll_face_task()` (tasks.py:81-86) –ø—ã—Ç–∞–µ—Ç—Å—è –ø—Ä–æ—á–∏—Ç–∞—Ç—å:
  ```python
  if g and getattr(g, 'photo', None):  # ‚úÖ –ë–µ–∑–æ–ø–∞—Å–Ω–æ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç getattr
      with open(g.photo.path, 'rb') as f:
  ```

**–¢–µ–∫—É—â–∞—è —Å–∏—Ç—É–∞—Ü–∏—è:**
- `Guest` –º–æ–¥–µ–ª—å –∏–º–µ–µ—Ç —Ç–æ–ª—å–∫–æ: `full_name`, `email`, `phone_number`, `iin_encrypted`, `iin_hash`
- `GuestInvitation` –∏–º–µ–µ—Ç: `guest_photo` ‚úÖ
- –ü—Ä–∏ —Ñ–∏–Ω–∞–ª–∏–∑–∞—Ü–∏–∏ –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏—è —Ñ–æ—Ç–æ **–ù–ï –°–û–•–†–ê–ù–Ø–ï–¢–°–Ø** –≤ Guest

### üîß –†–µ—à–µ–Ω–∏–µ: –î–æ–±–∞–≤–∏—Ç—å –ø–æ–ª–µ photo –≤ Guest –º–æ–¥–µ–ª—å

```python
# visitor_system/visitors/models.py, class Guest
photo = models.ImageField(upload_to='guest_photos/', blank=True, null=True, verbose_name="–§–æ—Ç–æ –≥–æ—Å—Ç—è")
```

–ó–∞—Ç–µ–º:
```bash
python manage.py makemigrations
python manage.py migrate
```

### –ü–æ—Å–ª–µ —ç—Ç–æ–≥–æ –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è –±—É–¥–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å –¢–ê–ö:

1. **–°–æ–∑–¥–∞–Ω–∏–µ –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏—è**:
   - –°–æ—Ç—Ä—É–¥–Ω–∏–∫ —Å–æ–∑–¥–∞–µ—Ç `GuestInvitation`
   - –ó–∞–≥—Ä—É–∂–∞–µ—Ç `guest_photo`

2. **–ì–æ—Å—Ç—å –∑–∞–ø–æ–ª–Ω—è–µ—Ç –¥–∞–Ω–Ω—ã–µ**:
   - –ü–µ—Ä–µ—Ö–æ–¥–∏—Ç –ø–æ —Å—Å—ã–ª–∫–µ
   - –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ

3. **–§–∏–Ω–∞–ª–∏–∑–∞—Ü–∏—è (Reception)**:
   - `finalize_guest_invitation()` –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è
   - –°–æ–∑–¥–∞–µ—Ç—Å—è/–æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è `Guest` **—Å —Ñ–æ—Ç–æ**
   - –°–æ–∑–¥–∞–µ—Ç—Å—è `Visit`
   - –ó–∞–ø—É—Å–∫–∞–µ—Ç—Å—è `enroll_face_task()`

4. **Celery task**:
   - –ß–∏—Ç–∞–µ—Ç `guest.photo.path`
   - –í—ã–∑—ã–≤–∞–µ—Ç `upload_face_hikcentral_multipart()`
   - Multipart –ø—Ä–æ–≤–∞–ª–∏—Ç—Å—è (–∫–æ–¥=8)
   - **Fallback –∫ `upload_face_hikcentral()`** ‚Üê –†–ê–ë–û–ß–ò–ô –ú–ï–¢–û–î!
   - –û–ø—Ç–∏–º–∏–∑–∏—Ä—É–µ—Ç —Ñ–æ—Ç–æ –¥–æ 500x500
   - POST `/person/face/update` —Å `personId + faceData`
   - ‚úÖ –§–æ—Ç–æ –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è –≤ HikCentral!

### üìä –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∏–∑–æ–ª–∏—Ä–æ–≤–∞–Ω–Ω–æ–π —Ñ—É–Ω–∫—Ü–∏–∏

**test_working_method_final.py** - –†–µ–∑—É–ª—å—Ç–∞—Ç:
```
‚úÖ Upload SUCCESS!
picUri: '0123e0eba444314f8dc6d7dfa8025d92fb0a23d7dba889ba1cdfc858e52e65167'
üéâ SUCCESS! PHOTO UPLOADED AND SAVED!

Function upload_face_hikcentral() returned: face_8505
Final picUri: '0123e0eba444314f8dc6d7dfa8025d92fb0a23d7dba889ba1cdfc858e52e65167'
‚úÖ‚úÖ‚úÖ –ú–ï–¢–û–î –ü–û–õ–ù–û–°–¢–¨–Æ –†–ê–ë–û–¢–ê–ï–¢!
```

### üìù –ü–ª–∞–Ω –¥–µ–π—Å—Ç–≤–∏–π:

1. **–î–æ–±–∞–≤–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é –¥–ª—è Guest.photo** (5 –º–∏–Ω—É—Ç)
2. –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å —Å–æ–∑–¥–∞–Ω–∏–µ –≥–æ—Å—Ç—è —á–µ—Ä–µ–∑ –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏–µ (5 –º–∏–Ω—É—Ç)
3. ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è –ø–æ–ª–Ω–æ—Å—Ç—å—é —Ä–∞–±–æ—Ç–∞–µ—Ç!

### üí° –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ (–±–µ–∑ –º–∏–≥—Ä–∞—Ü–∏–∏):

–ï—Å–ª–∏ –Ω–µ —Ö–æ—Ç–∏—Ç–µ –º–µ–Ω—è—Ç—å –º–æ–¥–µ–ª—å Guest, –º–æ–∂–Ω–æ:
1. –°–æ—Ö—Ä–∞–Ω—è—Ç—å `photo` —Ç–æ–ª—å–∫–æ –≤ `GuestInvitation`
2. –í `enroll_face_task()` —á–∏—Ç–∞—Ç—å —Ñ–æ—Ç–æ –∏–∑ –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏—è:
   ```python
   invitation = GuestInvitation.objects.filter(visit_id=task.visit_id).first()
   if invitation and invitation.guest_photo:
       with open(invitation.guest_photo.path, 'rb') as f:
           image_bytes = f.read()
   ```

–ù–æ **–ø–µ—Ä–≤—ã–π –≤–∞—Ä–∏–∞–Ω—Ç (Guest.photo) —á–∏—â–µ –∏ –ª–æ–≥–∏—á–Ω–µ–µ**, —Ç.–∫.:
- Guest –º–æ–∂–µ—Ç –∏–º–µ—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ –≤–∏–∑–∏—Ç–æ–≤
- –§–æ—Ç–æ –¥–æ–ª–∂–Ω–æ —Ö—Ä–∞–Ω–∏—Ç—å—Å—è –≤ –ø—Ä–æ—Ñ–∏–ª–µ –≥–æ—Å—Ç—è, –∞ –Ω–µ –≤ –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏–∏

## –ò—Ç–æ–≥–æ–≤—ã–π –æ—Ç–≤–µ—Ç:

**üü° –ê–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è –ü–û–ß–¢–ò –≥–æ—Ç–æ–≤–∞!**
- ‚úÖ –†–∞–±–æ—á–∏–π –º–µ—Ç–æ–¥ –Ω–∞–π–¥–µ–Ω –∏ —Ä–∞–±–æ—Ç–∞–µ—Ç
- ‚úÖ –§—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∞
- ‚úÖ Task integration –≥–æ—Ç–æ–≤–∞
- ‚ö†Ô∏è –ù—É–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –ø–æ–ª–µ `photo` –≤ –º–æ–¥–µ–ª—å `Guest` (1 –º–∏–≥—Ä–∞—Ü–∏—è)
- ‚úÖ –ü–æ—Å–ª–µ –º–∏–≥—Ä–∞—Ü–∏–∏ - –≤—Å–µ –∑–∞—Ä–∞–±–æ—Ç–∞–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏!

---

**–°–æ–∑–¥–∞–Ω–æ:** 2025-01-10  
**–ú–µ—Ç–æ–¥–æ–≤ –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–æ:** 16  
**–†–∞–±–æ—á–∏–π –º–µ—Ç–æ–¥:** #16 - `/person/face/update` + 500x500 optimization
