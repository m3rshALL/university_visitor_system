{% extends "base.html" %}
{% load static %}

{% block title %}{{ page_title }} - Система визитов{% endblock %}

{% block extra_css %}
<link href='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.css' rel='stylesheet' />
<style>
    /* Переопределяем стили FullCalendar для Tabler UI */
    .fc {
        font-family: inherit;
    }
    
    .fc-theme-standard .fc-event {
        border-radius: 6px;
        border: none;
        font-weight: 500;
        padding: 2px 6px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.12), 0 1px 2px rgba(0,0,0,0.24);
        transition: all 0.2s ease;
    }
    
    .fc-theme-standard .fc-event:hover {
        transform: translateY(-1px);
        box-shadow: 0 3px 6px rgba(0,0,0,0.15), 0 2px 4px rgba(0,0,0,0.12);
    }
    
    .fc-toolbar {
        margin-bottom: 1.5rem !important;
    }
    
    .fc-toolbar-title {
        font-size: 1.5rem !important;
        font-weight: 600 !important;
        color: var(--tblr-primary);
    }
    
    .fc-button-group .fc-button {
        background: var(--tblr-primary);
        border-color: var(--tblr-primary);
        border-radius: 6px;
    }
    
    .fc-button-group .fc-button:hover {
        background: var(--tblr-primary-dark);
        border-color: var(--tblr-primary-dark);
    }
    
    .fc-today-button {
        background: var(--tblr-success) !important;
        border-color: var(--tblr-success) !important;
    }
    
    .fc-daygrid-day.fc-day-today {
        background-color: rgba(var(--tblr-primary-rgb), 0.05) !important;
    }
    
    /* Кастомные цвета для типов событий */
    .event-visit { background-color: #1976d2 !important; }
    .event-student { background-color: #2e7d32 !important; }
    .event-group { background-color: #7b1fa2 !important; }
    .event-booking { background-color: #f57c00 !important; }
    
    /* Улучшенное модальное окно */
    .modal {
        position: fixed;
        top: 0;
        left: 0;
        z-index: 1055;
        width: 100%;
        height: 100%;
        overflow-x: hidden;
        overflow-y: auto;
        background-color: rgba(0, 0, 0, 0.5);
        backdrop-filter: blur(4px);
    }
    
    .modal.show {
        display: block !important;
    }
    
    .modal-backdrop {
        position: fixed;
        top: 0;
        left: 0;
        z-index: 1040;
        width: 100vw;
        height: 100vh;
        background-color: #000;
        opacity: 0.5;
    }
    
    .modal-backdrop.fade {
        opacity: 0;
    }
    
    .modal-backdrop.show {
        opacity: 0.5;
    }
    
    .modal-open {
        overflow: hidden;
    }
    
    .event-details-modal {
        display: none;
        position: fixed;
        z-index: 1055;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0,0,0,0.5);
        backdrop-filter: blur(4px);
    }
    
    .modal-content {
        background: white;
        margin: 5% auto;
        border-radius: 12px;
        width: 90%;
        max-width: 600px;
        position: relative;
        box-shadow: 0 10px 25px rgba(0,0,0,0.2);
        animation: modalSlideIn 0.3s ease;
    }
    
    @keyframes modalSlideIn {
        from { opacity: 0; transform: translateY(-30px); }
        to { opacity: 1; transform: translateY(0); }
    }
    
    .modal-header {
        padding: 1.5rem;
        border-bottom: 1px solid var(--tblr-border-color);
        border-radius: 12px 12px 0 0;
    }
    
    .modal-body {
        padding: 1.5rem;
    }
    
    .modal-footer {
        padding: 1rem 1.5rem;
        border-top: 1px solid var(--tblr-border-color);
        border-radius: 0 0 12px 12px;
        background: var(--tblr-bg-surface-secondary);
    }
    
    .close {
        color: var(--tblr-muted);
        float: right;
        font-size: 24px;
        font-weight: bold;
        cursor: pointer;
        position: absolute;
        right: 20px;
        top: 20px;
        width: 32px;
        height: 32px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
        transition: all 0.2s ease;
    }
    
    .close:hover {
        color: var(--tblr-dark);
        background: var(--tblr-bg-surface);
    }
    
    .event-type-badge {
        display: inline-flex;
        align-items: center;
        padding: 4px 12px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: 600;
        color: white;
        margin-bottom: 16px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    
    .calendar-filters {
        background: white;
        border-radius: 12px;
        padding: 1.5rem;
        margin-bottom: 1.5rem;
        box-shadow: 0 1px 3px rgba(0,0,0,0.06);
        border: 1px solid var(--tblr-border-color);
    }
    
    .filter-title {
        font-size: 1.1rem;
        font-weight: 600;
        color: var(--tblr-dark);
        margin-bottom: 1rem;
        display: flex;
        align-items: center;
    }
    
    .filter-title svg {
        margin-right: 8px;
        color: var(--tblr-primary);
    }
    
    .calendar-container {
        background: white;
        border-radius: 12px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.06);
        border: 1px solid var(--tblr-border-color);
        overflow: hidden;
    }
    
    .calendar-header {
        background: linear-gradient(135deg, var(--tblr-primary) 0%, var(--tblr-primary-dark) 100%);
        color: white;
        padding: 1.5rem;
        text-align: center;
    }
    
    .calendar-header h1 {
        margin: 0;
        font-size: 1.75rem;
        font-weight: 600;
    }
    
    .calendar-header p {
        margin: 0.5rem 0 0 0;
        opacity: 0.9;
        font-size: 0.95rem;
    }
    
    .stats-row {
        background: var(--tblr-bg-surface-secondary);
        padding: 1rem 1.5rem;
        border-bottom: 1px solid var(--tblr-border-color);
    }
    
    .stat-item {
        text-align: center;
    }
    
    .stat-number {
        font-size: 1.5rem;
        font-weight: 700;
        color: var(--tblr-primary);
        margin: 0;
    }
    
    .stat-label {
        font-size: 0.875rem;
        color: var(--tblr-muted);
        margin: 0;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    
    .calendar-content {
        padding: 1.5rem;
    }
    
    /* Alpine.js cloak */
    [x-cloak] {
        display: none !important;
    }
</style>
{% endblock %}

{% block content %}
<div class="page-wrapper">
    <div class="page-header d-print-none">
        <div class="container-xl">
            <div class="row g-2 align-items-center">
                <div class="col">
                    <div class="page-pretitle">
                        Система управления визитами
                    </div>
                    <h2 class="page-title">
                        <svg xmlns="http://www.w3.org/2000/svg" class="icon me-2" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                            <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
                            <rect x="4" y="5" width="16" height="16" rx="2"/>
                            <line x1="16" y1="3" x2="16" y2="7"/>
                            <line x1="8" y1="3" x2="8" y2="7"/>
                            <rect x="8" y="11" width="2" height="2"/>
                            <rect x="12" y="11" width="2" height="2"/>
                            <rect x="16" y="11" width="2" height="2"/>
                            <rect x="8" y="15" width="2" height="2"/>
                            <rect x="12" y="15" width="2" height="2"/>
                        </svg>
                        {{ page_title }}
                    </h2>
                </div>
                {% comment %}
                    <div class="col-auto ms-auto d-print-none">
                        <div class="btn-list">
                            <a href="{% url 'employee_dashboard' %}" class="btn btn-outline-primary">
                                <svg xmlns="http://www.w3.org/2000/svg" class="icon me-1" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                                    <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
                                    <path d="M5 12l5 5l10 -10"/>
                                </svg>
                                Панель управления
                            </a>
                            <a href="#" class="btn btn-primary" onclick="window.print()">
                                <svg xmlns="http://www.w3.org/2000/svg" class="icon me-1" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                                    <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
                                    <path d="M17 17h2a2 2 0 0 0 2 -2v-4a2 2 0 0 0 -2 -2h-14a2 2 0 0 0 -2 2v4a2 2 0 0 0 2 2h2"/>
                                    <path d="M17 9v-4a2 2 0 0 0 -2 -2h-6a2 2 0 0 0 -2 2v4"/>
                                    <rect x="7" y="13" width="10" height="8" rx="2"/>
                                </svg>
                                Печать
                            </a>
                        </div>
                    </div>
                {% endcomment %}
            </div>
        </div>
    </div>
    
    <div class="page-body">
        <div class="container-xl" x-data="calendarApp()">
            <!-- Статистика -->
            <div class="row mb-4">
                <div class="col-sm-6 col-lg-3">
                    <div class="card">
                        <div class="card-body">
                            <div class="d-flex align-items-center">
                                <div class="subheader">Всего событий</div>
                                <div class="ms-auto">
                                    <div class="chart-sparkline chart-sparkline-sm" id="sparkline-activity"></div>
                                </div>
                            </div>
                            <div class="h1 mb-3" x-text="totalEvents">0</div>
                            <div class="d-flex mb-2">
                                <div>За текущий месяц</div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-sm-6 col-lg-3">
                    <div class="card">
                        <div class="card-body">
                            <div class="d-flex align-items-center">
                                <div class="subheader">Активные визиты</div>
                                <div class="ms-auto">
                                    <span class="badge bg-green"></span>
                                </div>
                            </div>
                            <div class="h1 mb-3" x-text="activeVisits">0</div>
                            <div class="d-flex mb-2">
                                <div>В здании сейчас</div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-sm-6 col-lg-3">
                    <div class="card">
                        <div class="card-body">
                            <div class="d-flex align-items-center">
                                <div class="subheader">Бронирования</div>
                                <div class="ms-auto">
                                    <span class="badge bg-yellow"></span>
                                </div>
                            </div>
                            <div class="h1 mb-3" x-text="bookingsCount">0</div>
                            <div class="d-flex mb-2">
                                <div>Аудиторий забронировано</div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-sm-6 col-lg-3">
                    <div class="card">
                        <div class="card-body">
                            <div class="d-flex align-items-center">
                                <div class="subheader">Сегодня</div>
                                <div class="ms-auto">
                                    <span class="badge bg-blue"></span>
                                </div>
                            </div>
                            <div class="h1 mb-3" x-text="todayEvents">0</div>
                            <div class="d-flex mb-2">
                                <div>Событий запланировано</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Фильтры -->
            <div class="card mb-4">
                <div class="card-header">
                    <h3 class="card-title">
                        <svg xmlns="http://www.w3.org/2000/svg" class="icon me-2" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                            <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
                            <path d="M5.5 5h13a1 1 0 0 1 .5 1.5l-5 5.5l0 7l-4 -3l0 -4l-5 -5.5a1 1 0 0 1 .5 -1.5"/>
                        </svg>
                        Фильтры событий
                    </h3>
                </div>
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-auto">
                            <label class="form-selectgroup-item">
                                <input type="radio" name="event-filter" value="all" class="form-selectgroup-input" 
                                       x-on:change="toggleFilter('all')" x-bind:checked="activeFilters.includes('all')">
                                <span class="form-selectgroup-label">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="icon me-1" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                                        <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
                                        <circle cx="12" cy="12" r="9"/>
                                        <path d="M12 3c7.2 0 9 1.8 9 9s-1.8 9 -9 9s-9 -1.8 -9 -9s1.8 -9 9 -9z"/>
                                    </svg>
                                    Все события
                                </span>
                            </label>
                        </div>
                        <div class="col-auto">
                            <label class="form-selectgroup-item">
                                <input type="checkbox" name="event-filter" value="visit" class="form-selectgroup-input"
                                       x-on:change="toggleFilter('visit')" x-bind:checked="activeFilters.includes('visit')">
                                <span class="form-selectgroup-label">
                                    <span class="badge bg-blue me-1"></span>
                                    Визиты
                                </span>
                            </label>
                        </div>
                        <div class="col-auto">
                            <label class="form-selectgroup-item">
                                <input type="checkbox" name="event-filter" value="student_visit" class="form-selectgroup-input"
                                       x-on:change="toggleFilter('student_visit')" x-bind:checked="activeFilters.includes('student_visit')">
                                <span class="form-selectgroup-label">
                                    <span class="badge bg-green me-1"></span>
                                    Студенты
                                </span>
                            </label>
                        </div>
                        <div class="col-auto">
                            <label class="form-selectgroup-item">
                                <input type="checkbox" name="event-filter" value="group_visit" class="form-selectgroup-input"
                                       x-on:change="toggleFilter('group_visit')" x-bind:checked="activeFilters.includes('group_visit')">
                                <span class="form-selectgroup-label">
                                    <span class="badge bg-purple me-1"></span>
                                    Группы
                                </span>
                            </label>
                        </div>
                        <div class="col-auto">
                            <label class="form-selectgroup-item">
                                <input type="checkbox" name="event-filter" value="classroom_booking" class="form-selectgroup-input"
                                       x-on:change="toggleFilter('classroom_booking')" x-bind:checked="activeFilters.includes('classroom_booking')">
                                <span class="form-selectgroup-label">
                                    <span class="badge bg-orange me-1"></span>
                                    Аудитории
                                </span>
                            </label>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Календарь -->
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">Календарь событий</h3>
                    <div class="card-actions">
                        <button class="btn btn-sm btn-outline-primary" x-on:click="refreshCalendar()">
                            <svg xmlns="http://www.w3.org/2000/svg" class="icon" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                                <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
                                <path d="M20 11a8.1 8.1 0 0 0 -15.5 -2m-.5 -4v4h4"/>
                                <path d="M4 13a8.1 8.1 0 0 0 15.5 2m.5 4v-4h-4"/>
                            </svg>
                            Обновить
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <div id="calendar"></div>
                </div>
            </div>

            <!-- Модальное окно для деталей события в стиле Tabler UI -->
            <div class="modal" id="eventModal" tabindex="-1" 
                 x-show="showModal" 
                 x-cloak
                 style="display: none;"
                 x-transition:enter="transition ease-out duration-300"
                 x-transition:enter-start="opacity-0 transform scale-95"
                 x-transition:enter-end="opacity-100 transform scale-100"
                 x-transition:leave="transition ease-in duration-200"
                 x-transition:leave-start="opacity-100 transform scale-100"
                 x-transition:leave-end="opacity-0 transform scale-95"
                 x-on:click.self="closeModal()"
                 x-bind:style="showModal ? 'display: block;' : 'display: none;'">
                <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h4 class="modal-title" x-text="selectedEvent?.title || 'Детали события'">Детали события</h4>
                            <button type="button" class="btn-close" x-on:click="closeModal()"></button>
                        </div>
                        <div class="modal-body">
                            <template x-if="selectedEvent">
                                <div>
                                    <!-- Тип события -->
                                    <div class="mb-3">
                                        <span class="badge fs-6 fw-bold" 
                                              x-bind:class="{
                                                  'badge bg-blue-lt': selectedEvent.extendedProps?.type === 'visit',
                                                  'badge bg-orange-lt': selectedEvent.extendedProps?.type === 'student_visit', 
                                                  'badge bg-purple-lt': selectedEvent.extendedProps?.type === 'group_visit',
                                                  'badge bg-orange-lt': selectedEvent.extendedProps?.type === 'classroom_booking'
                                              }"
                                              x-text="getEventTypeLabel(selectedEvent.extendedProps?.type)">
                                        </span>
                                    </div>
                                    
                                    <!-- Основная информация -->
                                    <div class="row mb-3">
                                        <div class="col-md-6">
                                            <label class="form-label fw-bold">Время начала:</label>
                                            <div class="text-muted" x-text="formatDateTime(selectedEvent.start)"></div>
                                        </div>
                                        <div class="col-md-6" x-show="selectedEvent.end">
                                            <label class="form-label fw-bold">Время окончания:</label>
                                            <div class="text-muted" x-text="formatDateTime(selectedEvent.end)"></div>
                                        </div>
                                    </div>
                                    
                                    <!-- Статус -->
                                    <div class="mb-3" x-show="selectedEvent.extendedProps?.status">
                                        <label class="form-label fw-bold">Статус:</label>
                                        <div>
                                            <span class="badge" 
                                                  x-bind:class="{
                                                      'badge bg-yellow-lt': selectedEvent.extendedProps?.status === 'PENDING' || selectedEvent.extendedProps?.status === 'WAITING_FOR_APPROVAL',
                                                      'badge bg-green-lt': selectedEvent.extendedProps?.status === 'CHECKED_IN' || selectedEvent.extendedProps?.status === 'ISSUED' || selectedEvent.extendedProps?.status === 'APPROVED',
                                                      'badge bg-red-lt': selectedEvent.extendedProps?.status === 'CANCELLED' || selectedEvent.extendedProps?.status === 'REJECTED' || selectedEvent.extendedProps?.status === 'EXPIRED',
                                                      'badge bg-gray-lt': selectedEvent.extendedProps?.status === 'COMPLETED' || selectedEvent.extendedProps?.status === 'RETURNED',
                                                      'badge bg-blue-lt': selectedEvent.extendedProps?.status === 'CONFIRMED'
                                                  }"
                                                  x-text="getStatusLabel(selectedEvent.extendedProps?.status)">
                                            </span>
                                        </div>
                                    </div>
                                    
                                    <!-- Детали события -->
                                    <div class="card">
                                        <div class="card-body">
                                            <div class="row g-3">
                                                <div class="col-md-6" x-show="selectedEvent.extendedProps?.guest_name">
                                                    <label class="form-label">Гость:</label>
                                                    <div x-text="selectedEvent.extendedProps?.guest_name"></div>
                                                </div>
                                                <div class="col-md-6" x-show="selectedEvent.extendedProps?.employee_name">
                                                    <label class="form-label">Сотрудник:</label>
                                                    <div x-text="selectedEvent.extendedProps?.employee_name"></div>
                                                </div>
                                                <div class="col-md-6" x-show="selectedEvent.extendedProps?.teacher_name">
                                                    <label class="form-label">Преподаватель:</label>
                                                    <div x-text="selectedEvent.extendedProps?.teacher_name"></div>
                                                </div>
                                                <div class="col-md-6" x-show="selectedEvent.extendedProps?.department">
                                                    <label class="form-label">Департамент:</label>
                                                    <div x-text="selectedEvent.extendedProps?.department"></div>
                                                </div>
                                                <div class="col-md-6" x-show="selectedEvent.extendedProps?.classroom">
                                                    <label class="form-label">Аудитория:</label>
                                                    <div x-text="selectedEvent.extendedProps?.classroom"></div>
                                                </div>
                                                <div class="col-md-6" x-show="selectedEvent.extendedProps?.purpose">
                                                    <label class="form-label">Цель:</label>
                                                    <div x-text="selectedEvent.extendedProps?.purpose"></div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </template>
                        </div>

                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" x-on:click="closeModal()">Закрыть</button>
                            <template x-if="selectedEvent?.extendedProps?.detail_url">
                                <a x-bind:href="selectedEvent.extendedProps?.detail_url" class="btn btn-primary" target="_blank">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="icon me-1" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                                        <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
                                        <path d="M10 14l2 -2l2 2"/>
                                        <path d="M12 19v-7"/>
                                        <path d="M9 4h6"/>
                                        <path d="M10 3v2"/>
                                        <path d="M14 3v2"/>
                                    </svg>
                                    Подробнее
                                </a>
                            </template>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js'></script>
<script>
// Подавляем ошибки Chrome extension runtime
if (typeof chrome !== 'undefined' && chrome.runtime && chrome.runtime.lastError) {
    console.warn('Chrome extension error suppressed:', chrome.runtime.lastError);
}

// Ждем полной готовности DOM и Alpine.js
function initCalendarApp() {
    // Проверяем, что функция еще не определена
    if (window.calendarApp) {
        console.log('calendarApp уже определена, пропускаем...');
        return;
    }
    
    console.log('Определяем calendarApp...');
    
    window.calendarApp = function() {
        return {
            calendar: null,
            allEvents: [],
            activeFilters: ['all'],
            showModal: false,
            selectedEvent: null,
            totalEvents: 0,
            activeVisits: 0,
            bookingsCount: 0,
            todayEvents: 0,
            
            init() {
                console.log('Инициализация Alpine.js компонента календаря');
                this.initializeCalendar();
            },
            
            initializeCalendar() {
                console.log('Инициализация FullCalendar...');
                const calendarEl = document.getElementById('calendar');
                
                if (!calendarEl) {
                    console.error('Элемент календаря не найден!');
                    return;
                }
                
                try {
                    this.calendar = new FullCalendar.Calendar(calendarEl, {
                        initialView: 'dayGridMonth',
                        headerToolbar: {
                            left: 'prev,next today',
                            center: 'title',
                            right: 'dayGridMonth,timeGridWeek,timeGridDay'
                        },
                        locale: 'ru',
                        firstDay: 1, // Понедельник
                        height: 'auto',
                        buttonText: {
                            today: 'Сегодня',
                            month: 'Месяц', 
                            week: 'Неделя',
                            day: 'День'
                        },
                        eventSources: [
                            {
                                url: '/calendar/api/events/',
                                method: 'GET',
                                failure: function(error) {
                                    console.error('Ошибка загрузки событий календаря:', error);
                                    // Не показываем alert, только логируем
                                }
                            }
                        ],
                        eventClick: (info) => {
                            console.log('Клик по событию:', info.event.title);
                            this.showEventDetails(info.event);
                        },
                        eventDidMount: (info) => {
                            try {
                                // Добавляем красивые стили для событий
                                const eventType = info.event.extendedProps.type;
                                if (eventType) {
                                    info.el.classList.add('event-' + eventType);
                                }
                                
                                // Добавляем иконки
                                const iconMap = {
                                    'visit': '👤',
                                    'student_visit': '🎓',
                                    'group_visit': '👥',
                                    'classroom_booking': '🏫'
                                };
                                
                                const icon = iconMap[eventType] || '📅';
                                const titleEl = info.el.querySelector('.fc-event-title');
                                if (titleEl) {
                                    titleEl.innerHTML = icon + ' ' + titleEl.innerHTML;
                                }
                                
                                // Добавляем tooltip
                                const startTime = this.formatDateTime(info.event.start);
                                const endTime = info.event.end ? this.formatDateTime(info.event.end) : '';
                                info.el.title = info.event.title + ' - ' + startTime + 
                                               (endTime ? ' до ' + endTime : '');
                            } catch (e) {
                                console.warn('Ошибка при настройке события:', e);
                            }
                        },
                        loading: (isLoading) => {
                            if (isLoading) {
                                console.log('Загрузка событий...');
                            } else {
                                console.log('Загрузка событий завершена');
                                // Обновляем статистику после загрузки событий
                                setTimeout(() => {
                                    this.updateStatistics();
                                    this.applyFilters();
                                }, 100);
                            }
                        }
                    });
                    
                    this.calendar.render();
                    console.log('FullCalendar отрендерен');
                } catch (error) {
                    console.error('Ошибка инициализации календаря:', error);
                }
            },
            
            updateStatistics() {
                if (!this.calendar) {
                    console.warn('Календарь не инициализирован');
                    return;
                }
                
                try {
                    // Получаем все события из календаря
                    const events = this.calendar.getEvents();
                    this.totalEvents = events.length;
                    
                    // Подсчет активных визитов
                    this.activeVisits = events.filter(event => 
                        ['CHECKED_IN', 'APPROVED', 'ISSUED'].includes(event.extendedProps?.status)
                    ).length;
                    
                    // Подсчет бронирований
                    this.bookingsCount = events.filter(event => 
                        event.extendedProps?.type === 'classroom_booking'
                    ).length;
                    
                    // События сегодня
                    const today = new Date();
                    today.setHours(0, 0, 0, 0);
                    const tomorrow = new Date(today);
                    tomorrow.setDate(tomorrow.getDate() + 1);
                    
                    this.todayEvents = events.filter(event => {
                        const eventStart = event.start;
                        return eventStart && eventStart >= today && eventStart < tomorrow;
                    }).length;
                    
                    console.log('Статистика обновлена:', {
                        total: this.totalEvents,
                        active: this.activeVisits,
                        bookings: this.bookingsCount,
                        today: this.todayEvents
                    });
                } catch (error) {
                    console.error('Ошибка обновления статистики:', error);
                }
            },
            
            toggleFilter(filterType) {
                console.log('Переключение фильтра:', filterType);
                try {
                    if (filterType === 'all') {
                        this.activeFilters = ['all'];
                    } else {
                        // Убираем 'all' если выбираем конкретный тип
                        if (this.activeFilters.includes('all')) {
                            this.activeFilters = [filterType];
                        } else {
                            // Переключаем фильтр
                            const index = this.activeFilters.indexOf(filterType);
                            if (index > -1) {
                                this.activeFilters.splice(index, 1);
                            } else {
                                this.activeFilters.push(filterType);
                            }
                            
                            // Если ничего не выбрано, показываем все
                            if (this.activeFilters.length === 0) {
                                this.activeFilters = ['all'];
                            }
                        }
                    }
                    
                    this.applyFilters();
                } catch (error) {
                    console.error('Ошибка переключения фильтра:', error);
                }
            },
            
            applyFilters() {
                if (!this.calendar) {
                    console.warn('Календарь не готов для применения фильтров');
                    return;
                }
                
                try {
                    const events = this.calendar.getEvents();
                    console.log('Применение фильтров к', events.length, 'событиям');
                    
                    events.forEach(event => {
                        const eventType = event.extendedProps?.type;
                        const shouldShow = this.activeFilters.includes('all') || 
                                         this.activeFilters.includes(eventType);
                        
                        event.setProp('display', shouldShow ? 'auto' : 'none');
                    });
                } catch (error) {
                    console.error('Ошибка применения фильтров:', error);
                }
            },
            
            refreshCalendar() {
                console.log('Обновление календаря...');
                try {
                    if (this.calendar) {
                        // Удаляем все существующие события перед обновлением
                        this.calendar.removeAllEvents();
                        // Обновляем источники событий
                        this.calendar.refetchEvents();
                    }
                } catch (error) {
                    console.error('Ошибка обновления календаря:', error);
                }
            },
            
            showEventDetails(event) {
                console.log('Показ деталей события:', event.title);
                console.log('Данные события:', event);
                try {
                    this.selectedEvent = {
                        title: event.title,
                        start: event.start,
                        end: event.end,
                        extendedProps: event.extendedProps || {}
                    };
                    
                    console.log('selectedEvent установлен:', this.selectedEvent);
                    
                    // Устанавливаем showModal в true
                    this.showModal = true;
                    console.log('showModal установлен в:', this.showModal);
                    
                    // Добавляем backdrop и показываем модальное окно принудительно
                    this.$nextTick(() => {
                        console.log('NextTick: модальное окно должно быть показано');
                        const modal = document.getElementById('eventModal');
                        if (modal) {
                            modal.style.display = 'block';
                            modal.classList.add('show');
                            document.body.classList.add('modal-open');
                            
                            // Добавляем backdrop
                            if (!document.querySelector('.modal-backdrop')) {
                                const backdrop = document.createElement('div');
                                backdrop.className = 'modal-backdrop fade show';
                                document.body.appendChild(backdrop);
                            }
                        }
                    });
                } catch (error) {
                    console.error('Ошибка показа деталей события:', error);
                }
            },
            
            closeModal() {
                console.log('Закрытие модального окна');
                try {
                    this.showModal = false;
                    this.selectedEvent = null;
                    
                    // Принудительно скрываем модальное окно
                    this.$nextTick(() => {
                        const modal = document.getElementById('eventModal');
                        if (modal) {
                            modal.style.display = 'none';
                            modal.classList.remove('show');
                            document.body.classList.remove('modal-open');
                        }
                        
                        // Удаляем backdrop
                        const backdrop = document.querySelector('.modal-backdrop');
                        if (backdrop) {
                            backdrop.remove();
                        }
                    });
                } catch (error) {
                    console.error('Ошибка закрытия модального окна:', error);
                }
            },
            
            formatDateTime(date) {
                if (!date) return '';
                try {
                    return new Date(date).toLocaleString('ru-RU', {
                        year: 'numeric',
                        month: 'long',
                        day: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit'
                    });
                } catch (error) {
                    console.error('Ошибка форматирования даты:', error);
                    return String(date);
                }
            },
            
            getEventTypeLabel(type) {
                const labels = {
                    'visit': 'Официальный визит',
                    'student_visit': 'Студенческий визит',
                    'group_visit': 'Групповое приглашение',
                    'classroom_booking': 'Бронирование аудитории'
                };
                return labels[type] || 'Событие';
            },
            
            getStatusLabel(status) {
                const labels = {
                    'PENDING': 'Ожидает',
                    'WAITING_FOR_APPROVAL': 'Ожидает одобрения',
                    'CHECKED_IN': 'В здании',
                    'ISSUED': 'Выдан',
                    'APPROVED': 'Одобрен',
                    'CANCELLED': 'Отменен',
                    'REJECTED': 'Отклонен',
                    'EXPIRED': 'Просрочен',
                    'COMPLETED': 'Завершен',
                    'RETURNED': 'Возвращен',
                    'CONFIRMED': 'Подтвержден',
                    'AWAITING': 'Ожидает прибытия',
                    'CHECKED_OUT': 'Вышел',
                    'reserved': 'Забронировано',
                    'issued': 'Ключ выдан',
                    'returned': 'Ключ возвращен',
                    'expired': 'Просрочено',
                    'cancelled': 'Отменено'
                };
                return labels[status] || status;
            }
        }
    }
    
    console.log('Функция calendarApp определена:', typeof window.calendarApp);
}

// Несколько способов инициализации для обеспечения совместимости
document.addEventListener('alpine:init', function() {
    console.log('Alpine:init событие');
    initCalendarApp();
});

document.addEventListener('DOMContentLoaded', function() {
    console.log('DOMContentLoaded событие');
    // Задержка для случаев, когда Alpine.js уже инициализирован
    setTimeout(initCalendarApp, 100);
});

// Если Alpine.js уже загружен
if (window.Alpine) {
    console.log('Alpine.js уже доступен');
    initCalendarApp();
}

// Дополнительная инициализация через 1 секунду
setTimeout(function() {
    if (!window.calendarApp) {
        console.log('Принудительная инициализация calendarApp');
        initCalendarApp();
    }
}, 1000);
</script>
{% endblock %}
