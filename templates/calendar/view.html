{% extends "base.html" %}
{% load static %}

{% block title %}{{ page_title }} - –°–∏—Å—Ç–µ–º–∞ –≤–∏–∑–∏—Ç–æ–≤{% endblock %}

{% block extra_css %}
<link href='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.css' rel='stylesheet' />
<style>
    /* –ü–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª—è–µ–º —Å—Ç–∏–ª–∏ FullCalendar –¥–ª—è Tabler UI */
    .fc {
        font-family: inherit;
    }
    
    .fc-theme-standard .fc-event {
        border-radius: 6px;
        border: none;
        font-weight: 500;
        padding: 2px 6px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.12), 0 1px 2px rgba(0,0,0,0.24);
        transition: all 0.2s ease;
    }
    
    .fc-theme-standard .fc-event:hover {
        transform: translateY(-1px);
        box-shadow: 0 3px 6px rgba(0,0,0,0.15), 0 2px 4px rgba(0,0,0,0.12);
    }
    
    .fc-toolbar {
        margin-bottom: 1.5rem !important;
    }
    
    .fc-toolbar-title {
        font-size: 1.5rem !important;
        font-weight: 600 !important;
        color: var(--tblr-primary);
    }
    
    .fc-button-group .fc-button {
        background: var(--tblr-primary);
        border-color: var(--tblr-primary);
        border-radius: 6px;
    }
    
    .fc-button-group .fc-button:hover {
        background: var(--tblr-primary-dark);
        border-color: var(--tblr-primary-dark);
    }
    
    .fc-today-button {
        background: var(--tblr-success) !important;
        border-color: var(--tblr-success) !important;
    }
    
    .fc-daygrid-day.fc-day-today {
        background-color: rgba(var(--tblr-primary-rgb), 0.05) !important;
    }
    
    /* –ö–∞—Å—Ç–æ–º–Ω—ã–µ —Ü–≤–µ—Ç–∞ –¥–ª—è —Ç–∏–ø–æ–≤ —Å–æ–±—ã—Ç–∏–π */
    .event-visit { background-color: #1976d2 !important; }
    .event-student { background-color: #2e7d32 !important; }
    .event-group { background-color: #7b1fa2 !important; }
    .event-booking { background-color: #f57c00 !important; }
    
    /* –£–ª—É—á—à–µ–Ω–Ω–æ–µ –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ */
    .modal {
        position: fixed;
        top: 0;
        left: 0;
        z-index: 1055;
        width: 100%;
        height: 100%;
        overflow-x: hidden;
        overflow-y: auto;
        background-color: rgba(0, 0, 0, 0.5);
        backdrop-filter: blur(4px);
    }
    
    .modal.show {
        display: block !important;
    }
    
    .modal-backdrop {
        position: fixed;
        top: 0;
        left: 0;
        z-index: 1040;
        width: 100vw;
        height: 100vh;
        background-color: #000;
        opacity: 0.5;
    }
    
    .modal-backdrop.fade {
        opacity: 0;
    }
    
    .modal-backdrop.show {
        opacity: 0.5;
    }
    
    .modal-open {
        overflow: hidden;
    }
    
    .event-details-modal {
        display: none;
        position: fixed;
        z-index: 1055;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0,0,0,0.5);
        backdrop-filter: blur(4px);
    }
    
    .modal-content {
        background: white;
        margin: 5% auto;
        border-radius: 12px;
        width: 90%;
        max-width: 600px;
        position: relative;
        box-shadow: 0 10px 25px rgba(0,0,0,0.2);
        animation: modalSlideIn 0.3s ease;
    }
    
    @keyframes modalSlideIn {
        from { opacity: 0; transform: translateY(-30px); }
        to { opacity: 1; transform: translateY(0); }
    }
    
    .modal-header {
        padding: 1.5rem;
        border-bottom: 1px solid var(--tblr-border-color);
        border-radius: 12px 12px 0 0;
    }
    
    .modal-body {
        padding: 1.5rem;
    }
    
    .modal-footer {
        padding: 1rem 1.5rem;
        border-top: 1px solid var(--tblr-border-color);
        border-radius: 0 0 12px 12px;
        background: var(--tblr-bg-surface-secondary);
    }
    
    .close {
        color: var(--tblr-muted);
        float: right;
        font-size: 24px;
        font-weight: bold;
        cursor: pointer;
        position: absolute;
        right: 20px;
        top: 20px;
        width: 32px;
        height: 32px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
        transition: all 0.2s ease;
    }
    
    .close:hover {
        color: var(--tblr-dark);
        background: var(--tblr-bg-surface);
    }
    
    .event-type-badge {
        display: inline-flex;
        align-items: center;
        padding: 4px 12px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: 600;
        color: white;
        margin-bottom: 16px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    
    .calendar-filters {
        background: white;
        border-radius: 12px;
        padding: 1.5rem;
        margin-bottom: 1.5rem;
        box-shadow: 0 1px 3px rgba(0,0,0,0.06);
        border: 1px solid var(--tblr-border-color);
    }
    
    .filter-title {
        font-size: 1.1rem;
        font-weight: 600;
        color: var(--tblr-dark);
        margin-bottom: 1rem;
        display: flex;
        align-items: center;
    }
    
    .filter-title svg {
        margin-right: 8px;
        color: var(--tblr-primary);
    }
    
    .calendar-container {
        background: white;
        border-radius: 12px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.06);
        border: 1px solid var(--tblr-border-color);
        overflow: hidden;
    }
    
    .calendar-header {
        background: linear-gradient(135deg, var(--tblr-primary) 0%, var(--tblr-primary-dark) 100%);
        color: white;
        padding: 1.5rem;
        text-align: center;
    }
    
    .calendar-header h1 {
        margin: 0;
        font-size: 1.75rem;
        font-weight: 600;
    }
    
    .calendar-header p {
        margin: 0.5rem 0 0 0;
        opacity: 0.9;
        font-size: 0.95rem;
    }
    
    .stats-row {
        background: var(--tblr-bg-surface-secondary);
        padding: 1rem 1.5rem;
        border-bottom: 1px solid var(--tblr-border-color);
    }
    
    .stat-item {
        text-align: center;
    }
    
    .stat-number {
        font-size: 1.5rem;
        font-weight: 700;
        color: var(--tblr-primary);
        margin: 0;
    }
    
    .stat-label {
        font-size: 0.875rem;
        color: var(--tblr-muted);
        margin: 0;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    
    .calendar-content {
        padding: 1.5rem;
    }
    
    /* Alpine.js cloak */
    [x-cloak] {
        display: none !important;
    }
</style>
{% endblock %}

{% block content %}
<div class="page-wrapper">
    <div class="page-header d-print-none">
        <div class="container-xl">
            <div class="row g-2 align-items-center">
                <div class="col">
                    <div class="page-pretitle">
                        –°–∏—Å—Ç–µ–º–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –≤–∏–∑–∏—Ç–∞–º–∏
                    </div>
                    <h2 class="page-title">
                        <svg xmlns="http://www.w3.org/2000/svg" class="icon me-2" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                            <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
                            <rect x="4" y="5" width="16" height="16" rx="2"/>
                            <line x1="16" y1="3" x2="16" y2="7"/>
                            <line x1="8" y1="3" x2="8" y2="7"/>
                            <rect x="8" y="11" width="2" height="2"/>
                            <rect x="12" y="11" width="2" height="2"/>
                            <rect x="16" y="11" width="2" height="2"/>
                            <rect x="8" y="15" width="2" height="2"/>
                            <rect x="12" y="15" width="2" height="2"/>
                        </svg>
                        {{ page_title }}
                    </h2>
                </div>
                {% comment %}
                    <div class="col-auto ms-auto d-print-none">
                        <div class="btn-list">
                            <a href="{% url 'employee_dashboard' %}" class="btn btn-outline-primary">
                                <svg xmlns="http://www.w3.org/2000/svg" class="icon me-1" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                                    <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
                                    <path d="M5 12l5 5l10 -10"/>
                                </svg>
                                –ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è
                            </a>
                            <a href="#" class="btn btn-primary" onclick="window.print()">
                                <svg xmlns="http://www.w3.org/2000/svg" class="icon me-1" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                                    <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
                                    <path d="M17 17h2a2 2 0 0 0 2 -2v-4a2 2 0 0 0 -2 -2h-14a2 2 0 0 0 -2 2v4a2 2 0 0 0 2 2h2"/>
                                    <path d="M17 9v-4a2 2 0 0 0 -2 -2h-6a2 2 0 0 0 -2 2v4"/>
                                    <rect x="7" y="13" width="10" height="8" rx="2"/>
                                </svg>
                                –ü–µ—á–∞—Ç—å
                            </a>
                        </div>
                    </div>
                {% endcomment %}
            </div>
        </div>
    </div>
    
    <div class="page-body">
        <div class="container-xl" x-data="calendarApp()">
            <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
            <div class="row mb-4">
                <div class="col-sm-6 col-lg-3">
                    <div class="card">
                        <div class="card-body">
                            <div class="d-flex align-items-center">
                                <div class="subheader">–í—Å–µ–≥–æ —Å–æ–±—ã—Ç–∏–π</div>
                                <div class="ms-auto">
                                    <div class="chart-sparkline chart-sparkline-sm" id="sparkline-activity"></div>
                                </div>
                            </div>
                            <div class="h1 mb-3" x-text="totalEvents">0</div>
                            <div class="d-flex mb-2">
                                <div>–ó–∞ —Ç–µ–∫—É—â–∏–π –º–µ—Å—è—Ü</div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-sm-6 col-lg-3">
                    <div class="card">
                        <div class="card-body">
                            <div class="d-flex align-items-center">
                                <div class="subheader">–ê–∫—Ç–∏–≤–Ω—ã–µ –≤–∏–∑–∏—Ç—ã</div>
                                <div class="ms-auto">
                                    <span class="badge bg-green"></span>
                                </div>
                            </div>
                            <div class="h1 mb-3" x-text="activeVisits">0</div>
                            <div class="d-flex mb-2">
                                <div>–í –∑–¥–∞–Ω–∏–∏ —Å–µ–π—á–∞—Å</div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-sm-6 col-lg-3">
                    <div class="card">
                        <div class="card-body">
                            <div class="d-flex align-items-center">
                                <div class="subheader">–ë—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è</div>
                                <div class="ms-auto">
                                    <span class="badge bg-yellow"></span>
                                </div>
                            </div>
                            <div class="h1 mb-3" x-text="bookingsCount">0</div>
                            <div class="d-flex mb-2">
                                <div>–ê—É–¥–∏—Ç–æ—Ä–∏–π –∑–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–æ</div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-sm-6 col-lg-3">
                    <div class="card">
                        <div class="card-body">
                            <div class="d-flex align-items-center">
                                <div class="subheader">–°–µ–≥–æ–¥–Ω—è</div>
                                <div class="ms-auto">
                                    <span class="badge bg-blue"></span>
                                </div>
                            </div>
                            <div class="h1 mb-3" x-text="todayEvents">0</div>
                            <div class="d-flex mb-2">
                                <div>–°–æ–±—ã—Ç–∏–π –∑–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–æ</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- –§–∏–ª—å—Ç—Ä—ã -->
            <div class="card mb-4">
                <div class="card-header">
                    <h3 class="card-title">
                        <svg xmlns="http://www.w3.org/2000/svg" class="icon me-2" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                            <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
                            <path d="M5.5 5h13a1 1 0 0 1 .5 1.5l-5 5.5l0 7l-4 -3l0 -4l-5 -5.5a1 1 0 0 1 .5 -1.5"/>
                        </svg>
                        –§–∏–ª—å—Ç—Ä—ã —Å–æ–±—ã—Ç–∏–π
                    </h3>
                </div>
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-auto">
                            <label class="form-selectgroup-item">
                                <input type="radio" name="event-filter" value="all" class="form-selectgroup-input" 
                                       x-on:change="toggleFilter('all')" x-bind:checked="activeFilters.includes('all')">
                                <span class="form-selectgroup-label">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="icon me-1" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                                        <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
                                        <circle cx="12" cy="12" r="9"/>
                                        <path d="M12 3c7.2 0 9 1.8 9 9s-1.8 9 -9 9s-9 -1.8 -9 -9s1.8 -9 9 -9z"/>
                                    </svg>
                                    –í—Å–µ —Å–æ–±—ã—Ç–∏—è
                                </span>
                            </label>
                        </div>
                        <div class="col-auto">
                            <label class="form-selectgroup-item">
                                <input type="checkbox" name="event-filter" value="visit" class="form-selectgroup-input"
                                       x-on:change="toggleFilter('visit')" x-bind:checked="activeFilters.includes('visit')">
                                <span class="form-selectgroup-label">
                                    <span class="badge bg-blue me-1"></span>
                                    –í–∏–∑–∏—Ç—ã
                                </span>
                            </label>
                        </div>
                        <div class="col-auto">
                            <label class="form-selectgroup-item">
                                <input type="checkbox" name="event-filter" value="student_visit" class="form-selectgroup-input"
                                       x-on:change="toggleFilter('student_visit')" x-bind:checked="activeFilters.includes('student_visit')">
                                <span class="form-selectgroup-label">
                                    <span class="badge bg-green me-1"></span>
                                    –°—Ç—É–¥–µ–Ω—Ç—ã
                                </span>
                            </label>
                        </div>
                        <div class="col-auto">
                            <label class="form-selectgroup-item">
                                <input type="checkbox" name="event-filter" value="group_visit" class="form-selectgroup-input"
                                       x-on:change="toggleFilter('group_visit')" x-bind:checked="activeFilters.includes('group_visit')">
                                <span class="form-selectgroup-label">
                                    <span class="badge bg-purple me-1"></span>
                                    –ì—Ä—É–ø–ø—ã
                                </span>
                            </label>
                        </div>
                        <div class="col-auto">
                            <label class="form-selectgroup-item">
                                <input type="checkbox" name="event-filter" value="classroom_booking" class="form-selectgroup-input"
                                       x-on:change="toggleFilter('classroom_booking')" x-bind:checked="activeFilters.includes('classroom_booking')">
                                <span class="form-selectgroup-label">
                                    <span class="badge bg-orange me-1"></span>
                                    –ê—É–¥–∏—Ç–æ—Ä–∏–∏
                                </span>
                            </label>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- –ö–∞–ª–µ–Ω–¥–∞—Ä—å -->
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">–ö–∞–ª–µ–Ω–¥–∞—Ä—å —Å–æ–±—ã—Ç–∏–π</h3>
                    <div class="card-actions">
                        <button class="btn btn-sm btn-outline-primary" x-on:click="refreshCalendar()">
                            <svg xmlns="http://www.w3.org/2000/svg" class="icon" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                                <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
                                <path d="M20 11a8.1 8.1 0 0 0 -15.5 -2m-.5 -4v4h4"/>
                                <path d="M4 13a8.1 8.1 0 0 0 15.5 2m.5 4v-4h-4"/>
                            </svg>
                            –û–±–Ω–æ–≤–∏—Ç—å
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <div id="calendar"></div>
                </div>
            </div>

            <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –¥–µ—Ç–∞–ª–µ–π —Å–æ–±—ã—Ç–∏—è –≤ —Å—Ç–∏–ª–µ Tabler UI -->
            <div class="modal" id="eventModal" tabindex="-1" 
                 x-show="showModal" 
                 x-cloak
                 style="display: none;"
                 x-transition:enter="transition ease-out duration-300"
                 x-transition:enter-start="opacity-0 transform scale-95"
                 x-transition:enter-end="opacity-100 transform scale-100"
                 x-transition:leave="transition ease-in duration-200"
                 x-transition:leave-start="opacity-100 transform scale-100"
                 x-transition:leave-end="opacity-0 transform scale-95"
                 x-on:click.self="closeModal()"
                 x-bind:style="showModal ? 'display: block;' : 'display: none;'">
                <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h4 class="modal-title" x-text="selectedEvent?.title || '–î–µ—Ç–∞–ª–∏ —Å–æ–±—ã—Ç–∏—è'">–î–µ—Ç–∞–ª–∏ —Å–æ–±—ã—Ç–∏—è</h4>
                            <button type="button" class="btn-close" x-on:click="closeModal()"></button>
                        </div>
                        <div class="modal-body">
                            <template x-if="selectedEvent">
                                <div>
                                    <!-- –¢–∏–ø —Å–æ–±—ã—Ç–∏—è -->
                                    <div class="mb-3">
                                        <span class="badge fs-6 fw-bold" 
                                              x-bind:class="{
                                                  'badge bg-blue-lt': selectedEvent.extendedProps?.type === 'visit',
                                                  'badge bg-orange-lt': selectedEvent.extendedProps?.type === 'student_visit', 
                                                  'badge bg-purple-lt': selectedEvent.extendedProps?.type === 'group_visit',
                                                  'badge bg-orange-lt': selectedEvent.extendedProps?.type === 'classroom_booking'
                                              }"
                                              x-text="getEventTypeLabel(selectedEvent.extendedProps?.type)">
                                        </span>
                                    </div>
                                    
                                    <!-- –û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è -->
                                    <div class="row mb-3">
                                        <div class="col-md-6">
                                            <label class="form-label fw-bold">–í—Ä–µ–º—è –Ω–∞—á–∞–ª–∞:</label>
                                            <div class="text-muted" x-text="formatDateTime(selectedEvent.start)"></div>
                                        </div>
                                        <div class="col-md-6" x-show="selectedEvent.end">
                                            <label class="form-label fw-bold">–í—Ä–µ–º—è –æ–∫–æ–Ω—á–∞–Ω–∏—è:</label>
                                            <div class="text-muted" x-text="formatDateTime(selectedEvent.end)"></div>
                                        </div>
                                    </div>
                                    
                                    <!-- –°—Ç–∞—Ç—É—Å -->
                                    <div class="mb-3" x-show="selectedEvent.extendedProps?.status">
                                        <label class="form-label fw-bold">–°—Ç–∞—Ç—É—Å:</label>
                                        <div>
                                            <span class="badge" 
                                                  x-bind:class="{
                                                      'badge bg-yellow-lt': selectedEvent.extendedProps?.status === 'PENDING' || selectedEvent.extendedProps?.status === 'WAITING_FOR_APPROVAL',
                                                      'badge bg-green-lt': selectedEvent.extendedProps?.status === 'CHECKED_IN' || selectedEvent.extendedProps?.status === 'ISSUED' || selectedEvent.extendedProps?.status === 'APPROVED',
                                                      'badge bg-red-lt': selectedEvent.extendedProps?.status === 'CANCELLED' || selectedEvent.extendedProps?.status === 'REJECTED' || selectedEvent.extendedProps?.status === 'EXPIRED',
                                                      'badge bg-gray-lt': selectedEvent.extendedProps?.status === 'COMPLETED' || selectedEvent.extendedProps?.status === 'RETURNED',
                                                      'badge bg-blue-lt': selectedEvent.extendedProps?.status === 'CONFIRMED'
                                                  }"
                                                  x-text="getStatusLabel(selectedEvent.extendedProps?.status)">
                                            </span>
                                        </div>
                                    </div>
                                    
                                    <!-- –î–µ—Ç–∞–ª–∏ —Å–æ–±—ã—Ç–∏—è -->
                                    <div class="card">
                                        <div class="card-body">
                                            <div class="row g-3">
                                                <div class="col-md-6" x-show="selectedEvent.extendedProps?.guest_name">
                                                    <label class="form-label">–ì–æ—Å—Ç—å:</label>
                                                    <div x-text="selectedEvent.extendedProps?.guest_name"></div>
                                                </div>
                                                <div class="col-md-6" x-show="selectedEvent.extendedProps?.employee_name">
                                                    <label class="form-label">–°–æ—Ç—Ä—É–¥–Ω–∏–∫:</label>
                                                    <div x-text="selectedEvent.extendedProps?.employee_name"></div>
                                                </div>
                                                <div class="col-md-6" x-show="selectedEvent.extendedProps?.teacher_name">
                                                    <label class="form-label">–ü—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—å:</label>
                                                    <div x-text="selectedEvent.extendedProps?.teacher_name"></div>
                                                </div>
                                                <div class="col-md-6" x-show="selectedEvent.extendedProps?.department">
                                                    <label class="form-label">–î–µ–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç:</label>
                                                    <div x-text="selectedEvent.extendedProps?.department"></div>
                                                </div>
                                                <div class="col-md-6" x-show="selectedEvent.extendedProps?.classroom">
                                                    <label class="form-label">–ê—É–¥–∏—Ç–æ—Ä–∏—è:</label>
                                                    <div x-text="selectedEvent.extendedProps?.classroom"></div>
                                                </div>
                                                <div class="col-md-6" x-show="selectedEvent.extendedProps?.purpose">
                                                    <label class="form-label">–¶–µ–ª—å:</label>
                                                    <div x-text="selectedEvent.extendedProps?.purpose"></div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </template>
                        </div>

                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" x-on:click="closeModal()">–ó–∞–∫—Ä—ã—Ç—å</button>
                            <template x-if="selectedEvent?.extendedProps?.detail_url">
                                <a x-bind:href="selectedEvent.extendedProps?.detail_url" class="btn btn-primary" target="_blank">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="icon me-1" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                                        <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
                                        <path d="M10 14l2 -2l2 2"/>
                                        <path d="M12 19v-7"/>
                                        <path d="M9 4h6"/>
                                        <path d="M10 3v2"/>
                                        <path d="M14 3v2"/>
                                    </svg>
                                    –ü–æ–¥—Ä–æ–±–Ω–µ–µ
                                </a>
                            </template>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js'></script>
<script>
// –ü–æ–¥–∞–≤–ª—è–µ–º –æ—à–∏–±–∫–∏ Chrome extension runtime
if (typeof chrome !== 'undefined' && chrome.runtime && chrome.runtime.lastError) {
    console.warn('Chrome extension error suppressed:', chrome.runtime.lastError);
}

// –ñ–¥–µ–º –ø–æ–ª–Ω–æ–π –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ DOM –∏ Alpine.js
function initCalendarApp() {
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Ñ—É–Ω–∫—Ü–∏—è –µ—â–µ –Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∞
    if (window.calendarApp) {
        console.log('calendarApp —É–∂–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∞, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º...');
        return;
    }
    
    console.log('–û–ø—Ä–µ–¥–µ–ª—è–µ–º calendarApp...');
    
    window.calendarApp = function() {
        return {
            calendar: null,
            allEvents: [],
            activeFilters: ['all'],
            showModal: false,
            selectedEvent: null,
            totalEvents: 0,
            activeVisits: 0,
            bookingsCount: 0,
            todayEvents: 0,
            
            init() {
                console.log('–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Alpine.js –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞ –∫–∞–ª–µ–Ω–¥–∞—Ä—è');
                this.initializeCalendar();
            },
            
            initializeCalendar() {
                console.log('–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è FullCalendar...');
                const calendarEl = document.getElementById('calendar');
                
                if (!calendarEl) {
                    console.error('–≠–ª–µ–º–µ–Ω—Ç –∫–∞–ª–µ–Ω–¥–∞—Ä—è –Ω–µ –Ω–∞–π–¥–µ–Ω!');
                    return;
                }
                
                try {
                    this.calendar = new FullCalendar.Calendar(calendarEl, {
                        initialView: 'dayGridMonth',
                        headerToolbar: {
                            left: 'prev,next today',
                            center: 'title',
                            right: 'dayGridMonth,timeGridWeek,timeGridDay'
                        },
                        locale: 'ru',
                        firstDay: 1, // –ü–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫
                        height: 'auto',
                        buttonText: {
                            today: '–°–µ–≥–æ–¥–Ω—è',
                            month: '–ú–µ—Å—è—Ü', 
                            week: '–ù–µ–¥–µ–ª—è',
                            day: '–î–µ–Ω—å'
                        },
                        eventSources: [
                            {
                                url: '/calendar/api/events/',
                                method: 'GET',
                                failure: function(error) {
                                    console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–æ–±—ã—Ç–∏–π –∫–∞–ª–µ–Ω–¥–∞—Ä—è:', error);
                                    // –ù–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º alert, —Ç–æ–ª—å–∫–æ –ª–æ–≥–∏—Ä—É–µ–º
                                }
                            }
                        ],
                        eventClick: (info) => {
                            console.log('–ö–ª–∏–∫ –ø–æ —Å–æ–±—ã—Ç–∏—é:', info.event.title);
                            this.showEventDetails(info.event);
                        },
                        eventDidMount: (info) => {
                            try {
                                // –î–æ–±–∞–≤–ª—è–µ–º –∫—Ä–∞—Å–∏–≤—ã–µ —Å—Ç–∏–ª–∏ –¥–ª—è —Å–æ–±—ã—Ç–∏–π
                                const eventType = info.event.extendedProps.type;
                                if (eventType) {
                                    info.el.classList.add('event-' + eventType);
                                }
                                
                                // –î–æ–±–∞–≤–ª—è–µ–º –∏–∫–æ–Ω–∫–∏
                                const iconMap = {
                                    'visit': 'üë§',
                                    'student_visit': 'üéì',
                                    'group_visit': 'üë•',
                                    'classroom_booking': 'üè´'
                                };
                                
                                const icon = iconMap[eventType] || 'üìÖ';
                                const titleEl = info.el.querySelector('.fc-event-title');
                                if (titleEl) {
                                    titleEl.innerHTML = icon + ' ' + titleEl.innerHTML;
                                }
                                
                                // –î–æ–±–∞–≤–ª—è–µ–º tooltip
                                const startTime = this.formatDateTime(info.event.start);
                                const endTime = info.event.end ? this.formatDateTime(info.event.end) : '';
                                info.el.title = info.event.title + ' - ' + startTime + 
                                               (endTime ? ' –¥–æ ' + endTime : '');
                            } catch (e) {
                                console.warn('–û—à–∏–±–∫–∞ –ø—Ä–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–µ —Å–æ–±—ã—Ç–∏—è:', e);
                            }
                        },
                        loading: (isLoading) => {
                            if (isLoading) {
                                console.log('–ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ–±—ã—Ç–∏–π...');
                            } else {
                                console.log('–ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ–±—ã—Ç–∏–π –∑–∞–≤–µ—Ä—à–µ–Ω–∞');
                                // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–æ–±—ã—Ç–∏–π
                                setTimeout(() => {
                                    this.updateStatistics();
                                    this.applyFilters();
                                }, 100);
                            }
                        }
                    });
                    
                    this.calendar.render();
                    console.log('FullCalendar –æ—Ç—Ä–µ–Ω–¥–µ—Ä–µ–Ω');
                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –∫–∞–ª–µ–Ω–¥–∞—Ä—è:', error);
                }
            },
            
            updateStatistics() {
                if (!this.calendar) {
                    console.warn('–ö–∞–ª–µ–Ω–¥–∞—Ä—å –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω');
                    return;
                }
                
                try {
                    // –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ —Å–æ–±—ã—Ç–∏—è –∏–∑ –∫–∞–ª–µ–Ω–¥–∞—Ä—è
                    const events = this.calendar.getEvents();
                    this.totalEvents = events.length;
                    
                    // –ü–æ–¥—Å—á–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –≤–∏–∑–∏—Ç–æ–≤
                    this.activeVisits = events.filter(event => 
                        ['CHECKED_IN', 'APPROVED', 'ISSUED'].includes(event.extendedProps?.status)
                    ).length;
                    
                    // –ü–æ–¥—Å—á–µ—Ç –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–π
                    this.bookingsCount = events.filter(event => 
                        event.extendedProps?.type === 'classroom_booking'
                    ).length;
                    
                    // –°–æ–±—ã—Ç–∏—è —Å–µ–≥–æ–¥–Ω—è
                    const today = new Date();
                    today.setHours(0, 0, 0, 0);
                    const tomorrow = new Date(today);
                    tomorrow.setDate(tomorrow.getDate() + 1);
                    
                    this.todayEvents = events.filter(event => {
                        const eventStart = event.start;
                        return eventStart && eventStart >= today && eventStart < tomorrow;
                    }).length;
                    
                    console.log('–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∞:', {
                        total: this.totalEvents,
                        active: this.activeVisits,
                        bookings: this.bookingsCount,
                        today: this.todayEvents
                    });
                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏:', error);
                }
            },
            
            toggleFilter(filterType) {
                console.log('–ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Ñ–∏–ª—å—Ç—Ä–∞:', filterType);
                try {
                    if (filterType === 'all') {
                        this.activeFilters = ['all'];
                    } else {
                        // –£–±–∏—Ä–∞–µ–º 'all' –µ—Å–ª–∏ –≤—ã–±–∏—Ä–∞–µ–º –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π —Ç–∏–ø
                        if (this.activeFilters.includes('all')) {
                            this.activeFilters = [filterType];
                        } else {
                            // –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º —Ñ–∏–ª—å—Ç—Ä
                            const index = this.activeFilters.indexOf(filterType);
                            if (index > -1) {
                                this.activeFilters.splice(index, 1);
                            } else {
                                this.activeFilters.push(filterType);
                            }
                            
                            // –ï—Å–ª–∏ –Ω–∏—á–µ–≥–æ –Ω–µ –≤—ã–±—Ä–∞–Ω–æ, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—Å–µ
                            if (this.activeFilters.length === 0) {
                                this.activeFilters = ['all'];
                            }
                        }
                    }
                    
                    this.applyFilters();
                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è —Ñ–∏–ª—å—Ç—Ä–∞:', error);
                }
            },
            
            applyFilters() {
                if (!this.calendar) {
                    console.warn('–ö–∞–ª–µ–Ω–¥–∞—Ä—å –Ω–µ –≥–æ—Ç–æ–≤ –¥–ª—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è —Ñ–∏–ª—å—Ç—Ä–æ–≤');
                    return;
                }
                
                try {
                    const events = this.calendar.getEvents();
                    console.log('–ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ —Ñ–∏–ª—å—Ç—Ä–æ–≤ –∫', events.length, '—Å–æ–±—ã—Ç–∏—è–º');
                    
                    events.forEach(event => {
                        const eventType = event.extendedProps?.type;
                        const shouldShow = this.activeFilters.includes('all') || 
                                         this.activeFilters.includes(eventType);
                        
                        event.setProp('display', shouldShow ? 'auto' : 'none');
                    });
                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è —Ñ–∏–ª—å—Ç—Ä–æ–≤:', error);
                }
            },
            
            refreshCalendar() {
                console.log('–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–∞–ª–µ–Ω–¥–∞—Ä—è...');
                try {
                    if (this.calendar) {
                        // –£–¥–∞–ª—è–µ–º –≤—Å–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —Å–æ–±—ã—Ç–∏—è –ø–µ—Ä–µ–¥ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ–º
                        this.calendar.removeAllEvents();
                        // –û–±–Ω–æ–≤–ª—è–µ–º –∏—Å—Ç–æ—á–Ω–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
                        this.calendar.refetchEvents();
                    }
                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∫–∞–ª–µ–Ω–¥–∞—Ä—è:', error);
                }
            },
            
            showEventDetails(event) {
                console.log('–ü–æ–∫–∞–∑ –¥–µ—Ç–∞–ª–µ–π —Å–æ–±—ã—Ç–∏—è:', event.title);
                console.log('–î–∞–Ω–Ω—ã–µ —Å–æ–±—ã—Ç–∏—è:', event);
                try {
                    this.selectedEvent = {
                        title: event.title,
                        start: event.start,
                        end: event.end,
                        extendedProps: event.extendedProps || {}
                    };
                    
                    console.log('selectedEvent —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω:', this.selectedEvent);
                    
                    // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º showModal –≤ true
                    this.showModal = true;
                    console.log('showModal —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –≤:', this.showModal);
                    
                    // –î–æ–±–∞–≤–ª—è–µ–º backdrop –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ
                    this.$nextTick(() => {
                        console.log('NextTick: –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –ø–æ–∫–∞–∑–∞–Ω–æ');
                        const modal = document.getElementById('eventModal');
                        if (modal) {
                            modal.style.display = 'block';
                            modal.classList.add('show');
                            document.body.classList.add('modal-open');
                            
                            // –î–æ–±–∞–≤–ª—è–µ–º backdrop
                            if (!document.querySelector('.modal-backdrop')) {
                                const backdrop = document.createElement('div');
                                backdrop.className = 'modal-backdrop fade show';
                                document.body.appendChild(backdrop);
                            }
                        }
                    });
                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞ –ø–æ–∫–∞–∑–∞ –¥–µ—Ç–∞–ª–µ–π —Å–æ–±—ã—Ç–∏—è:', error);
                }
            },
            
            closeModal() {
                console.log('–ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞');
                try {
                    this.showModal = false;
                    this.selectedEvent = null;
                    
                    // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ —Å–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
                    this.$nextTick(() => {
                        const modal = document.getElementById('eventModal');
                        if (modal) {
                            modal.style.display = 'none';
                            modal.classList.remove('show');
                            document.body.classList.remove('modal-open');
                        }
                        
                        // –£–¥–∞–ª—è–µ–º backdrop
                        const backdrop = document.querySelector('.modal-backdrop');
                        if (backdrop) {
                            backdrop.remove();
                        }
                    });
                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞ –∑–∞–∫—Ä—ã—Ç–∏—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞:', error);
                }
            },
            
            formatDateTime(date) {
                if (!date) return '';
                try {
                    return new Date(date).toLocaleString('ru-RU', {
                        year: 'numeric',
                        month: 'long',
                        day: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit'
                    });
                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –¥–∞—Ç—ã:', error);
                    return String(date);
                }
            },
            
            getEventTypeLabel(type) {
                const labels = {
                    'visit': '–û—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–π –≤–∏–∑–∏—Ç',
                    'student_visit': '–°—Ç—É–¥–µ–Ω—á–µ—Å–∫–∏–π –≤–∏–∑–∏—Ç',
                    'group_visit': '–ì—Ä—É–ø–ø–æ–≤–æ–µ –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏–µ',
                    'classroom_booking': '–ë—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∞—É–¥–∏—Ç–æ—Ä–∏–∏'
                };
                return labels[type] || '–°–æ–±—ã—Ç–∏–µ';
            },
            
            getStatusLabel(status) {
                const labels = {
                    'PENDING': '–û–∂–∏–¥–∞–µ—Ç',
                    'WAITING_FOR_APPROVAL': '–û–∂–∏–¥–∞–µ—Ç –æ–¥–æ–±—Ä–µ–Ω–∏—è',
                    'CHECKED_IN': '–í –∑–¥–∞–Ω–∏–∏',
                    'ISSUED': '–í—ã–¥–∞–Ω',
                    'APPROVED': '–û–¥–æ–±—Ä–µ–Ω',
                    'CANCELLED': '–û—Ç–º–µ–Ω–µ–Ω',
                    'REJECTED': '–û—Ç–∫–ª–æ–Ω–µ–Ω',
                    'EXPIRED': '–ü—Ä–æ—Å—Ä–æ—á–µ–Ω',
                    'COMPLETED': '–ó–∞–≤–µ—Ä—à–µ–Ω',
                    'RETURNED': '–í–æ–∑–≤—Ä–∞—â–µ–Ω',
                    'CONFIRMED': '–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω',
                    'AWAITING': '–û–∂–∏–¥–∞–µ—Ç –ø—Ä–∏–±—ã—Ç–∏—è',
                    'CHECKED_OUT': '–í—ã—à–µ–ª',
                    'reserved': '–ó–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–æ',
                    'issued': '–ö–ª—é—á –≤—ã–¥–∞–Ω',
                    'returned': '–ö–ª—é—á –≤–æ–∑–≤—Ä–∞—â–µ–Ω',
                    'expired': '–ü—Ä–æ—Å—Ä–æ—á–µ–Ω–æ',
                    'cancelled': '–û—Ç–º–µ–Ω–µ–Ω–æ'
                };
                return labels[status] || status;
            }
        }
    }
    
    console.log('–§—É–Ω–∫—Ü–∏—è calendarApp –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∞:', typeof window.calendarApp);
}

// –ù–µ—Å–∫–æ–ª—å–∫–æ —Å–ø–æ—Å–æ–±–æ–≤ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –¥–ª—è –æ–±–µ—Å–ø–µ—á–µ–Ω–∏—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏
document.addEventListener('alpine:init', function() {
    console.log('Alpine:init —Å–æ–±—ã—Ç–∏–µ');
    initCalendarApp();
});

document.addEventListener('DOMContentLoaded', function() {
    console.log('DOMContentLoaded —Å–æ–±—ã—Ç–∏–µ');
    // –ó–∞–¥–µ—Ä–∂–∫–∞ –¥–ª—è —Å–ª—É—á–∞–µ–≤, –∫–æ–≥–¥–∞ Alpine.js —É–∂–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω
    setTimeout(initCalendarApp, 100);
});

// –ï—Å–ª–∏ Alpine.js —É–∂–µ –∑–∞–≥—Ä—É–∂–µ–Ω
if (window.Alpine) {
    console.log('Alpine.js —É–∂–µ –¥–æ—Å—Ç—É–ø–µ–Ω');
    initCalendarApp();
}

// –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —á–µ—Ä–µ–∑ 1 —Å–µ–∫—É–Ω–¥—É
setTimeout(function() {
    if (!window.calendarApp) {
        console.log('–ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è calendarApp');
        initCalendarApp();
    }
}, 1000);
</script>
{% endblock %}
