{% extends "base.html" %}
{% load static %}
{% load iin_filters %}

{% block title %}История визитов{% endblock %}

{% block extra_head %}   
{% endblock %}

{% block content %}    

{% if page_obj.object_list %}
{# --- Пагинация --- #}
<div class="card" x-data="VisitHistory()">
   <div class="card-table">
      <div class="card-header">
         <div class="row w-full">
            <div class="col">
               <h3 class="card-title mb-0">
                  Посетители
                  
               </h3>
               {% comment %}
                  <p class="text-secondary m-0">
                     
                  </p>
               {% endcomment %}
            </div>
            <div class="col-md-auto col-sm-12">
               <div class="ms-auto d-flex flex-wrap btn-list">
                  <div class="input-group input-group-flat w-auto">
                     <span class="input-group-text">
                        <!-- Download SVG icon from http://tabler.io/icons/icon/search -->
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-1">
                           <path d="M10 10m-7 0a7 7 0 1 0 14 0a7 7 0 1 0 -14 0" />
                           <path d="M21 21l-6 -6" />
                         </span>
                                <input id="advanced-table-search" type="text" name="search" class="form-control" autocomplete="off" placeholder="Поиск" 
                                hx-get="{% url 'visit_history' %}" 
                                hx-trigger="keyup changed delay:500ms" 
                                hx-target="#advanced-table" 
                                hx-push-url="true" hx-preserve="true"
                                hx-include="[name='status'], [name='visit_type'], [name='per_page']"
                                value="{{ request.GET.search|default:'' }}">
                         <span class="input-group-text">
                            <kbd>Поиск</kbd>
                         </span>
                  </div>
                  {% comment %}
                     <a class="btn btn-icon" aria-label="Button">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-1">
                           <path d="M12 5v14m7-7H5"></path>
                        </svg>
   						</a>
                  {% endcomment %}
                        <a id="filter-selected-btn" class="btn btn-outline-primary ms-2" data-bs-toggle="tooltip" data-bs-placement="top" title="Показать только отмеченные записи" @click.prevent="toggleFilterSelected()">
                     <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-tabler icons-tabler-outline icon-tabler-filter">
                        <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
                        <path d="M4 4h16v2.172a2 2 0 0 1 -.586 1.414l-4.414 4.414v7l-6 2v-9l-4.414 -4.414a2 2 0 0 1 -.586 -1.414v-2.172z" />
                     </svg>
                            <span class="btn-text" x-text="filterSelected ? 'Сбросить отметки' : 'Показать отмеченных'"></span>
                  </a>                  <div class="dropdown">
                    <a href="#" class="btn dropdown-toggle" data-bs-toggle="dropdown">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-tabler icons-tabler-outline icon-tabler-circle-check"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M12 12m-9 0a9 9 0 1 0 18 0a9 9 0 1 0 -18 0" /><path d="M9 12l2 2l4 -4" /></svg>
                        Статусы
                    </a>
                     
                    <div class="dropdown-menu">
                        <a class="dropdown-item {% if not request.GET.status %}active{% endif %}" href="#"
                           hx-get="{% url 'visit_history' %}"
                           hx-vals='{"search": "{{ request.GET.search|default:"" }}", "visit_type": "{{ request.GET.visit_type|default:"" }}", "per_page": "{{ request.GET.per_page|default:"" }}"}'
                           hx-target="#advanced-table" hx-push-url="true">
                            Все статусы
                        </a>
                        <div class="dropdown-divider"></div>
                        <a class="dropdown-item {% if request.GET.status == 'AWAITING' %}active{% endif %}" href="#"
                           hx-get="{% url 'visit_history' %}"
                           hx-vals='{"status": "AWAITING", "search": "{{ request.GET.search|default:"" }}", "visit_type": "{{ request.GET.visit_type|default:"" }}", "per_page": "{{ request.GET.per_page|default:"" }}"}'
                           hx-target="#advanced-table" hx-push-url="true">
                            <span class="badge bg-purple-lt">Ожидается</span>
                        </a>
                        <a class="dropdown-item {% if request.GET.status == 'CHECKED_IN' %}active{% endif %}" href="#"
                           hx-get="{% url 'visit_history' %}"
                           hx-vals='{"status": "CHECKED_IN", "search": "{{ request.GET.search|default:"" }}", "visit_type": "{{ request.GET.visit_type|default:"" }}", "per_page": "{{ request.GET.per_page|default:"" }}"}'
                           hx-target="#advanced-table" hx-push-url="true">
                            <span class="badge bg-success-lt">В здании</span>
                        </a>
                        <a class="dropdown-item {% if request.GET.status == 'CHECKED_OUT' %}active{% endif %}" href="#"
                           hx-get="{% url 'visit_history' %}"
                           hx-vals='{"status": "CHECKED_OUT", "search": "{{ request.GET.search|default:"" }}", "visit_type": "{{ request.GET.visit_type|default:"" }}", "per_page": "{{ request.GET.per_page|default:"" }}"}'
                           hx-target="#advanced-table" hx-push-url="true">
                            <span class="badge bg-secondary-lt">Покинул</span>
                        </a>
                        <a class="dropdown-item {% if request.GET.status == 'CANCELLED' %}active{% endif %}" href="#"
                           hx-get="{% url 'visit_history' %}"
                           hx-vals='{"status": "CANCELLED", "search": "{{ request.GET.search|default:"" }}", "visit_type": "{{ request.GET.visit_type|default:"" }}", "per_page": "{{ request.GET.per_page|default:"" }}"}'
                           hx-target="#advanced-table" hx-push-url="true">
                            <span class="badge bg-danger-lt">Отменен</span>
                        </a>
                    </div>
                  </div>
                  
                  <div class="dropdown ms-2">
                    <a href="#" class="btn dropdown-toggle" data-bs-toggle="dropdown">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-tabler icons-tabler-outline icon-tabler-users-group"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M10 13a2 2 0 1 0 4 0a2 2 0 0 0 -4 0" /><path d="M8 21v-1a2 2 0 0 1 2 -2h4a2 2 0 0 1 2 2v1" /><path d="M15 5a2 2 0 1 0 4 0a2 2 0 0 0 -4 0" /><path d="M17 10h2a2 2 0 0 1 2 2v1" /><path d="M5 5a2 2 0 1 0 4 0a2 2 0 0 0 -4 0" /><path d="M3 13v-1a2 2 0 0 1 2 -2h2" /></svg>
                        Тип визита
                    </a>
                     
                    <div class="dropdown-menu">
                        <a class="dropdown-item {% if not request.GET.visit_type %}active{% endif %}" href="#"
                           hx-get="{% url 'visit_history' %}"
                           hx-vals='{"status": "{{ request.GET.status|default:"" }}", "search": "{{ request.GET.search|default:"" }}", "per_page": "{{ request.GET.per_page|default:"" }}"}'
                           hx-target="#advanced-table" hx-push-url="true">
                            Все типы
                        </a>
                        <div class="dropdown-divider"></div>
                        <a class="dropdown-item {% if request.GET.visit_type == 'official' %}active{% endif %}" href="#"
                           hx-get="{% url 'visit_history' %}"
                           hx-vals='{"visit_type": "official", "status": "{{ request.GET.status|default:"" }}", "search": "{{ request.GET.search|default:"" }}", "per_page": "{{ request.GET.per_page|default:"" }}"}'
                           hx-target="#advanced-table" hx-push-url="true">
                            <span class="badge bg-blue-lt">Официальный визит</span>
                        </a>
                        <a class="dropdown-item {% if request.GET.visit_type == 'student' %}active{% endif %}" href="#"
                           hx-get="{% url 'visit_history' %}"
                           hx-vals='{"visit_type": "student", "status": "{{ request.GET.status|default:"" }}", "search": "{{ request.GET.search|default:"" }}", "per_page": "{{ request.GET.per_page|default:"" }}"}'
                           hx-target="#advanced-table" hx-push-url="true">
                            <span class="badge bg-orange-lt">Студенческий визит</span>
                        </a>
                        <a class="dropdown-item {% if request.GET.visit_type == 'group' %}active{% endif %}" href="#"
                           hx-get="{% url 'visit_history' %}"
                           hx-vals='{"visit_type": "group", "status": "{{ request.GET.status|default:"" }}", "search": "{{ request.GET.search|default:"" }}", "per_page": "{{ request.GET.per_page|default:"" }}"}'
                           hx-target="#advanced-table" hx-push-url="true">
                            <span class="badge bg-green-lt">Групповой визит</span>
                        </a>
                    </div>
                  </div>
                  {% if user.is_staff or perms.visitors.can_view_visit_statistics %}  
                  <a href="{% url 'export_visits_xlsx' %}?{{ request.GET.urlencode }}" class="btn btn-0 {% if show_filters %}ms-2{% endif %}">
                    <svg  xmlns="http://www.w3.org/2000/svg"  width="24"  height="24"  viewBox="0 0 24 24"  fill="none"  stroke="currentColor"  stroke-width="2"  stroke-linecap="round"  stroke-linejoin="round"  class="icon icon-tabler icons-tabler-outline icon-tabler-file-excel"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M14 3v4a1 1 0 0 0 1 1h4" /><path d="M17 21h-10a2 2 0 0 1 -2 -2v-14a2 2 0 0 1 2 -2h7l5 5v11a2 2 0 0 1 -2 2" /><path d="M10 12l4 5" /><path d="M10 17l4 -5" /></svg>                   
                        Экспорт в Excel
                    </a>
                    {% endif %}
                  </a>
               </div>
            </div>
         </div>
      </div>
      {% include 'visitors/_visit_table_block.html' %}
   </div>
</div>
<!-- END PAGE BODY -->
{% else %}

<div class="card">
   <div class="card-body empty-state">
      <div class="empty-state-icon">
         <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon">
            <circle cx="12" cy="12" r="10"></circle>
            <line x1="8" y1="12" x2="16" y2="12"></line>
         </svg>
      </div>
      
      {% if request.GET.status %}
         <h3 class="empty-state-title">Нет визитов со статусом "{{ request.GET.status|default:"" }}"</h3>
         <p class="empty-state-description">
            {% if request.GET.status == 'AWAITING' %}
               На данный момент нет ожидающих визитов.
            {% elif request.GET.status == 'CHECKED_IN' %}
               На данный момент нет посетителей, находящихся в здании.
            {% elif request.GET.status == 'CHECKED_OUT' %}
               На данный момент нет завершенных визитов.
            {% elif request.GET.status == 'CANCELLED' %}
               На данный момент нет отмененных визитов.
            {% else %}
               По вашему запросу ничего не найдено.
            {% endif %}
         </p>
         <div class="mt-4">
            <a href="{% url 'visit_history' %}" class="btn btn-primary">
               <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon me-2">
                  <path d="M9 14l-5-5 5-5"></path>
                  <path d="M20 20v-7a4 4 0 0 0-4-4H4"></path>
               </svg>
               Вернуться ко всем визитам
            </a>
         </div>
      {% elif request.GET %}
         <h3 class="empty-state-title">По вашему запросу ничего не найдено</h3>
         <p class="empty-state-description">
            Попробуйте изменить параметры поиска или фильтрации.
         </p>
         <div class="mt-4">
            <a href="{% url 'visit_history' %}" class="btn btn-primary">
               <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon me-2">
                  <path d="M9 14l-5-5 5-5"></path>
                  <path d="M20 20v-7a4 4 0 0 0-4-4H4"></path>
               </svg>
               Сбросить все фильтры
            </a>
         </div>
      {% else %}
         <h3 class="empty-state-title">История визитов пуста</h3>
         <p class="empty-state-description">
            В данный момент в системе нет зарегистрированных визитов.
         </p>
         <div class="mt-4">
            <a href="{% url 'employee_dashboard' %}" class="btn btn-primary">
               <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon me-2">
                  <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
                  <polyline points="9 22 9 12 15 12 15 22"></polyline>
               </svg>
               Вернуться на главную
            </a>
         </div>
      {% endif %}
   </div>
</div>
{% endif %}

{% endblock %}


{% block extra_scripts %}
<script>
function setPageListItems(event) {
    event.preventDefault();
    const value = event.target.getAttribute('data-value');
    
    // Get current URL and parameters
    const url = new URL(window.location.href);
    const params = new URLSearchParams(url.search);
    
    // Update or add the per_page parameter
    params.set('per_page', value);
    // Reset to first page when changing items per page
    if (params.has('page')) {
        params.set('page', '1');
    }
    
    // Handle filter_params_url
    if ('{{ filter_params_url }}') {
        const filterParams = new URLSearchParams('{{ filter_params_url }}');
        filterParams.forEach((value, key) => {
            if (key !== 'per_page' && key !== 'page') {
                params.set(key, value);
            }
        });
    }
    
    // Update URL and reload page
    url.search = params.toString();
    try { localStorage.setItem('visitHistory_per_page', value); } catch (e) {}
    window.location.href = url.toString();
}

// Функция для сортировки таблицы
document.addEventListener('DOMContentLoaded', function() {    const getCellValue = (tr, idx) => {
        // Пропускаем первую колонку (пустая ячейка с чекбоксом)
        const actualIdx = idx;
        const cell = tr.children[actualIdx];
        
        if (!cell) return '';
        
        // Получаем текст из ячейки, игнорируя скрытые элементы
        let text = '';
        // Для дат, ищем конкретный формат даты в ячейке
        if (actualIdx === 4 || actualIdx === 5) { // колонки дат
            // Ищем прямые текстовые узлы с датами
            const nodeIterator = document.createNodeIterator(cell, NodeFilter.SHOW_TEXT);
            let node;
            while (node = nodeIterator.nextNode()) {
                const content = node.textContent.trim();
                if (/^\d{4}-\d{2}-\d{2}\s\d{2}:\d{2}$/.test(content)) {
                    return content;
                }
            }
            // Если дата не найдена, используем весь текст ячейки
            text = cell.textContent.trim();
        } else {
            // Для остальных ячеек просто берем весь текстовый контент
            text = cell.textContent.trim();
        }
        
        return text;
    };

    const comparer = (idx, asc) => (a, b) => {
        // Получаем значения для сравнения
        const v1 = getCellValue(asc ? a : b, idx);
        const v2 = getCellValue(asc ? b : a, idx);
        
        // Проверяем, содержит ли ячейка дату и время
        const datePattern = /^\d{4}-\d{2}-\d{2}\s\d{2}:\d{2}$/;
        if (datePattern.test(v1) && datePattern.test(v2)) {
            // Сортировка по дате
            return new Date(v1) - new Date(v2);
        } else if (idx === 4 || idx === 5) {
            // Для колонок дат, если нет точного формата, но есть статусы
            // Сортируем строки по присутствию статусов
            const statusOrder = {
                'В здании': 2,
                'Ожидается': 1,
                'Отменен': 0,
                '-': -1
            };
            
            // Определяем статус из строк
            const getStatus = (str) => {
                if (str.includes('В здании')) return 'В здании';
                if (str.includes('Ожидается')) return 'Ожидается';
                if (str.includes('Отменен')) return 'Отменен';
                return '-';
            };
            
            const status1 = getStatus(v1);
            const status2 = getStatus(v2);
            
            return statusOrder[status1] - statusOrder[status2];
        } else {
            // Обычная сортировка по тексту
            return v1 !== '' && v2 !== '' && !isNaN(v1) && !isNaN(v2) 
                ? parseFloat(v1) - parseFloat(v2) 
                : v1.toString().localeCompare(v2.toString());
        }
    };    // Добавляем обработчики к заголовкам таблицы
    document.querySelectorAll('.table-sort').forEach(th => {
        th.addEventListener('click', function() {
            const table = th.closest('table');
            const tbody = table.querySelector('tbody');
            // Находим индекс столбца для сортировки (учитывая возможные nested элементы)
            const thParent = th.closest('th');
            const thIndex = Array.from(thParent.parentNode.children).indexOf(thParent);
            
            // Если уже есть стрелка, меняем направление сортировки
            let sortDirection = this.classList.contains('sorted-asc') ? false : true;
            
            // Удаляем классы сортировки у всех заголовков и кнопок
            table.querySelectorAll('th button.table-sort').forEach(el => {
                el.classList.remove('sorted-asc', 'sorted-desc');
            });
            
            // Добавляем класс сортировки текущему заголовку
            this.classList.add(sortDirection ? 'sorted-asc' : 'sorted-desc');
            
            // Сортируем строки
            Array.from(tbody.querySelectorAll('tr'))
                .sort(comparer(thIndex, sortDirection))
                .forEach(tr => tbody.appendChild(tr));
        });
    });
});

// Функции для сохранения и восстановления состояния чекбоксов
function saveCheckboxStates() {
    const states = {};
    document.querySelectorAll('.table-selectable-check').forEach((checkbox, index) => {
        const row = checkbox.closest('tr');
        const visitId = row.querySelector('form')?.action.match(/(\d+)\/$/)?.[1];
        if (visitId) {
            states[visitId] = checkbox.checked;
        }
    });
    localStorage.setItem('visitHistory_checkboxStates', JSON.stringify(states));
}

function restoreCheckboxStates() {
    try {
        // Получаем выбранные элементы из URL параметров
        const urlParams = new URLSearchParams(window.location.search);
        const selectedFromUrl = urlParams.get('selected');
        const hasStatusFilter = urlParams.has('status');
        
        // Сначала очищаем все чекбоксы
        document.querySelectorAll('.table-selectable-check').forEach(checkbox => {
            checkbox.checked = false;
        });
        
        if (selectedFromUrl) {
            // Восстанавливаем из URL параметров
            const selectedIds = selectedFromUrl.split(',');
            document.querySelectorAll('.table-selectable-check').forEach(checkbox => {
                const row = checkbox.closest('tr');
                const visitId = row.querySelector('form')?.action.match(/(\d+)\/$/)?.[1];
                if (visitId && selectedIds.includes(visitId)) {
                    checkbox.checked = true;
                }
            });
        } else {
            // Если нет параметра selected в URL, очищаем localStorage
            localStorage.removeItem('visitHistory_checkboxStates');
            
            // Если нет фильтра статуса или это была команда "Все статусы" (сброс фильтра),
            // убедимся, что все чекбоксы сброшены
            if (!hasStatusFilter) {
                clearAllSelections();
            }
        }
    } catch (e) {
        console.warn('Ошибка при восстановлении состояний чекбоксов:', e);
    }
}

function getSelectedVisitIds() {
    const selected = [];
    document.querySelectorAll('.table-selectable-check:checked').forEach(checkbox => {
        const row = checkbox.closest('tr');
        const visitId = row.querySelector('form')?.action.match(/(\d+)\/$/)?.[1];
        if (visitId) {
            selected.push(visitId);
        }
    });
    return selected;
}

function clearAllSelections() {
    // Очищаем все чекбоксы
    document.querySelectorAll('.table-selectable-check').forEach(checkbox => {
        checkbox.checked = false;
    });
    
    // Очищаем localStorage
    localStorage.removeItem('visitHistory_checkboxStates');
    
    // Сбрасываем фильтр "Показать отмеченных"
    const filterBtn = document.getElementById('filter-selected-btn');
    if (filterBtn) {
        filterSelectedActive = false;
        document.querySelectorAll('.table-tbody tr').forEach(row => {
            row.style.display = '';
        });
        filterBtn.querySelector('.btn-text').textContent = 'Показать отмеченных';
    }
}

function updateStatusFilterLinks() {
    const selectedIds = getSelectedVisitIds();
    const selectedParam = selectedIds.length > 0 ? `selected=${selectedIds.join(',')}` : '';
    
    // Получаем текущие параметры URL без selected и status
    const currentUrl = new URL(window.location);
    const currentParams = new URLSearchParams(currentUrl.search);
    currentParams.delete('selected');
    currentParams.delete('status');
    
    const otherParams = currentParams.toString();
    
    // Обновляем все ссылки фильтров статусов
    document.querySelectorAll('.dropdown-item').forEach(link => {
        const linkText = link.textContent.trim();
          if (linkText === 'Все статусы') {
            // Для ссылки "Все статусы" - создаем прямую ссылку на сброс с обязательной очисткой всех чекбоксов
            let newHref = window.location.pathname;
            if (otherParams) {
                newHref += '?' + otherParams;
            }
            
            // Заменяем обычную ссылку на JavaScript-функцию, которая очищает всё перед переходом
            link.setAttribute('href', 'javascript:void(0)');
            if (!link.hasAttribute('data-reset-listener')) {
                link.setAttribute('data-reset-listener', 'true');
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    // Очищаем все чекбоксы перед переходом
                    clearAllSelections();
                    // Удаляем данные из localStorage
                    localStorage.removeItem('visitHistory_checkboxStates');
                    // Переходим по ссылке без параметров selected и status
                    window.location.href = newHref;
                });
            }
        }else {
            // Для остальных ссылок фильтров статусов - сохраняем selected
            const href = link.getAttribute('href');
            if (href && href.includes('status=')) {
                // Извлекаем статус из href
                const statusMatch = href.match(/status=([^&]*)/);
                if (statusMatch) {
                    const status = statusMatch[1];
                    let newHref = window.location.pathname + '?status=' + status;
                    if (otherParams) newHref += '&' + otherParams;
                    if (selectedParam) newHref += '&' + selectedParam;
                    link.setAttribute('href', newHref);
                }
            }
        }
    });
}

// Filter by selected checkboxes
let filterSelectedActive = false;
// Alpine handles toggle via VisitHistory component

// Сохраняем состояние при изменении чекбоксов
document.addEventListener('change', function(e) {
    if (e.target.classList.contains('table-selectable-check')) {
        saveCheckboxStates();
        updateStatusFilterLinks();
    }
});

// Восстанавливаем состояния при загрузке страницы
document.addEventListener('DOMContentLoaded', function() {
    // Восстанавливаем per_page из localStorage, если его нет в URL
    try {
        const url = new URL(window.location.href);
        const params = new URLSearchParams(url.search);
        if (!params.has('per_page')) {
            const saved = localStorage.getItem('visitHistory_per_page');
            if (saved && ['10','20','50','100'].includes(saved)) {
                params.set('per_page', saved);
                // при добавлении per_page сбрасываем page
                if (params.has('page')) params.set('page', '1');
                url.search = params.toString();
                window.location.replace(url.toString());
                return; // прерываем дальнейшую инициализацию на старой странице
            }
        }
    } catch (e) {}
    // Проверяем, имеет ли URL параметр status (фильтр статуса)
    const urlParams = new URLSearchParams(window.location.search);
    const hasStatus = urlParams.has('status');
    
    // Восстанавливаем только если есть фильтр статуса или selected параметр
    if (hasStatus || urlParams.has('selected')) {
        restoreCheckboxStates();
    } else {
        // Если нет фильтра статуса и нет selected - гарантированно очищаем все выделения
        clearAllSelections();
    }
    
    updateStatusFilterLinks();
    
    // Проверяем, есть ли выбранные элементы, если нет - сбрасываем фильтр
    const selectedIds = getSelectedVisitIds();
    if (selectedIds.length === 0) {
        const filterBtn = document.getElementById('filter-selected-btn');
        if (filterBtn) {
            filterSelectedActive = false;
            document.querySelectorAll('.table-tbody tr').forEach(row => {
                row.style.display = '';
            });
            filterBtn.querySelector('.btn-text').textContent = 'Показать отмеченных';
        }
    }
});
</script>
<script src="{% static 'js/visit-history.js' %}" defer></script>

{% endblock %}