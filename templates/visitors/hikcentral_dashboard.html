{% extends "base.html" %}
{% load static %}

{% block title %}HikCentral Dashboard{% endblock %}

{% block extra_head %}
{% endblock %}

{% block content %}
<div class="page-wrapper">
    <div class="page-header d-print-none">
        <div class="container-xl">
            <div class="row g-2 align-items-center">
                <div class="col">
                    <h2 class="page-title">
                        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-plug-connected me-2" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M7 12l5 5l-1.5 1.5a3.536 3.536 0 1 1 -5 -5l1.5 -1.5z" /><path d="M17 12l-5 -5l1.5 -1.5a3.536 3.536 0 1 1 5 5l-1.5 1.5z" /><path d="M3 21l2.5 -2.5" /><path d="M18.5 5.5l2.5 -2.5" /><path d="M10 11l-2 2" /><path d="M13 14l-2 2" /></svg>
                        HikCentral Integration
                    </h2>
                </div>
                <div class="col-auto ms-auto">
                    <div class="btn-list">
                        <!-- Export Buttons -->
                        <div class="btn-group">
                            <button type="button" class="btn btn-icon btn-outline-secondary dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false" title="Экспорт">
                                <svg xmlns="http://www.w3.org/2000/svg" class="icon" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M12 15v-12" /><path d="M18 9l-6 6l-6 -6" /><path d="M4 17h16" /><path d="M4 20h16" /></svg>
                            </button>
                            <ul class="dropdown-menu dropdown-menu-end">
                                <li><a class="dropdown-item" href="{% url 'export_hikcentral_pdf' %}">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="icon me-2 text-danger" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M14 3v4a1 1 0 0 0 1 1h4" /><path d="M17 21h-10a2 2 0 0 1 -2 -2v-14a2 2 0 0 1 2 -2h7l5 5v11a2 2 0 0 1 -2 2z" /><path d="M9 17h6" /><path d="M9 13h6" /></svg>
                                    Скачать PDF
                                </a></li>
                                <li><a class="dropdown-item" href="{% url 'export_hikcentral_excel' %}">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="icon me-2 text-success" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M14 3v4a1 1 0 0 0 1 1h4" /><path d="M17 21h-10a2 2 0 0 1 -2 -2v-14a2 2 0 0 1 2 -2h7l5 5v11a2 2 0 0 1 -2 2z" /><path d="M10 12l4 5" /><path d="M10 17l4 -5" /></svg>
                                    Скачать Excel
                                </a></li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="page-body">
        <div class="container-xl">
            <!-- HikCentral Servers -->
            <div class="row row-cards mb-3">
                {% if hc_servers %}
                    {% for server in hc_servers %}
                    <div class="col-md-6">
                        <div class="card {% if not server.is_available %}border-danger{% endif %}">
                            <div class="card-status-top {% if server.is_available %}bg-green{% else %}bg-red{% endif %}"></div>
                            <div class="card-body">
                                <div class="row align-items-center mb-2">
                                    <div class="col">
                                        <h3 class="card-title mb-1">
                                            <span class="status-dot status-dot-animated {% if server.is_available %}bg-green{% else %}bg-red{% endif %}"></span>
                                            {{ server.name }}
                                        </h3>
                                        <div class="text-muted small">{{ server.base_url }}</div>
                                    </div>
                                    <div class="col-auto">
                                        <span class="badge {% if server.is_available %}bg-green{% else %}bg-red{% endif %}">
                                            {% if server.is_available %}Online{% else %}Offline{% endif %}
                                        </span>
                                    </div>
                                </div>
                                <div class="mt-3">
                                    <div class="row">
                                        <div class="col-6">
                                            <div class="text-muted small">Integration Key</div>
                                            <div><code class="small">{{ server.integration_key|truncatechars:20 }}</code></div>
                                        </div>
                                        <div class="col-6">
                                            <div class="text-muted small">Status</div>
                                            <div>
                                                {% if server.is_active %}
                                                    <span class="badge bg-green-lt">Active</span>
                                                {% else %}
                                                    <span class="badge bg-secondary-lt">Inactive</span>
                                                {% endif %}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                {% else %}
                    <div class="col-12">
                        <div class="alert alert-warning">
                            <div class="d-flex">
                                <div>
                                    <svg xmlns="http://www.w3.org/2000/svg" class="icon alert-icon" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M12 9v4" /><path d="M10.363 3.591l-8.106 13.534a1.914 1.914 0 0 0 1.636 2.871h16.214a1.914 1.914 0 0 0 1.636 -2.87l-8.106 -13.536a1.914 1.914 0 0 0 -3.274 0z" /><path d="M12 16h.01" /></svg>
                                </div>
                                <div>
                                    <h4 class="alert-title">Нет настроенных HikCentral серверов</h4>
                                    <div class="text-muted">
                                        <a href="/admin/hikvision_integration/hikcentralserver/add/" target="_blank" class="alert-link">
                                            Добавить сервер
                                        </a>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                {% endif %}
            </div>

            <!-- Stats -->
            <div class="row row-deck row-cards mb-3">
                <div class="col-sm-6 col-lg-3">
                    <div class="card">
                        <div class="card-body">
                            <div class="d-flex align-items-center">
                                <div class="subheader">Визитов с HikCentral</div>
                                <div class="ms-auto lh-1">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="icon text-blue" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M3 12m-1 0a1 1 0 1 0 2 0a1 1 0 1 0 -2 0" /><path d="M12 12m-1 0a1 1 0 1 0 2 0a1 1 0 1 0 -2 0" /><path d="M21 12m-1 0a1 1 0 1 0 2 0a1 1 0 1 0 -2 0" /></svg>
                                </div>
                            </div>
                            <div class="h1 mb-0 mt-1">{{ total_with_hc }}</div>
                        </div>
                    </div>
                </div>
                <div class="col-sm-6 col-lg-3">
                    <div class="card">
                        <div class="card-body">
                            <div class="d-flex align-items-center">
                                <div class="subheader">Активных с доступом</div>
                                <div class="ms-auto lh-1">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="icon text-purple" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M5 11m0 2a2 2 0 0 1 2 -2h10a2 2 0 0 1 2 2v6a2 2 0 0 1 -2 2h-10a2 2 0 0 1 -2 -2z" /><path d="M12 16m-1 0a1 1 0 1 0 2 0a1 1 0 1 0 -2 0" /><path d="M8 11v-5a4 4 0 0 1 8 0" /></svg>
                                </div>
                            </div>
                            <div class="h1 mb-0 mt-1">{{ active_with_access }}</div>
                        </div>
                    </div>
                </div>
                <div class="col-sm-6 col-lg-3">
                    <div class="card">
                        <div class="card-body">
                            <div class="d-flex align-items-center">
                                <div class="subheader">Auto Check-ins</div>
                                <div class="ms-auto lh-1">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="icon text-green" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M5 12l5 5l10 -10" /></svg>
                                </div>
                            </div>
                            <div class="h1 mb-0 mt-1">{{ auto_checkedin }}</div>
                        </div>
                    </div>
                </div>
                <div class="col-sm-6 col-lg-3">
                    <div class="card">
                        <div class="card-body">
                            <div class="d-flex align-items-center">
                                <div class="subheader">Auto Checkouts</div>
                                <div class="ms-auto lh-1">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="icon text-red" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M14 8v-2a2 2 0 0 0 -2 -2h-7a2 2 0 0 0 -2 2v12a2 2 0 0 0 2 2h7a2 2 0 0 0 2 -2v-2" /><path d="M9 12h12l-3 -3" /><path d="M18 15l3 -3" /></svg>
                                </div>
                            </div>
                            <div class="h1 mb-0 mt-1">{{ auto_checkedout }}</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Rate Limiter Status -->
            {% if rate_limit_status %}
            <div class="row row-cards mb-3">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">
                                <svg xmlns="http://www.w3.org/2000/svg" class="icon me-2" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M12 12m-9 0a9 9 0 1 0 18 0a9 9 0 1 0 -18 0" /><path d="M12 7l0 5l3 3" /></svg>
                                Rate Limiter Status
                            </h3>
                        </div>
                        <div class="card-body">
                            <div class="row mb-3">
                                <div class="col-md-4">
                                    <div class="text-muted small">Лимит запросов</div>
                                    <div class="h3">{{ rate_limit_status.calls_limit }} <small class="text-muted">/ {{ rate_limit_status.window_seconds }}s</small></div>
                                </div>
                                <div class="col-md-4">
                                    <div class="text-muted small">Текущее использование</div>
                                    <div class="h3">{{ rate_limit_status.current_calls }} <small class="text-muted">/ {{ rate_limit_status.calls_limit }}</small></div>
                                </div>
                                <div class="col-md-4">
                                    <div class="text-muted small">Доступно</div>
                                    <div class="h3 text-{% if rate_limit_status.available > 5 %}green{% elif rate_limit_status.available > 2 %}yellow{% else %}red{% endif %}">
                                        {{ rate_limit_status.available }}
                                    </div>
                                </div>
                            </div>
                            <div class="progress">
                                {% widthratio rate_limit_status.current_calls rate_limit_status.calls_limit 100 as usage_percent %}
                                <div class="progress-bar {% if usage_percent > 80 %}bg-red{% elif usage_percent > 50 %}bg-yellow{% else %}bg-green{% endif %}" 
                                     style="width: {{ usage_percent }}%" 
                                     role="progressbar" 
                                     aria-valuenow="{{ usage_percent }}" 
                                     aria-valuemin="0" 
                                     aria-valuemax="100">
                                    {{ usage_percent }}%
                                </div>
                            </div>
                            <small class="text-muted d-block mt-2">Использование за текущее окно ({{ rate_limit_status.window_seconds }} сек)</small>
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- Integration Info -->
            <div class="row row-cards mb-3">
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">
                                <svg xmlns="http://www.w3.org/2000/svg" class="icon me-2" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M9 11l-4 4l4 4m-4 -4h11a4 4 0 0 0 0 -8h-1" /></svg>
                                Информация об интеграции
                            </h3>
                        </div>
                        <div class="card-body">
                            <div class="datagrid">
                                <div class="datagrid-item">
                                    <div class="datagrid-title">Автоматический Check-in</div>
                                    <div class="datagrid-content">
                                        <span class="badge bg-green-lt">Включен</span>
                                    </div>
                                </div>
                                <div class="datagrid-item">
                                    <div class="datagrid-title">Автоматический Checkout</div>
                                    <div class="datagrid-content">
                                        <span class="badge bg-green-lt">Включен</span>
                                    </div>
                                </div>
                                <div class="datagrid-item">
                                    <div class="datagrid-title">Мониторинг проходов</div>
                                    <div class="datagrid-content">
                                        <span class="badge bg-blue-lt">Каждые 5 минут</span>
                                    </div>
                                </div>
                                <div class="datagrid-item">
                                    <div class="datagrid-title">Детекция аномалий</div>
                                    <div class="datagrid-content">
                                        <span class="badge bg-green-lt">Включена</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">
                                <svg xmlns="http://www.w3.org/2000/svg" class="icon me-2" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M3 12m0 1a1 1 0 0 1 1 -1h4a1 1 0 0 1 1 1v6a1 1 0 0 1 -1 1h-4a1 1 0 0 1 -1 -1z" /><path d="M9 8m0 1a1 1 0 0 1 1 -1h4a1 1 0 0 1 1 1v10a1 1 0 0 1 -1 1h-4a1 1 0 0 1 -1 -1z" /><path d="M15 4m0 1a1 1 0 0 1 1 -1h4a1 1 0 0 1 1 1v14a1 1 0 0 1 -1 1h-4a1 1 0 0 1 -1 -1z" /><path d="M4 20l14 0" /></svg>
                                Статистика за неделю
                            </h3>
                        </div>
                        <div class="card-body">
                            <div class="datagrid">
                                <div class="datagrid-item">
                                    <div class="datagrid-title">Событий входа</div>
                                    <div class="datagrid-content">{{ avg_entry_time }}</div>
                                </div>
                                <div class="datagrid-item">
                                    <div class="datagrid-title">Визитов с Face ID</div>
                                    <div class="datagrid-content">{{ total_with_hc }}</div>
                                </div>
                                <div class="datagrid-item">
                                    <div class="datagrid-title">Активных гостей</div>
                                    <div class="datagrid-content">{{ active_with_access }}</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Recent Errors / Success -->
            <div class="row row-cards">
                <div class="col-12">
                    {% if recent_errors %}
                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title text-orange">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="icon me-2" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M12 9v4" /><path d="M10.363 3.591l-8.106 13.534a1.914 1.914 0 0 0 1.636 2.871h16.214a1.914 1.914 0 0 0 1.636 -2.87l-8.106 -13.536a1.914 1.914 0 0 0 -3.274 0z" /><path d="M12 16h.01" /></svg>
                                    Недавние ошибки
                                </h3>
                            </div>
                            <div class="list-group list-group-flush">
                                {% for error in recent_errors %}
                                <div class="list-group-item">
                                    <div class="row align-items-center">
                                        <div class="col">
                                            <strong>{{ error.message }}</strong>
                                            <div class="text-muted small mt-1">{{ error.details }}</div>
                                        </div>
                                        <div class="col-auto">
                                            <span class="text-muted small">{{ error.timestamp|date:"H:i:s" }}</span>
                                        </div>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                    {% else %}
                        <div class="card">
                            <div class="card-body">
                                <div class="empty">
                                    <div class="empty-icon text-green">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="icon" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M5 12l5 5l10 -10" /></svg>
                                    </div>
                                    <p class="empty-title">Система работает стабильно</p>
                                    <p class="empty-subtitle text-muted">Ошибок интеграции не обнаружено</p>
                                </div>
                            </div>
                        </div>
                    {% endif %}
                </div>
            </div>

            <!-- Quick Actions -->
            <div class="row row-cards mt-3">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">
                                <svg xmlns="http://www.w3.org/2000/svg" class="icon me-2" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M13 3l0 7l6 0l-8 11l0 -7l-6 0l8 -11" /></svg>
                                Быстрые действия
                            </h3>
                        </div>
                        <div class="card-body">
                            <div class="btn-list">
                                <a href="/admin/hikvision_integration/hikcentralserver/" target="_blank" class="btn btn-primary">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="icon me-1" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M3 12h1m8 -9v1m8 8h1m-15.4 -6.4l.7 .7m12.1 -.7l-.7 .7" /><path d="M9 16a5 5 0 1 1 6 0a3.5 3.5 0 0 0 -1 3a2 2 0 0 1 -4 0a3.5 3.5 0 0 0 -1 -3" /><path d="M9.7 17l4.6 0" /></svg>
                                    Управление серверами
                                </a>
                                <a href="{% url 'auto_checkin_dashboard' %}" class="btn btn-success">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="icon me-1" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M5 12l5 5l10 -10" /></svg>
                                    Автоматические действия
                                </a>
                                <a href="{% url 'security_incidents_dashboard' %}" class="btn btn-danger">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="icon me-1" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M12 9v4" /><path d="M10.363 3.591l-8.106 13.534a1.914 1.914 0 0 0 1.636 2.871h16.214a1.914 1.914 0 0 0 1.636 -2.87l-8.106 -13.536a1.914 1.914 0 0 0 -3.274 0z" /><path d="M12 16h.01" /></svg>
                                    Security Incidents
                                </a>
                                <a href="/admin/visitors/visit/?access_granted__exact=1" target="_blank" class="btn btn-info">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="icon me-1" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M8 7a4 4 0 1 0 8 0a4 4 0 0 0 -8 0" /><path d="M6 21v-2a4 4 0 0 1 4 -4h4a4 4 0 0 1 4 4v2" /></svg>
                                    Визиты с доступом
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

