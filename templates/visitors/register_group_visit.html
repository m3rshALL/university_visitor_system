{% extends "base.html" %}
{% load static %}

{% block title %}{{ title }}{% endblock %}

{% block content %}
<div class="container-xl">
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">
                        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-users-group me-1" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                            <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
                            <circle cx="9" cy="7" r="4"></circle>
                            <path d="M17 11v-1a4 4 0 1 0-8 0v1"></path>
                            <path d="M3 21v-2a4 4 0 0 1 4-4h6a4 4 0 0 1 4 4v2"></path>
                        </svg>
                        {{ title }}
                    </h3>
                </div>
                <div class="card-body">
                    <form method="post" id="groupVisitForm">
                        {% csrf_token %}
                        
                        {% if messages %}
                        <div class="alert alert-danger">
                            {% for message in messages %}
                                {{ message }}
                            {% endfor %}
                        </div>
                        {% endif %}

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="{{ form.group_name.id_for_label }}" class="form-label required">{{ form.group_name.label }}:</label>
                                {{ form.group_name }}
                                {% if form.group_name.errors %}
                                    <div class="invalid-feedback d-block">
                                        {% for error in form.group_name.errors %}{{ error }}{% endfor %}
                                    </div>
                                {% endif %}
                                {% if form.group_name.help_text %}
                                    <div class="form-text">{{ form.group_name.help_text }}</div>
                                {% endif %}
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="{{ form.department.id_for_label }}" class="form-label required">{{ form.department.label }}:</label>
                                {{ form.department }}
                                {% if form.department.errors %}
                                    <div class="invalid-feedback d-block">
                                        {% for error in form.department.errors %}{{ error }}{% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="{{ form.employee.id_for_label }}" class="form-label required">{{ form.employee.label }}:</label>
                                {{ form.employee }}
                                {% if form.employee.errors %}
                                    <div class="invalid-feedback d-block">
                                        {% for error in form.employee.errors %}{{ error }}{% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="{{ form.purpose.id_for_label }}" class="form-label required">{{ form.purpose.label }}:</label>
                                {{ form.purpose }}
                                {% if form.purpose.errors %}
                                    <div class="invalid-feedback d-block">
                                        {% for error in form.purpose.errors %}{{ error }}{% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="{{ form.expected_entry_time.id_for_label }}" class="form-label">{{ form.expected_entry_time.label }}:</label>
                                {{ form.expected_entry_time }}
                                {% if form.expected_entry_time.errors %}
                                    <div class="invalid-feedback d-block">
                                        {% for error in form.expected_entry_time.errors %}{{ error }}{% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-12 mb-3">
                                <label for="{{ form.purpose_other_text.id_for_label }}" class="form-label">{{ form.purpose_other_text.label }}:</label>
                                {{ form.purpose_other_text }}
                                {% if form.purpose_other_text.errors %}
                                    <div class="invalid-feedback d-block">
                                        {% for error in form.purpose_other_text.errors %}{{ error }}{% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-12 mb-3">
                                <label for="{{ form.notes.id_for_label }}" class="form-label">{{ form.notes.label }}:</label>
                                {{ form.notes }}
                                {% if form.notes.errors %}
                                    <div class="invalid-feedback d-block">
                                        {% for error in form.notes.errors %}{{ error }}{% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-12">
                                <div class="card">
                                    <div class="card-header">
                                        <h3 class="card-title">Список гостей</h3>
                                        <div class="card-actions">
                                            <button type="button" class="btn btn-primary btn-sm" id="addGuestBtn">
                                                <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-plus" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                                                    <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
                                                    <path d="M12 5l0 14"></path>
                                                    <path d="M5 12l14 0"></path>
                                                </svg>
                                                Добавить гостя
                                            </button>
                                        </div>
                                    </div>
                                    <div class="card-body">
                                        <div id="guestsList"></div>
                                        {{ form.guests }}
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="row mt-3">
                            <div class="col-12">
                                <button type="submit" class="btn btn-primary">Зарегистрировать групповой визит</button>
                                <a href="{% url 'employee_dashboard' %}" class="btn btn-link">Отмена</a>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const guestsList = document.getElementById('guestsList');
    const addGuestBtn = document.getElementById('addGuestBtn');
    const guestsInput = document.getElementById('id_guests');
    const purposeSelect = document.getElementById('id_purpose');
    const purposeOtherText = document.getElementById('id_purpose_other_text').closest('.row');
    let guests = [];

    // Скрываем поле "Уточнение цели" по умолчанию
    purposeOtherText.style.display = 'none';

    // Показываем/скрываем поле "Уточнение цели" при изменении цели
    purposeSelect.addEventListener('change', function() {
        const selectedOption = this.options[this.selectedIndex];
        purposeOtherText.style.display = selectedOption.textContent === 'Другое' ? 'block' : 'none';
    });

    // Шаблон для гостя
    function getGuestTemplate(index) {
        return `
            <div class="guest-entry card mb-3" data-index="${index}">
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label required">ФИО гостя:</label>
                            <input type="text" class="form-control guest-full-name" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Email:</label>
                            <input type="email" class="form-control guest-email">
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Телефон:</label>
                            <input type="tel" class="form-control guest-phone">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">ИИН:</label>
                            <input type="text" class="form-control guest-iin">
                        </div>
                    </div>
                    <button type="button" class="btn btn-danger btn-sm remove-guest">
                        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-trash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                            <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
                            <path d="M4 7l16 0"></path>
                            <path d="M10 11l0 6"></path>
                            <path d="M14 11l0 6"></path>
                            <path d="M5 7l1 12a2 2 0 0 0 2 2h8a2 2 0 0 0 2 -2l1 -12"></path>
                            <path d="M9 7v-3a1 1 0 0 1 1 -1h4a1 1 0 0 1 1 1v3"></path>
                        </svg>
                        Удалить гостя
                    </button>
                </div>
            </div>
        `;
    }

    // Добавление гостя
    function addGuest() {
        const index = guests.length;
        guestsList.insertAdjacentHTML('beforeend', getGuestTemplate(index));
        guests.push({
            full_name: '',
            email: '',
            phone_number: '',
            iin: ''
        });
        updateGuestsInput();
    }

    // Удаление гостя
    function removeGuest(index) {
        const guestEntry = document.querySelector(`.guest-entry[data-index="${index}"]`);
        if (guestEntry) {
            guestEntry.remove();
            guests.splice(index, 1);
            // Обновляем индексы оставшихся гостей
            document.querySelectorAll('.guest-entry').forEach((entry, i) => {
                entry.dataset.index = i;
            });
            updateGuestsInput();
        }
    }

    // Обновление данных гостя
    function updateGuestData(index, field, value) {
        if (guests[index]) {
            guests[index][field] = value;
            updateGuestsInput();
        }
    }

    // Обновление скрытого поля с данными гостей
    function updateGuestsInput() {
        guestsInput.value = JSON.stringify(guests);
    }

    // Обработчики событий
    addGuestBtn.addEventListener('click', addGuest);

    guestsList.addEventListener('input', function(e) {
        const guestEntry = e.target.closest('.guest-entry');
        if (guestEntry) {
            const index = parseInt(guestEntry.dataset.index);
            if (e.target.classList.contains('guest-full-name')) {
                updateGuestData(index, 'full_name', e.target.value);
            } else if (e.target.classList.contains('guest-email')) {
                updateGuestData(index, 'email', e.target.value);
            } else if (e.target.classList.contains('guest-phone')) {
                updateGuestData(index, 'phone_number', e.target.value);
            } else if (e.target.classList.contains('guest-iin')) {
                updateGuestData(index, 'iin', e.target.value);
            }
        }
    });

    guestsList.addEventListener('click', function(e) {
        if (e.target.closest('.remove-guest')) {
            const guestEntry = e.target.closest('.guest-entry');
            const index = parseInt(guestEntry.dataset.index);
            removeGuest(index);
        }
    });

    // Добавляем первого гостя при загрузке страницы
    addGuest();
});
</script>
{% endblock %}
{% endblock %} 