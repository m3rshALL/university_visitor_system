{% extends "base.html" %}
{% load static %}

{% block title %}{{ page_title|default:"Регистрация группы" }}{% endblock %}

{% block extra_head %}
    {{ visit_group_form.media.css }}
    {{ member_formset.media.css }}
    <style>
        .formset-member {
            padding: 15px;
            margin-bottom: 15px;
            border: 1px solid #eee;
            border-radius: 5px;
            background-color: #f9f9f9;
        }
        .formset-member h5 { margin-top: 0; }
    </style>
{% endblock %}

{% block content %}
<h2>{{ page_title|default:"Регистрация группового визита" }}</h2>
<hr>

{% if messages %}
    {% for message in messages %}
        <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
            {{ message }}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    {% endfor %}
{% endif %}

<form method="post" novalidate>
    {% csrf_token %}

    <div class="card mb-4">
        <div class="card-header">Общая информация о группе</div>
        <div class="card-body">
            {{ visit_group_form.management_form }} {# Если бы это был ModelFormSet #}
            {% for field in visit_group_form %}
                <div class="mb-3">
                    <label for="{{ field.id_for_label }}" class="form-label">{{ field.label }}:</label>
                    {{ field }}
                    {% if field.help_text %}<div class="form-text">{{ field.help_text }}</div>{% endif %}
                    {% if field.errors %}<div class="invalid-feedback d-block">{% for error in field.errors %}{{ error }}{% endfor %}</div>{% endif %}
                </div>
            {% endfor %}
        </div>
    </div>

    <div class="card mb-4">
        <div class="card-header">Участники группы</div>
        <div class="card-body" id="member-forms-container">
            {{ member_formset.management_form }}
            {% for form in member_formset %}
                <div class="formset-member" id="member-{{ forloop.counter0 }}">
                    <h5>Участник #{{ forloop.counter }}</h5>
                    {% for field in form %}
                        <div class="mb-3">
                            <label for="{{ field.id_for_label }}" class="form-label">{{ field.label }}:</label>
                            {{ field }}
                            {% if field.help_text %}<div class="form-text">{{ field.help_text }}</div>{% endif %}
                            {% if field.errors %}<div class="invalid-feedback d-block">{% for error in field.errors %}{{ error }}{% endfor %}</div>{% endif %}
                        </div>
                    {% endfor %}
                </div>
            {% endfor %}
            <button type="button" id="add-member-form" class="btn btn-outline-success btn-sm mt-2">Добавить участника</button>
            {# Скрытый шаблон для новой формы участника #}
            <div id="empty-member-form" style="display: none;">
                {{ member_formset.empty_form.as_p }} {# Используем as_p для простоты, можно кастомизировать #}
            </div>

        </div>
    </div>

    <div class="mt-4 mb-5">
        <button type="submit" class="btn btn-primary">Зарегистрировать группу</button>
        <a href="{% url 'employee_dashboard' %}" class="btn btn-secondary">Отмена</a>
    </div>
</form>
{% endblock %}

{% block extra_scripts %}
{{ visit_group_form.media.js }}
{{ member_formset.media.js }}
<script>
document.addEventListener('DOMContentLoaded', function() {
    document.addEventListener('DOMContentLoaded', function() {
        // Применяем классы Bootstrap к полям форм, если они еще не имеют их (особенно для empty_form)
        function styleFormControls(formElement) {
            formElement.querySelectorAll('input:not([type="checkbox"]):not([type="radio"]):not([type="submit"]):not([type="button"]):not([type="hidden"]), textarea, select').forEach(function(control) {
                if (control.tagName === 'SELECT' && !control.classList.contains('form-select')) {
                    control.classList.add('form-select');
                } else if (control.tagName !== 'SELECT' && !control.classList.contains('form-control') && !control.classList.contains('btn')) {
                    control.classList.add('form-control');
                }
            });
        }
    });

    // Стилизуем уже существующие формы
    document.querySelectorAll('.formset-member').forEach(styleFormControls);
    styleFormControls(document.querySelector('form')); // Для основной формы группы

    const addMemberButton = document.getElementById('add-member-form');
    const formsContainer = document.getElementById('member-forms-container'); // Контейнер для форм участников
    const emptyFormTemplateHolder = document.getElementById('empty-member-form');
    const totalFormsInput = document.querySelector('input[name="members-TOTAL_FORMS"]');
    const formsetPrefix = 'members'; // Префикс вашего формсета

    if (addMemberButton && formsContainer && emptyFormTemplateHolder && totalFormsInput) {
        addMemberButton.addEventListener('click', function() {
            let currentFormCount = parseInt(totalFormsInput.value);

            // Клонируем содержимое шаблона пустой формы
            let newFormHtml = emptyFormTemplateHolder.innerHTML;
            // Заменяем __prefix__ на текущий индекс формы
            newFormHtml = newFormHtml.replace(/__prefix__/g, currentFormCount);

            // Создаем div-обертку для новой формы
            let newFormDiv = document.createElement('div');
            newFormDiv.classList.add('formset-member');
            newFormDiv.id = `member-${currentFormCount}`;
                
            // Добавляем заголовок
            let title = document.createElement('h5');
            title.textContent = `Участник #${currentFormCount + 1}`;
            newFormDiv.appendChild(title);
            
            newFormDiv.innerHTML += newFormHtml; // Добавляем поля формы

            // Стилизуем контролы в новой форме
            styleFormControls(newFormDiv);

            // Вставляем новую форму перед кнопкой "Добавить участника"
            formsContainer.insertBefore(newFormDiv, addMemberButton);

            // Увеличиваем счетчик TOTAL_FORMS
            totalFormsInput.value = currentFormCount + 1;
        });
    } else {
        console.warn("Необходимые элементы для добавления форм участников не найдены. Проверьте ID и префикс формсета.");
    }
});
</script>
{% endblock %}
