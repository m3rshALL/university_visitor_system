{% extends "base.html" %}
{% load static %}

{% block title %}Регистрация гостя{% endblock %}

{% block extra_head %}
    {# Используем ПРАВИЛЬНОЕ имя переменной формы #}
    {{ guest_form.media.css }}
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <!-- Добавляем библиотеку IMask для создания масок ввода -->
    <script src="https://unpkg.com/imask@6.4.3/dist/imask.js"></script>
    <style>
        /* Стили для скрытия/показа секций */
        .expected-time-field { display: none; } 
        .expected-time-field.active { display: block; }
        #guest_purpose_other_wrapper { display: none; }
        
        /* Стили для карточек */
        .card-header {
            font-weight: 500;
        }
        .action-btn {
            margin-right: 5px;
        }
    </style>
{% endblock %}

{% block content %}
<div class="page-wrapper">
    <!-- BEGIN PAGE HEADER -->
    <div class="page-header d-print-none">
        <div class="container-xl">
            <div class="row g-2 align-items-center">
                <div class="col">
                    <h2 class="page-title">
                        <i class="bi bi-person-plus me-2"></i>Регистрация нового визита гостя
                    </h2>
                </div>
                <div class="col-auto ms-auto d-print-none">
                    <div class="btn-list">
                        <a href="{% url 'employee_dashboard' %}" class="btn btn-outline-secondary">
                            <i class="bi bi-arrow-left me-2"></i>Назад
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- END PAGE HEADER -->

    <!-- BEGIN PAGE BODY -->
    <div class="page-body">
        <div class="container-xl">
            {# Используем ПРАВИЛЬНОЕ имя переменной формы #}
            {% if guest_form.non_field_errors %}
            <div class="alert alert-danger">
                {% for error in guest_form.non_field_errors %}{{ error }}{% if not forloop.last %}<br>{% endif %}{% endfor %}
            </div>
            {% endif %}

            <div class="row mb-3">
                <div class="col-md-12">
                    <div class="card">
                        <div class="card-header bg-warning-subtle">
                            <div class="card-title">
                                <i class="bi bi-exclamation-triangle me-2"></i>Важная информация для сотрудника!
                            </div>
                        </div>
                        <div class="card-body">
                            <p>Уважаемый сотрудник, регистрируя гостя, вы <strong>берете на себя ответственность</strong> за его пребывание на территории университета.</p>
                            <p class="mb-0">Пожалуйста, <strong>встретьте гостя у ресепшна</strong> и сопровождайте его внутри университета в течение всего визита.
                            Это необходимо для обеспечения безопасности и порядка в университете.</p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row mb-3">
                <div class="col-md-12">
                    <div class="card">
                        <div class="card-header bg-info-subtle">
                            <div class="card-title">
                                <i class="bi bi-info-circle me-2"></i>Информирование гостя!
                            </div>
                        </div>
                        <div class="card-body">
                            <p class="mb-0">Пожалуйста, <strong>устно проинформируйте</strong> гостя о том, что Astana IT University будет обрабатывать его персональные данные (ФИО, ИИН, контакты, цель и время визита) для целей учета посетителей и обеспечения безопасности.
                            Вы можете сослаться на <a href="#" class="link-primary">Политику конфиденциальности.</a></p>
                        </div>
                    </div>
                </div>
            </div>

            <form method="post" novalidate class="needs-validation">
                {% csrf_token %}
                {# Передаем guest_form как form для удобства внутри with #}
                {% with form=guest_form %}
                <div class="row">
                    <div class="col-md-12">
                        <!-- Выбор Времени Регистрации -->
                        <div class="card mb-3">
                            <div class="card-header">
                                <div class="card-title">
                                    <i class="bi bi-clock me-2"></i>Время регистрации
                                </div>
                            </div>
                            <div class="card-body">
                                <div class="mb-3">
                                    <div class="form-label">Время регистрации:</div>
                                    <label class="form-check form-check-inline">
                                        <input class="form-check-input" type="radio" name="guest_reg_time" id="guest_reg_now" value="now" checked="">
                                        <span class="form-check-label" for="guest_reg_now">Сейчас</span>
                                    </label>
                                    <label class="form-check form-check-inline">
                                        <input class="form-check-input" type="radio" name="guest_reg_time" id="guest_reg_later" value="later">
                                        <span class="form-check-label" for="guest_reg_later">Запланировать</span>
                                    </label>
                                    <div class="mt-2 expected-time-field" id="guest_expected_time_wrapper">
                                        <label for="{{ form.expected_entry_time.id_for_label }}" class="form-label">{{ form.expected_entry_time.label }}:</label>
                                        {{ form.expected_entry_time }}
                                        {% if form.expected_entry_time.errors %} <div class="invalid-feedback d-block">{% for e in form.expected_entry_time.errors %}{% endfor %}</div> {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-12">
                        <!-- Данные гостя -->
                        <div class="card mb-3">
                            <div class="card-header">
                                <div class="card-title">
                                    <i class="bi bi-person me-2"></i>Данные гостя
                                </div>
                            </div>
                            <div class="card-body">
                                <!-- Разделение ФИО на три поля -->
                                <div class="row">
                                    <div class="col-md-4 mb-3">
                                        <label for="guest_surname" class="form-label required">Фамилия:</label>
                                        <input type="text" id="guest_surname" name="guest_surname" class="form-control" required>
                                    </div>
                                    <div class="col-md-4 mb-3">
                                        <label for="guest_firstname" class="form-label required">Имя:
                                        </label>
                                        <input type="text" id="guest_firstname" name="guest_firstname" class="form-control" required>
                                    </div>
                                    <div class="col-md-4 mb-3">
                                        <label for="guest_patronymic" class="form-label">Отчество:</label>
                                        <input type="text" id="guest_patronymic" name="guest_patronymic" class="form-control">
                                        <div class="form-text">Если имеется</div>
                                    </div>
                                </div>
                                
                                <!-- Скрытое поле для хранения полного имени -->
                                <div class="row">
                                <input type="hidden" name="{{ form.guest_full_name.html_name }}" id="guest_full_name_hidden">
                                  <div class="col-md-6 mb-3">
                                    <label for="{{ form.guest_iin.id_for_label }}" class="form-label required">ИИН:</label>
                                    <input type="text" id="{{ form.guest_iin.id_for_label }}" name="{{ form.guest_iin.html_name }}" 
                                           class="form-control" value="{{ form.guest_iin.value|default:'' }}" 
                                           placeholder="Введите 12 цифр ИИН" maxlength="12" pattern="[0-9]{12}" 
                                           title="" oninput="this.value = this.value.replace(/[^0-9]/g, '')">
                                    {% if form.guest_iin.errors %}
                                        <div class="invalid-feedback d-block">{% for e in form.guest_iin.errors %}{{ e }}{% endfor %}</div>
                                    {% else %}
                                        
                                    {% endif %}
                                </div>
                                </div>
                                
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label for="guest_phone_masked" class="form-label required">Номер телефона:</label>
                                        <input type="text" id="guest_phone_masked" class="form-control" placeholder="+7 (___) ___ __ __">
                                        {% if form.guest_phone.errors %}
                                            <div class="invalid-feedback d-block">{% for e in form.guest_phone.errors %}{{ e }}{% endfor %}</div>
                                        {% endif %}
                                        
                                        <!-- Скрытое поле для хранения значения без маски -->
                                        <input type="hidden" name="{{ form.guest_phone.html_name }}" id="{{ form.guest_phone.id_for_label }}" value="{{ form.guest_phone.value|default:'' }}">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-12">
                        <!-- Детали визита -->
                        <div class="card mb-3">
                            <div class="card-header">
                                <div class="card-title">
                                    <i class="bi bi-clipboard2-data me-2"></i>Детали визита
                                </div>
                            </div>
                            <div class="card-body">
                                <div class="mb-3">
                                    <label for="{{ form.department.id_for_label }}" class="form-label required">{{ form.department.label }}:</label>
                                    {{ form.department }}
                                    {% if form.department.errors %}
                                        <div class="invalid-feedback d-block">{% for e in form.department.errors %}{{ e }}{% endfor %}</div>
                                    {% else %}
                                        
                                    {% endif %}
                                    <div class="form-text" id="director_info_wrapper" style="display: none; margin-top: 5px;">
                                        <strong>Директор департамента:</strong> <span id="director_name_display">-</span>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <label for="{{ form.employee.id_for_label }}" class="form-label required">{{ form.employee.label }}:</label>
                                    {{ form.employee }}
                                    {% if form.employee.errors %}
                                        <div class="invalid-feedback d-block">{% for e in form.employee.errors %}{{ e }}{% endfor %}</div>
                                    {% else %}
                                        
                                    {% endif %}
                                </div>
                                <div class="mb-3">
                                    <label for="employee_phone_masked" class="form-label required">{{ form.employee_contact_phone_form.label }}:</label>
                                    <input type="text" id="employee_phone_masked" class="form-control" placeholder="+7 (___) ___ __ __">
                                    {% if form.employee_contact_phone_form.errors %}
                                        <div class="invalid-feedback d-block">{% for e in form.employee_contact_phone_form.errors %}{{ e }}{% endfor %}</div>
                                    {% endif %}
                                    
                                    <!-- Скрытое поле для хранения значения без маски -->
                                    <input type="hidden" name="{{ form.employee_contact_phone_form.html_name }}" id="{{ form.employee_contact_phone_form.id_for_label }}" value="{{ form.employee_contact_phone_form.value|default:'' }}">
                                </div>
                                <div class="mb-3">
                                    <label for="{{ form.purpose.id_for_label }}" class="form-label required">{{ form.purpose.label }}:</label>
                                    {{ form.purpose }}
                                    {% if form.purpose.errors %}
                                        <div class="invalid-feedback d-block">{% for e in form.purpose.errors %}{{ e }}{% endfor %}</div>
                                    {% else %}
                                        
                                    {% endif %}
                                </div>
                                <div class="mb-3" id="guest_purpose_other_wrapper">
                                    <label for="{{ form.purpose_other_text.id_for_label }}" class="form-label">{{ form.purpose_other_text.label }}:</label>
                                    {{ form.purpose_other_text }}
                                    {% if form.purpose_other_text.errors %}
                                        <div class="invalid-feedback d-block">{% for e in form.purpose_other_text.errors %}{{ e }}{% endfor %}</div>
                                    {% else %}
                                        
                                    {% endif %}
                                </div>
                                {% comment %}
                                    <p class="text-muted small mt-3">Гость будет зарегистрирован от вашего имени: {{ user.get_full_name|default:user.username }}.</p>
                                {% endcomment %}
                            </div>
                        </div>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-12">
                        <!-- Подтверждение информирования -->
                        <div class="card mb-3">
                            <div class="card-header">
                                <div class="card-title">
                                    <i class="bi bi-check-circle me-2"></i>Подтверждение информирования
                                </div>
                            </div>
                            <div class="card-body">
                                <div class="form-check">
                                    {{ form.consent_acknowledged.errors }}
                                    <input type="checkbox" name="{{ form.consent_acknowledged.html_name }}"
                                            class="form-check-input {% if form.consent_acknowledged.errors %}is-invalid{% endif %}"
                                            required id="{{ form.consent_acknowledged.id_for_label }}">
                                    <label class="form-check-label required" for="{{ form.consent_acknowledged.id_for_label }}">
                                        {{ form.consent_acknowledged.label }}
                                    </label>
                                    {% if form.consent_acknowledged.errors %}
                                        <div class="invalid-feedback d-block">
                                            {% for error in form.consent_acknowledged.errors %}{{ error }}{% endfor %}
                                        </div>
                                    {% endif %}
                                    <div class="form-text">Это поле обязательно для завершения регистрации.</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                {% endwith %}

                <!-- Кнопки -->
                <div class="row">
                    <div class="col-md-12">
                        <div class="d-flex justify-content-between mt-3 mb-4">
                            <a href="{% url 'employee_dashboard' %}" class="btn btn-outline-secondary">
                                <i class="bi bi-x-circle me-2"></i>Отмена
                            </a>
                            <button type="submit" class="btn btn-primary">
                                <i class="bi bi-person-plus me-2"></i>Зарегистрировать визит
                            </button>
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </div>
    <!-- END PAGE BODY -->
</div>
{% endblock %}

{% block extra_scripts %}
    {# --- СНАЧАЛА Медиа формы гостя (включая JS для Select2) --- #}
    {# Убедитесь, что jQuery загружен в base.html ДО этого блока! #}
    {{ guest_form.media.js }}
    {# ------------------------------------------------------ #}

    {# --- Теперь ВСЕ пользовательские скрипты --- #}

    {# --- JS для масок ввода --- #}
    <script>
        document.addEventListener('DOMContentLoaded', function() {
                        
            // Маска для телефона гостя
            const phoneMaskElement = document.getElementById('guest_phone_masked');
            const phoneHiddenElement = document.getElementById('{{ guest_form.guest_phone.id_for_label }}');
            
            if (phoneMaskElement && phoneHiddenElement) {
                const phoneMask = IMask(phoneMaskElement, {
                    mask: '+7 (000) 000 00 00',
                    lazy: false
                });
                
                // Инициализация значением из hidden-поля, если оно есть
                if (phoneHiddenElement.value) {
                    // Форматируем значение, убирая все, кроме цифр
                    let phoneValue = phoneHiddenElement.value.replace(/\D/g, '');
                    if (phoneValue.startsWith('7')) {
                        phoneMask.unmaskedValue = phoneValue.substring(1); // Убираем первую 7
                    } else {
                        phoneMask.unmaskedValue = phoneValue;
                    }
                }
                  // Обновление hidden-поля при вводе
                phoneMaskElement.addEventListener('input', function() {
                    phoneHiddenElement.value = '+7' + phoneMask.unmaskedValue;
                    
                    // Визуальная валидация номера телефона
                    validatePhoneNumber();
                });
                
                // Функция для валидации номера телефона
                function validatePhoneNumber() {
                    // Номер считается валидным, если в нем ровно 10 цифр (без учета +7)
                    const isValid = phoneMask.unmaskedValue && phoneMask.unmaskedValue.length === 10;
                    
                    if (phoneMask.unmaskedValue.length > 0) {
                        if (isValid) {
                            phoneMaskElement.classList.remove('is-invalid');
                            phoneMaskElement.classList.add('is-valid');
                        } else {
                            phoneMaskElement.classList.remove('is-valid');
                            phoneMaskElement.classList.add('is-invalid');
                        }
                    } else {
                        // Если поле пустое, убираем все классы валидации
                        phoneMaskElement.classList.remove('is-valid', 'is-invalid');
                    }
                    
                    return isValid;
                }
                
                // Проверка при потере фокуса
                phoneMaskElement.addEventListener('blur', validatePhoneNumber);
                
                // Проверка при отправке формы
                const form = phoneMaskElement.closest('form');
                if (form) {
                    form.addEventListener('submit', function(e) {
                        if (!validatePhoneNumber() && phoneMask.unmaskedValue.length > 0) {
                            e.preventDefault();
                            phoneMaskElement.focus();
                        }
                    });
                }
                
                // Начальная валидация
                if (phoneMask.unmaskedValue.length > 0) {
                    validatePhoneNumber();
                }
            }
            
            // Маска для телефона сотрудника
            const employeePhoneMaskElement = document.getElementById('employee_phone_masked');
            const employeePhoneHiddenElement = document.getElementById('{{ guest_form.employee_contact_phone_form.id_for_label }}');
            
            if (employeePhoneMaskElement && employeePhoneHiddenElement) {
                const employeePhoneMask = IMask(employeePhoneMaskElement, {
                    mask: '+7 (000) 000 00 00',
                    lazy: false
                });
                
                // Инициализация значением из hidden-поля, если оно есть
                if (employeePhoneHiddenElement.value) {
                    // Форматируем значение, убирая все, кроме цифр
                    let phoneValue = employeePhoneHiddenElement.value.replace(/\D/g, '');
                    if (phoneValue.startsWith('7')) {
                        employeePhoneMask.unmaskedValue = phoneValue.substring(1); // Убираем первую 7
                    } else {
                        employeePhoneMask.unmaskedValue = phoneValue;
                    }
                }
                  // Обновление hidden-поля при вводе
                employeePhoneMaskElement.addEventListener('input', function() {
                    employeePhoneHiddenElement.value = '+7' + employeePhoneMask.unmaskedValue;
                    
                    // Визуальная валидация номера телефона сотрудника
                    validateEmployeePhoneNumber();
                });
                
                // Функция для валидации номера телефона сотрудника
                function validateEmployeePhoneNumber() {
                    // Номер считается валидным, если в нем ровно 10 цифр (без учета +7)
                    const isValid = employeePhoneMask.unmaskedValue && employeePhoneMask.unmaskedValue.length === 10;
                    
                    if (employeePhoneMask.unmaskedValue.length > 0) {
                        if (isValid) {
                            employeePhoneMaskElement.classList.remove('is-invalid');
                            employeePhoneMaskElement.classList.add('is-valid');
                        } else {
                            employeePhoneMaskElement.classList.remove('is-valid');
                            employeePhoneMaskElement.classList.add('is-invalid');
                        }
                    } else {
                        // Если поле пустое, убираем все классы валидации
                        employeePhoneMaskElement.classList.remove('is-valid', 'is-invalid');
                    }
                    
                    return isValid;
                }
                
                // Проверка при потере фокуса
                employeePhoneMaskElement.addEventListener('blur', validateEmployeePhoneNumber);
                
                // Начальная валидация
                if (employeePhoneMask.unmaskedValue.length > 0) {
                    validateEmployeePhoneNumber();
                }
            }
            
            // Объединение полей имени в одно поле перед отправкой формы
            const surnameField = document.getElementById('guest_surname');
            const firstnameField = document.getElementById('guest_firstname');
            const patronymicField = document.getElementById('guest_patronymic');
            const fullNameHiddenField = document.getElementById('guest_full_name_hidden');
            
            // Проверяем, есть ли у нас скрытое поле ФИО и выходим, если нет
            if (!fullNameHiddenField) return;
            
            // Функция обновления полного имени
            function updateFullName() {
                const surname = surnameField ? surnameField.value.trim() : '';
                const firstname = firstnameField ? firstnameField.value.trim() : '';
                const patronymic = patronymicField ? patronymicField.value.trim() : '';
                
                let fullName = '';
                if (surname) fullName += surname;
                if (firstname) fullName += (fullName ? ' ' : '') + firstname;
                if (patronymic) fullName += (fullName ? ' ' : '') + patronymic;
                
                fullNameHiddenField.value = fullName;
            }
            
            // Обновляем полное имя при изменении любого из полей
            if (surnameField) surnameField.addEventListener('input', updateFullName);
            if (firstnameField) firstnameField.addEventListener('input', updateFullName);
            if (patronymicField) patronymicField.addEventListener('input', updateFullName);
            
            // Заполнение разделенных полей ФИО из существующего значения
            const existingFullName = "{{ guest_form.guest_full_name.value|default:'' }}";
            if (existingFullName) {
                const nameParts = existingFullName.split(' ');
                if (nameParts.length >= 1 && surnameField) {
                    surnameField.value = nameParts[0];
                }
                if (nameParts.length >= 2 && firstnameField) {
                    firstnameField.value = nameParts[1];
                }
                if (nameParts.length >= 3 && patronymicField) {
                    patronymicField.value = nameParts.slice(2).join(' ');
                }
            }
            
            // Инициализируем полное имя
            updateFullName();
        });
    </script>

    {# --- JS для переключения поля времени (с исправленными селекторами) --- #}
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Ищем радиокнопки по name внутри всей страницы (более надежно)
            const timeRadios = document.querySelectorAll('input[type="radio"][name="guest_reg_time"]');
            // Ищем обертку поля времени по ЕЁ ID
            const expectedTimeFieldWrapper = document.getElementById('guest_expected_time_wrapper');
    
            // Проверяем, что нашли и радиокнопки И обертку
            if (timeRadios.length > 0 && expectedTimeFieldWrapper) {
                 console.log("Найдены элементы времени для гостя."); // Отладочное сообщение
    
                 function toggleGuestExpectedTime() {
                     const selectedTimeType = document.querySelector('input[name="guest_reg_time"]:checked');
                     const isLater = selectedTimeType && selectedTimeType.value === 'later';
    
                     // Показываем/скрываем обертку
                     expectedTimeFieldWrapper.style.display = isLater ? 'block' : 'none';
                     expectedTimeFieldWrapper.classList.toggle('active', isLater);
    
                     // Управление required для поля ввода внутри обертки
                     const timeInput = expectedTimeFieldWrapper.querySelector('input'); // Ищем input внутри
                     if(timeInput) {
                         timeInput.required = isLater;
                         console.log(`Поле expected_entry_time required: ${isLater}`);
                     } else {
                          console.warn("Не найден input внутри guest_expected_time_wrapper");
                     }
                 }
                 // Привязываем обработчик к каждой радиокнопке
                 timeRadios.forEach(radio => { radio.addEventListener('change', toggleGuestExpectedTime); });
                 // Устанавливаем начальное состояние
                 toggleGuestExpectedTime();
            } else {
                 // Если что-то не найдено - выводим более подробное сообщение
                 console.error("ОШИБКА: Элементы времени для гостя не найдены!");
                 if (!timeRadios.length) console.error(" - Не найдены радиокнопки с name='guest_reg_time'");
                 if (!expectedTimeFieldWrapper) console.error(" - Не найдена обертка с ID 'guest_expected_time_wrapper'");
                 // Проверьте ID 'guest_expected_time_wrapper' в HTML части шаблона!
            }
        });
        </script>
        {# --------------------------------------- #}

    {# --- JS для валидации ИИН --- #}
    <script>
    document.addEventListener('DOMContentLoaded', function() {
        // Получаем поле ИИН
        const iinField = document.getElementById('{{ guest_form.guest_iin.id_for_label }}');
        
        if (iinField) {
            // Функция для валидации ИИН
            function validateIIN() {
                const value = iinField.value.trim();
                const isValid = /^\d{12}$/.test(value);
                
                // Визуальное отображение валидности
                if (value.length > 0) {
                    if (isValid) {
                        iinField.classList.remove('is-invalid');
                        iinField.classList.add('is-valid');
                    } else {
                        iinField.classList.remove('is-valid');
                        iinField.classList.add('is-invalid');
                        
                        // Показываем подсказку об ошибке
                        let errorDiv = iinField.nextElementSibling;
                        if (!errorDiv || !errorDiv.classList.contains('invalid-feedback')) {
                            errorDiv = document.createElement('div');
                            errorDiv.classList.add('invalid-feedback', 'd-block');
                            iinField.parentNode.insertBefore(errorDiv, iinField.nextSibling);
                        }
                        
                        let errorMessage = '';
                        if (value.length !== 12) {
                            errorMessage = '';
                        } else if (!/^\d+$/.test(value)) {
                            errorMessage = '';
                        }
                        
                        errorDiv.textContent = errorMessage;
                    }
                } else {
                    // Если поле пустое, убираем все классы валидации
                    iinField.classList.remove('is-valid', 'is-invalid');
                }
                
                return isValid;
            }
            
            // Обработка ввода: разрешаем только цифры
            iinField.addEventListener('input', function(e) {
                // Заменяем все нецифровые символы
                const cursorPos = this.selectionStart;
                const oldValue = this.value;
                const newValue = oldValue.replace(/[^\d]/g, '');
                
                // Если значение изменилось, обновляем его и устанавливаем курсор
                if (oldValue !== newValue) {
                    this.value = newValue;
                    this.setSelectionRange(cursorPos - (oldValue.length - newValue.length), cursorPos - (oldValue.length - newValue.length));
                }
                
                validateIIN();
            });
            
            // Проверка при потере фокуса
            iinField.addEventListener('blur', validateIIN);
            
            // Проверка при отправке формы
            const form = iinField.closest('form');
            if (form) {
                form.addEventListener('submit', function(e) {
                    if (!validateIIN() && iinField.value.trim().length > 0) {
                        e.preventDefault();
                        iinField.focus();
                    }
                });
            }
            
            // Начальная валидация
            if (iinField.value.trim().length > 0) {
                validateIIN();
            }
        }
    });
    </script>
    {# ------------------------------- #}

    {# --- JS для поля "Другое" цели визита --- #}
    <script>
    document.addEventListener('DOMContentLoaded', function() {
        // Используем ID поля purpose из формы guest_form
        const gpSelect = document.getElementById('{{ guest_form.purpose.id_for_label }}');
        const gpWrapper = document.getElementById('guest_purpose_other_wrapper'); // Используем ID обертки
        if (gpSelect && gpWrapper) {
             const gpInput = gpWrapper.querySelector('input, textarea');
             function toggleGuestOther() {
                 if (gpSelect.value === 'Other') { gpWrapper.style.display = 'block'; }
                 else { gpWrapper.style.display = 'none'; if (gpInput) gpInput.value = ''; }
             }
             toggleGuestOther();
             gpSelect.addEventListener('change', toggleGuestOther);
        } else {
            console.warn("Элементы для 'Другой цели' не найдены.");
        }
    });
    </script>
    {# ---------------------------------------- #}

    {# --- JS для стилей Bootstrap (без изменений) --- #}
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const form = document.querySelector('form.needs-validation');
            if (form) {
                 const formControls = form.querySelectorAll('input:not([type="checkbox"]):not([type="radio"]):not([type="submit"]):not([type="button"]):not([type="hidden"]), textarea, select');
                 formControls.forEach(function(control) {
                     if (control.tagName === 'SELECT') {
                          control.classList.add('form-select');
                     } else if (!control.classList.contains('btn')) {
                         control.classList.add('form-control');
                     }
                    // Добавляем класс is-invalid, если Django добавил ошибки к полю
                     const errorDiv = control.closest('.mb-3')?.querySelector('.invalid-feedback');
                     if (errorDiv && errorDiv.innerText.trim() !== '') {
                          control.classList.add('is-invalid');
                     }
                 });
             }
        });
    </script>

    {# --- JS для Select2 / Телефона / ОТОБРАЖЕНИЯ ДИРЕКТОРА --- #}
    <script>
        // Убедитесь, что jQuery ($) доступен
        if (typeof jQuery == 'undefined') { console.error("jQuery НЕ ЗАГРУЖЕН!"); }
        else {
           (function($) {
                $(document).ready(function() {
                   console.log("Select2/Phone/Director Script: DOM готов.");
                   // --- Селекторы ---
                   const departmentSelect = $('#{{ guest_form.department.id_for_label }}');
                   const employeeSelect = $('#{{ guest_form.employee.id_for_label }}');
                   const phoneInput = $('#employee_phone_masked'); // Изменено на ID маскированного поля
                   const directorDisplaySpan = $('#director_name_display'); // <-- Селектор для span директора
                   const directorDisplayWrapper = $('#director_info_wrapper'); // <-- Селектор для div-обертки директора

                   // Проверка элементов...
                   if (!departmentSelect.length) console.error("НЕ НАЙДЕН Департамент:", '#{{ guest_form.department.id_for_label }}');
                   if (!employeeSelect.length) console.error("НЕ НАЙДЕН Сотрудник:", '#{{ guest_form.employee.id_for_label }}');
                   if (!directorDisplayWrapper.length) console.warn("Не найдена ОБЕРТКА для директора ('#director_info_wrapper').");
                   if (!directorDisplaySpan.length) console.warn("Не найден SPAN для директора ('#director_name_display').");


                   if (employeeSelect.length && departmentSelect.length) {
                    console.log("Select2/Phone: Поля найдены. Попытка инициализации Select2...");
                    try {
                        // --- Инициализация Select2 (Один раз) ---
                        employeeSelect.select2({
                            ajax: { url: "{% url 'employee_autocomplete' %}", dataType: 'json', delay: 250, data: function (params) { const dId = departmentSelect.val(); let d = { term: params.term, page: params.page }; if (dId) { d.department_id = dId; } console.log("[AJAX Data] Sending:", d); return d; }, processResults: function (data, params) { console.log("[Select2 AJAX] Received:", data); return { results: data.results, pagination: {more: (params.page||1)*20 < data.count} }; } },
                            placeholder: 'Сначала выберите департамент...', // Начальный плейсхолдер
                            minimumInputLength: 1,
                            allowClear: true,
                            disabled: !departmentSelect.val() // Начальное состояние
                        });
                        console.log("Select2 инициализирован.");


                           // --- ОБНОВЛЕННЫЙ Обработчик изменения департамента ---
                           departmentSelect.on('change', function() {
                               const selectedDepartmentId = $(this).val();
                               console.log(`EVENT: Department changed to: ${selectedDepartmentId}`);

                               // 1. Обработка поля сотрудника и телефона (как было)
                               employeeSelect.val(null).trigger('change');
                               if(phoneInput.length) { 
                                   phoneInput.val('');
                                   $('#{{ guest_form.employee_contact_phone_form.id_for_label }}').val('');
                               }
                               employeeSelect.prop('disabled', !selectedDepartmentId);
                               console.log("EVENT: Employee field disabled:", !selectedDepartmentId);

                               // 2. Запрос и отображение Директора
                               console.log("Attempting to fetch Director info...");
                               if (selectedDepartmentId && directorDisplaySpan.length && directorDisplayWrapper.length) {
                                   directorDisplaySpan.text('Загрузка...'); // Индикатор
                                   directorDisplayWrapper.show(); // Показываем обертку
                                   $.ajax({
                                       url: "{% url 'get_department_details' %}", // URL для деталей департамента
                                       data: { 'department_id': selectedDepartmentId },
                                       dataType: 'json',
                                       success: function(data) {
                                           console.log("AJAX Success (Department Details):", data);
                                           directorDisplaySpan.text(data.director_name || 'Не назначен');
                                       },
                                       error: function(xhr, status, error) {
                                           console.error("AJAX Error fetching Department Details:", status, error);
                                           directorDisplaySpan.text('Ошибка загрузки');
                                       }
                                   });
                               } else {
                                   // Скрываем, если департамент не выбран или элементы не найдены
                                   if(directorDisplayWrapper.length) directorDisplayWrapper.hide();
                                   if(directorDisplaySpan.length) directorDisplaySpan.text('-');
                                   if (!selectedDepartmentId) console.log("Department not selected, hiding director info.");
                               }
                               // --- Конец блока Директора ---

                           }); // --- Конец обработчика смены департамента ---
                           console.log("Обработчик 'change' для Департамента ПРИВЯЗАН.");

                            // --- Обработчик выбора сотрудника (с логами) ---
                            if (phoneInput.length) {
                                console.log("Попытка привязки обработчика select2:select...");
                                employeeSelect.on('select2:select', function (e) {
                                    // --- Логи внутри обработчика ---
                                    console.log("==== Обработчик select2:select СРАБОТАЛ ====");
                                    console.log("Event Object 'e':", e);
                                    const selectedData = e.params.data;
                                    console.log("Selected data 'e.params.data':", selectedData);
                                    if (selectedData && selectedData.id) {
                                        const userId = selectedData.id;
                                        console.log("Извлечен User ID:", userId);
                                        const detailUrl = `/visitors/ajax/employee-details/${userId}/`;
                                        console.log("Сформирован URL для AJAX:", detailUrl);
                                        console.log(">>> Сейчас должен идти AJAX-запрос");
                                        try {
                                             console.log("Attempting AJAX call...");
                                             $.ajax({
                                                 url: detailUrl, type: 'GET', dataType: 'json',
                                                 success: function(response) { 
                                                    console.log("AJAX Success:", response); 
                                                    // Получаем IMask объект для телефона сотрудника
                                                    const phoneMaskElement = document.getElementById('employee_phone_masked');
                                                    if (phoneMaskElement) {
                                                        phoneMaskElement.value = ''; // Сначала очищаем
                                                        const phoneNumber = response.phone_number || '';
                                                        if (phoneNumber) {
                                                            // Заполняем маскированное поле
                                                            let phoneValue = phoneNumber.replace(/\D/g, '');
                                                            if (phoneValue.startsWith('7')) {
                                                                phoneValue = phoneValue.substring(1); // Убираем первую 7
                                                            }
                                                            // Форматируем вручную для маски
                                                            if (phoneValue.length === 10) {
                                                                phoneMaskElement.value = '+7 (' + phoneValue.substring(0, 3) + ') ' + 
                                                                    phoneValue.substring(3, 6) + ' ' + 
                                                                    phoneValue.substring(6, 8) + ' ' + 
                                                                    phoneValue.substring(8, 10);                                                            } else {
                                                                phoneMaskElement.value = phoneNumber;
                                                            }
                                                        }
                                                        // Обновляем скрытое поле
                                                        $('#{{ guest_form.employee_contact_phone_form.id_for_label }}').val(response.phone_number || '');
                                                        
                                                        // Вызываем функцию валидации телефона после автозаполнения
                                                        if (typeof validateEmployeePhoneNumber === 'function') {
                                                            setTimeout(validateEmployeePhoneNumber, 100); // Небольшая задержка для корректной работы
                                                        }
                                                    }
                                                 },
                                                 error: function(xhr, status, error) { 
                                                    console.error('AJAX Error:', status, error); 
                                                    phoneInput.val('');
                                                    $('#{{ guest_form.employee_contact_phone_form.id_for_label }}').val('');
                                                 }
                                             });
                                             console.log("AJAX call initiated.");
                                         } catch (ajaxError) { 
                                            console.error("Sync error during AJAX:", ajaxError); 
                                            phoneInput.val('');
                                            $('#{{ guest_form.employee_contact_phone_form.id_for_label }}').val('');
                                         }
                                    } else { 
                                        console.warn("Нет данных или ID в событии select."); 
                                        phoneInput.val('');
                                        $('#{{ guest_form.employee_contact_phone_form.id_for_label }}').val('');
                                    }
                                    console.log("==== Обработчик select2:select ЗАВЕРШЕН ====");
                                });
                                console.log("Обработчик select2:select ПРИВЯЗАН.");
 
                                employeeSelect.on('select2:unselect', function (e) { 
                                    console.log("EVENT: Employee unselected."); 
                                    phoneInput.val('');
                                    $('#{{ guest_form.employee_contact_phone_form.id_for_label }}').val('');
                                });
                                
                                departmentSelect.on('change', function() { 
                                    if(phoneInput.length) {
                                        phoneInput.val('');
                                        $('#{{ guest_form.employee_contact_phone_form.id_for_label }}').val('');
                                    }
                                });
                            } else { console.warn("Поле телефона не найдено, автозаполнение не привязано."); }
                            // -----------------------------------------------

                            // Начальное состояние блокировки
                            employeeSelect.prop('disabled', !departmentSelect.val());

                         } catch(e) { console.error("RUNTIME ERROR during Select2/Phone setup:", e); }
                     } else { console.error("ERROR: Не могу настроить Select2 - не найдены поля Сотрудника или Департамента!");}
                 }); // end document.ready
             })(jQuery); // end wrapper
         } // end if jQuery defined
     </script>
    {# -------------------------------------------------------- #}
{% endblock %}