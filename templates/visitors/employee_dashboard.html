{% extends "base.html" %}
{% block title %}Панель сотрудника{% endblock %}

{% block content %}
                
    <!-- BEGIN PAGE HEADER -->
    <div class="page-header d-print-none">
        <div class="container-xl">
            <div class="row g-2 align-items-center">
                <div class="col">
                    <h2 class="page-title">
                        <i class="bi bi-person-plus me-2"></i>Панель сотрудника: {{ user.get_full_name|default:user.username }}
                    </h2>
                </div>
            </div>
        </div>
    </div>
    <!-- END PAGE HEADER -->

<div class="page-body">
    
<div class="row mb-3">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">Быстрые действия</h3>
            </div>
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-md-4 col-lg-3">
                        <a href="{% url 'register_guest' %}" class="card card-link card-link-pop">
                            <div class="card-body text-center">
                                <div class="text-primary mb-2">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-user-plus" width="32" height="32" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                                        <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
                                        <path d="M8 7a4 4 0 1 0 8 0a4 4 0 0 0 -8 0"></path>
                                        <path d="M16 19h6"></path>
                                        <path d="M19 16v6"></path>
                                        <path d="M6 21v-2a4 4 0 0 1 4 -4h4"></path>
                                    </svg>
                                </div>
                                <div>Регистрация гостя</div>
                            </div>
                        </a>
                    </div>
                    <div class="col-md-4 col-lg-3">
                        <a href="{% url 'register_student_visit' %}" class="card card-link card-link-pop">
                            <div class="card-body text-center">
                                <div class="text-indigo mb-2">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-school" width="32" height="32" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                                        <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
                                        <path d="M22 9l-10 -4l-10 4l10 4l10 -4v6"></path>
                                        <path d="M6 10.6v5.4a6 3 0 0 0 12 0v-5.4"></path>
                                    </svg>
                                </div>
                                <div>Регистрация студента</div>
                            </div>
                        </a>
                    </div>
                    <div class="col-md-4 col-lg-3">
                        <a href="{% url 'current_guests' %}" class="card card-link card-link-pop">
                            <div class="card-body text-center">
                                <div class="text-green mb-2">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-users" width="32" height="32" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                                        <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
                                        <path d="M9 7m-4 0a4 4 0 1 0 8 0a4 4 0 1 0 -8 0"></path>
                                        <path d="M3 21v-2a4 4 0 0 1 4 -4h4a4 4 0 0 1 4 4v2"></path>
                                        <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                                        <path d="M21 21v-2a4 4 0 0 0 -3 -3.85"></path>
                                    </svg>
                                </div>
                                <div>Текущие гости</div>
                            </div>
                        </a>
                    </div>
                    <div class="col-md-4 col-lg-3">
                        <a href="{% url 'visit_history' %}" class="card card-link card-link-pop">
                            <div class="card-body text-center">
                                <div class="text-azure mb-2">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-history" width="32" height="32" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                                        <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
                                        <path d="M12 8l0 4l2 2"></path>
                                        <path d="M3.05 11a9 9 0 1 1 .5 4m-.5 5v-5h5"></path>
                                    </svg>
                                </div>
                                <div>История визитов</div>
                            </div>
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row mb-3">
    <div class="col-12">
        <div class="card">            <div class="card-header">
                <h3 class="card-title">
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-calendar-time me-1" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                        <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
                        <path d="M11.795 21h-6.795a2 2 0 0 1 -2 -2v-12a2 2 0 0 1 2 -2h12a2 2 0 0 1 2 2v4"></path>
                        <path d="M18 18m-4 0a4 4 0 1 0 8 0a4 4 0 1 0 -8 0"></path>
                        <path d="M15 3v4"></path>
                        <path d="M7 3v4"></path>
                        <path d="M3 11h16"></path>
                        <path d="M18 16.496v1.504l1 1"></path>
                    </svg>
                    Ожидаемые визиты на неделю (Департамент: {{ department_name }})
                </h3>
                <div class="card-actions">
                    <a href="{% url 'register_guest' %}" class="btn btn-primary btn-sm">
                        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-plus" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                            <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
                            <path d="M12 5l0 14"></path>
                            <path d="M5 12l14 0"></path>
                        </svg>
                        Новый визит
                    </a>
                </div>
            </div>
            <div class="table-responsive">
                <table class="table table-vcenter card-table">                    <thead>
                        <tr>
                            <th>Гость</th>
                            <th>Дата</th>
                            <th>Время</th>
                            <th>К кому</th>
                            <th>Департамент</th>
                            <th>Цель</th>
                            <th>Действия</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for visit in upcoming_visits %}
                        <tr>
                            <td class="text-nowrap">
                                <div class="d-flex align-items-center">
                                    <div class="avatar avatar-sm bg-azure-lt rounded me-2">{{ visit.guest.full_name|slice:":2" }}</div>
                                    <div>
                                        <div class="font-weight-medium">{{ visit.guest.full_name }}</div>
                                        {% if visit.guest_iin %}
                                        <div class="text-muted small">ИИН: {{ visit.guest_iin }}</div>
                                        {% endif %}
                                    </div>
                                </div>                            </td>
                            <td class="text-nowrap">
                                <span class="badge {% if visit.expected_entry_time.date == today %}bg-blue-lt{% else %}bg-purple-lt{% endif %}">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-calendar-event me-1" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                                        <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
                                        <path d="M4 5m0 2a2 2 0 0 1 2 -2h12a2 2 0 0 1 2 2v12a2 2 0 0 1 -2 2h-12a2 2 0 0 1 -2 -2z"></path>
                                        <path d="M16 3l0 4"></path>
                                        <path d="M8 3l0 4"></path>
                                        <path d="M4 11l16 0"></path>
                                        <path d="M8 15h2v2h-2z"></path>
                                    </svg>
                                    {{ visit.expected_entry_time|date:"d.m.Y" }}
                                </span>
                            </td>
                            <td class="text-nowrap">
                                <span class="badge bg-yellow-lt">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock me-1" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                                        <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
                                        <path d="M3 12a9 9 0 1 0 18 0a9 9 0 0 0 -18 0"></path>
                                        <path d="M12 7v5l3 3"></path>
                                    </svg>
                                    {{ visit.expected_entry_time|date:"H:i" }}
                                </span>
                            </td>                            <td>
                                {% if visit.visit_kind == 'official' and visit.employee %}
                                    {% if visit.employee == user %}
                                        <span class="badge bg-green-lt me-1">
                                            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-user-check me-1" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                                                <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
                                                <path d="M8 7a4 4 0 1 0 8 0a4 4 0 0 0 -8 0"></path>
                                                <path d="M6 21v-2a4 4 0 0 1 4 -4h4"></path>
                                                <path d="M15 19l2 2l4 -4"></path>
                                            </svg>
                                            К вам
                                        </span>
                                    {% endif %}
                                    {{ visit.employee.get_full_name|default:visit.employee.username }}
                                {% elif visit.visit_kind == 'student' %}
                                    <span class="badge bg-blue-lt">Студент/Абит.</span>
                                {% else %}
                                    <span class="text-muted">-</span>
                                {% endif %}
                            </td>
                            <td>
                                <span class="text-muted">{{ visit.department.name|default:"-" }}</span>
                            </td>
                            <td>{{ visit.purpose|default:"-"|truncatechars:30 }}</td>
                            <td class="text-nowrap">
                                <form action="{% url 'check_in_visit' visit_kind=visit.visit_kind visit_id=visit.id %}" method="post" class="d-inline">
                                    {% csrf_token %}
                                    <button type="submit" class="btn btn-success btn-sm" title="Зарегистрировать вход">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-login" width="16" height="16" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                                            <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
                                            <path d="M15 8v-2a2 2 0 0 0 -2 -2h-7a2 2 0 0 0 -2 2v12a2 2 0 0 0 2 2h7a2 2 0 0 0 2 -2v-2"></path>
                                            <path d="M21 12h-13l3 -3"></path>
                                            <path d="M11 15l-3 -3"></path>
                                        </svg>
                                        Прибыл
                                    </button>
                                </form>
                                <a href="{% if visit.visit_kind == 'official' %}{% url 'visit_detail' visit.id %}{% else %}{% url 'student_visit_detail' visit.id %}{% endif %}" class="btn btn-ghost-secondary btn-sm">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-info-circle" width="16" height="16" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                                        <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
                                        <path d="M3 12a9 9 0 1 0 18 0a9 9 0 0 0 -18 0"></path>
                                        <path d="M12 9h.01"></path>
                                        <path d="M11 12h1v4h1"></path>
                                    </svg>
                                    Детали
                                </a>
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="6" class="text-center py-3">
                                <div class="empty">
                                    <div class="empty-icon">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-calendar-off" width="40" height="40" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                                            <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
                                            <path d="M19.823 19.824a2 2 0 0 1 -1.823 1.176h-12a2 2 0 0 1 -2 -2v-12a2 2 0 0 1 1.175 -1.823m3.825 -.177h7a2 2 0 0 1 2 2v8"></path>
                                            <path d="M16 3v4"></path>
                                            <path d="M8 3v1"></path>
                                            <path d="M4 11h7m4 0h5"></path>
                                            <path d="M3 3l18 18"></path>
                                        </svg>
                                    </div>                                    <p class="empty-title">Нет ожидаемых визитов</p>
                                    <p class="empty-subtitle text-muted">
                                        На ближайшую неделю не запланировано предварительных визитов ни для вас, ни для ваших коллег по департаменту
                                    </p>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<div class="row mb-3">
    <div class="col-lg-8">
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">Активность визитов</h3>
                <div class="card-actions">
                    <div class="btn-group">
                        <a href="#" class="btn btn-sm active" id="chart-today">Сегодня</a>
                        <a href="#" class="btn btn-sm" id="chart-week">Неделя</a>
                        <a href="#" class="btn btn-sm" id="chart-month">Месяц</a>
                    </div>
                </div>
            </div>
            <div class="card-body">
                <div id="visits-chart" style="height: 280px;"></div>
            </div>
        </div>
    </div>
    <div class="col-lg-4">
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">Недавние визиты</h3>
                <div class="card-actions">
                    <a href="{% url 'visit_history' %}" class="btn btn-sm">
                        Все визиты
                    </a>
                </div>
            </div>
            <div class="card-body card-body-scrollable card-body-scrollable-shadow" style="max-height: 280px;">
                <div class="divide-y">
                    {% for visit in recent_visits %}
                    <div class="d-flex p-3">
                        <div class="avatar avatar-sm bg-azure-lt rounded me-3">{{ visit.guest.full_name|slice:":2" }}</div>
                        <div>
                            <div class="font-weight-medium">{{ visit.guest.full_name }}</div>
                            <div class="text-muted">
                                {% if visit.exit_time %}
                                    <span class="badge bg-success-lt me-1">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-check" width="16" height="16" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                                            <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
                                            <path d="M5 12l5 5l10 -10"></path>
                                        </svg>
                                        Завершен
                                    </span>
                                {% elif visit.status == 'CHECKED_IN' %}
                                    <span class="badge bg-green-lt me-1">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-login" width="16" height="16" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                                            <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
                                            <path d="M14 8v-2a2 2 0 0 0 -2 -2h-7a2 2 0 0 0 -2 2v12a2 2 0 0 0 2 2h7a2 2 0 0 0 2 -2v-2"></path>
                                            <path d="M20 12h-13l3 -3m0 6l-3 -3"></path>
                                        </svg>
                                        В здании
                                    </span>
                                {% elif visit.status == 'AWAITING_ARRIVAL' %}
                                    <span class="badge bg-yellow-lt me-1">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="16" height="16" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                                            <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
                                            <path d="M3 12a9 9 0 1 0 18 0a9 9 0 0 0 -18 0"></path>
                                            <path d="M12 7v5l3 3"></path>
                                        </svg>
                                        Ожидает
                                    </span>
                                {% endif %}
                                {{ visit.entry_time|date:"H:i" }}
                            </div>
                        </div>
                        <div class="ms-auto">
                            <a href="{% if visit.visit_kind == 'official' %}{% url 'visit_detail' visit.id %}{% else %}{% url 'student_visit_detail' visit.id %}{% endif %}" class="btn btn-sm btn-outline-primary">
                                <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-eye" width="16" height="16" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                                    <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
                                    <path d="M10 12a2 2 0 1 0 4 0a2 2 0 0 0 -4 0"></path>
                                    <path d="M21 12c-2.4 4 -5.4 6 -9 6c-3.6 0 -6.6 -2 -9 -6c2.4 -4 5.4 -6 9 -6c3.6 0 6.6 2 9 6"></path>
                                </svg>
                            </a>
                        </div>
                    </div>
                    {% empty %}
                    <div class="text-center py-3 text-muted">
                        Нет недавних визитов
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>


<div class="row">
    <div class="col-lg-8">
        <div class="row">
            <div class="col-12 mb-3">
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Распределение визитов</h3>
                    </div>
                    <div class="card-body">
                        <div id="visits-pie-chart" style="height: 220px;"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-lg-4">
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">Полезные ссылки</h3>
            </div>
            <div class="card-body">
                <div class="list-group list-group-flush">
                    <a href="{% url 'register_guest' %}" class="list-group-item list-group-item-action">
                        <div class="row align-items-center">
                            <div class="col-auto">
                                <svg xmlns="http://www.w3.org/2000/svg" class="icon text-primary" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                                    <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
                                    <path d="M8 7a4 4 0 1 0 8 0a4 4 0 0 0 -8 0"></path>
                                    <path d="M16 19h6"></path>
                                    <path d="M19 16v6"></path>
                                    <path d="M6 21v-2a4 4 0 0 1 4 -4h4"></path>
                                </svg>
                            </div>
                            <div class="col">Регистрация нового гостя</div>
                        </div>
                    </a>
                    <a href="{% url 'visit_history' %}" class="list-group-item list-group-item-action">
                        <div class="row align-items-center">
                            <div class="col-auto">
                                <svg xmlns="http://www.w3.org/2000/svg" class="icon text-info" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                                    <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
                                    <path d="M12 8l0 4l2 2"></path>
                                    <path d="M3.05 11a9 9 0 1 1 .5 4m-.5 5v-5h5"></path>
                                </svg>
                            </div>
                            <div class="col">История всех визитов</div>
                        </div>
                    </a>
                    <a href="{% url 'current_guests' %}" class="list-group-item list-group-item-action">
                        <div class="row align-items-center">
                            <div class="col-auto">
                                <svg xmlns="http://www.w3.org/2000/svg" class="icon text-success" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                                    <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
                                    <path d="M9 7m-4 0a4 4 0 1 0 8 0a4 4 0 1 0 -8 0"></path>
                                    <path d="M3 21v-2a4 4 0 0 1 4 -4h4a4 4 0 0 1 4 4v2"></path>
                                    <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                                    <path d="M21 21v-2a4 4 0 0 0 -3 -3.85"></path>
                                </svg>
                            </div>
                            <div class="col">Текущие гости в здании</div>
                        </div>
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row mt-3">
    <div class="col-md-8"> {# Сделаем блок шире для доп. информации #}
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">Мои текущие гости (ожидают меня)</h3>
            </div>
            <div class="card-body">
                {% if my_current_guests %}
                    <div class="list-group"> {# Используем div вместо ul для лучшей структуры #}
                        {% for visit in my_current_guests %}
                            <div class="list-group-item list-group-item-action flex-column align-items-start mb-2">
                                <div class="d-flex w-100 justify-content-between">
                                    <h5 class="mb-1">{{ visit.guest.full_name }}</h5>
                                    <small class="text-muted">Прибыл: {{ visit.entry_time|date:"H:i" }}</small>
                                </div>
                                <p class="mb-1"><strong>Цель:</strong> {{ visit.purpose }}</p>
                                {# --- Отображение новых данных --- #}
                                <p class="mb-1">
                                    <strong>ИИН гостя:</strong> {{ visit.guest.iin|default:"Не указан" }} <br>
                                    <strong>Тел. гостя:</strong> {{ visit.guest.phone_number|default:"Не указан" }} <br>
                                    {# Отображаем телефон сотрудника, указанный для этого визита #}
                                    <strong>Контактный тел. сотрудника (визит):</strong> {{ visit.employee_contact_phone|default:"Не указан" }}
                                </p>
                                {# ------------------------------ #}
                                <div class="mt-2">
                                    <form action="{% url 'mark_guest_exit' visit.id %}" method="post" class="d-inline">
                                        {% csrf_token %}
                                        <button type="submit" class="btn btn-warning btn-sm">Гость вышел</button>
                                    </form>
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <div class="empty">
                        <div class="empty-icon">
                            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-mood-empty" width="40" height="40" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                                <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
                                <path d="M12 12m-9 0a9 9 0 1 0 18 0a9 9 0 1 0 -18 0"></path>
                                <path d="M9 10l.01 0"></path>
                                <path d="M15 10l.01 0"></path>
                                <path d="M9 15l6 0"></path>
                            </svg>
                        </div>
                        <p class="empty-title">В данный момент у вас нет активных гостей</p>
                        <p class="empty-subtitle text-muted">
                            Когда к вам придет гость, он будет отображен здесь
                        </p>
                        <div class="empty-action">
                            <a href="{% url 'register_guest' %}" class="btn btn-primary">
                                <svg xmlns="http://www.w3.org/2000/svg" class="icon" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                                    <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
                                    <path d="M12 5l0 14"></path>
                                    <path d="M5 12l14 0"></path>
                                </svg>
                                Зарегистрировать нового гостя
                            </a>
                        </div>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
    <div class="col-md-4"> {# Оставим этот блок для истории #}
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">Моя недавняя история визитов</h3>
                <div class="card-actions">
                    <a href="{% url 'visit_history' %}" class="btn btn-sm">Вся история</a>
                </div>
            </div>
            <div class="card-body">
                {% if my_visit_history %}
                    <div class="divide-y">
                        {% for visit in my_visit_history %}
                            <div class="row py-2">
                                <div class="col">
                                    <div class="text-truncate">
                                        <strong>{{ visit.guest.full_name }}</strong>
                                        {% if visit.employee == user %} <span class="badge bg-blue-lt">Принимающий</span> {% endif %}
                                        {% if visit.registered_by == user and visit.employee != user %} <span class="badge bg-purple-lt">Регистрировал</span> {% endif %}
                                    </div>
                                    <div class="small text-muted">
                                        {{ visit.entry_time|date:"Y-m-d H:i" }}
                                        {% if visit.exit_time %} - {{ visit.exit_time|date:"H:i" }} {% else %} <span class="badge bg-green-lt">В здании</span> {% endif %}
                                    </div>
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <div class="empty">
                        <p class="empty-title text-muted">У вас еще нет записей в истории визитов</p>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>
</div>


{% endblock %}

{% block extra_scripts %}
<script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Данные для графика активности (замените фиктивными данными)
    const visitData = {{ visit_chart_data|safe|default:"{}" }};
    
    // График активности визитов
    if (document.getElementById('visits-chart')) {
        const visitsChartOptions = {
            series: [{
                name: 'Визиты',
                data: visitData.today || [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0]
            }],
            chart: {
                height: 280,
                type: 'bar',
                toolbar: {
                    show: false
                }
            },
            plotOptions: {
                bar: {
                    borderRadius: 2,
                    columnWidth: '70%',
                }
            },
            dataLabels: {
                enabled: false
            },
            colors: ['#206bc4'],
            xaxis: {
                categories: ['00:00', '01:00', '02:00', '03:00', '04:00', '05:00', '06:00', '07:00', '08:00', '09:00', '10:00', '11:00', '12:00', '13:00', '14:00', '15:00', '16:00', '17:00', '18:00', '19:00', '20:00', '21:00', '22:00', '23:00'],
                labels: {
                    rotate: -90,
                    rotateAlways: true
                }
            },
            yaxis: {
                title: {
                    text: 'Количество визитов'
                }
            }
        };

        const visitsChart = new ApexCharts(document.querySelector("#visits-chart"), visitsChartOptions);
        visitsChart.render();
        
        // Переключение периодов для графика
        document.getElementById('chart-today').addEventListener('click', function(e) {
            e.preventDefault();
            this.classList.add('active');
            document.getElementById('chart-week').classList.remove('active');
            document.getElementById('chart-month').classList.remove('active');
            
            visitsChart.updateOptions({
                series: [{
                    data: visitData.today || [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0]
                }],
                xaxis: {
                    categories: ['00:00', '01:00', '02:00', '03:00', '04:00', '05:00', '06:00', '07:00', '08:00', '09:00', '10:00', '11:00', '12:00', '13:00', '14:00', '15:00', '16:00', '17:00', '18:00', '19:00', '20:00', '21:00', '22:00', '23:00'],
                }
            });
        });
        
        document.getElementById('chart-week').addEventListener('click', function(e) {
            e.preventDefault();
            this.classList.add('active');
            document.getElementById('chart-today').classList.remove('active');
            document.getElementById('chart-month').classList.remove('active');
            
            visitsChart.updateOptions({
                series: [{
                    data: visitData.week || [0, 0, 0, 0, 0, 0, 0]
                }],
                xaxis: {
                    categories: ['Пн', 'Вт', 'Ср', 'Чт', 'Пт', 'Сб', 'Вс'],
                }
            });
        });
        
        document.getElementById('chart-month').addEventListener('click', function(e) {
            e.preventDefault();
            this.classList.add('active');
            document.getElementById('chart-today').classList.remove('active');
            document.getElementById('chart-week').classList.remove('active');
            
            visitsChart.updateOptions({
                series: [{
                    data: visitData.month || [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0]
                }],
                xaxis: {
                    categories: Array.from({length: 31}, (_, i) => i + 1),
                }
            });
        });
    }
    
    // Круговая диаграмма типов визитов
    if (document.getElementById('visits-pie-chart')) {
        const pieChartOptions = {
            series: [{{ official_visits_percent|default:30 }}, {{ student_visits_percent|default:70 }}],
            chart: {
                type: 'donut',
                height: 220
            },
            labels: ['Официальные', 'Студенческие'],
            colors: ['#206bc4', '#4299e1'],
            legend: {
                position: 'bottom'
            },
            dataLabels: {
                enabled: true,
                formatter: function (val) {
                    return val + "%";
                }
            },
            plotOptions: {
                pie: {
                    donut: {
                        size: '50%',
                        labels: {
                            show: true,
                            total: {
                                show: true,
                                label: 'Всего',
                                formatter: function (w) {
                                    return w.globals.seriesTotals.reduce((a, b) => {
                                        return a + b;
                                    }, 0);
                                }
                            }
                        }
                    }
                }
            }
        };

        const pieChart = new ApexCharts(document.querySelector("#visits-pie-chart"), pieChartOptions);
        pieChart.render();
    }
});
</script>
{% endblock %}