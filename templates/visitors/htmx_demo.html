{% extends "base.html" %}
{% load static %}

{% block title %}HTMX Demo - Visitor System{% endblock %}

{% block content %}
<div class="container-xl">
    <div class="page-header d-print-none">
        <div class="row g-2 align-items-center">
            <div class="col">
                <h2 class="page-title">
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon me-2" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                        <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
                        <path d="M12 12m-1 0a1 1 0 1 0 2 0a1 1 0 1 0 -2 0"/>
                        <path d="M12 7a5 5 0 1 1 -5 5l5 -5z"/>
                        <path d="M12 12m-9 0a9 9 0 1 0 18 0a9 9 0 1 0 -18 0"/>
                    </svg>
                    –î–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—è –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–µ–π HTMX
                </h2>
                <div class="page-subtitle">
                    –ü–æ–∫–∞–∑–∞—Ç—å —É–ª—É—á—à–µ–Ω–∏—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ django-htmx
                </div>
            </div>
        </div>
    </div>

    <div class="page-body">
        <!-- –°–µ–∫—Ü–∏—è —Å –∂–∏–≤—ã–º–∏ —Å—á–µ—Ç—á–∏–∫–∞–º–∏ -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card card-sm">
                    <div class="card-body">
                        <div class="row align-items-center">
                            <div class="col-auto">
                                <span class="bg-primary text-white avatar">üìä</span>
                            </div>
                            <div class="col">
                                <div class="font-weight-medium">–ñ–∏–≤–æ–π —Å—á–µ—Ç—á–∏–∫</div>
                                <div class="text-muted">
                                    <span id="live-counter" 
                                          hx-get="{% url 'get_counters_api' %}"
                                          hx-trigger="every 3s"
                                          hx-swap="innerHTML">{{ active_visits_count|default:0 }}</span> –≤–∏–∑–∏—Ç–æ–≤
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-md-9">
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">–ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–∞—è —Ñ–æ—Ä–º–∞ —Å –≤–∞–ª–∏–¥–∞—Ü–∏–µ–π</h3>
                    </div>
                    <div class="card-body">
                        <form hx-post="{% url 'register_guest' %}"
                              hx-swap="outerHTML"
                              hx-target="#form-container"
                              hx-indicator="#form-spinner">
                            {% csrf_token %}
                            <div id="form-container">
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label class="form-label">–ò–º—è –≥–æ—Å—Ç—è</label>
                                            <input type="text" name="guest_name" class="form-control" 
                                                   hx-trigger="keyup changed delay:500ms"
                                                   hx-get="{% url 'employee_autocomplete' %}"
                                                   hx-target="#suggestions"
                                                   placeholder="–í–≤–µ–¥–∏—Ç–µ –∏–º—è –≥–æ—Å—Ç—è">
                                            <div id="suggestions" class="mt-2"></div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label class="form-label">–î–µ–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç</label>
                                            <select name="department" class="form-select"
                                                    hx-trigger="change"
                                                    hx-get="{% url 'get_department_details' %}"
                                                    hx-target="#dept-info">
                                                <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç</option>
                                                {% for dept in departments %}
                                                <option value="{{ dept.id }}">{{ dept.name }}</option>
                                                {% endfor %}
                                            </select>
                                            <div id="dept-info" class="mt-2"></div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="mb-3">
                                    <button type="submit" class="btn btn-primary">
                                        <span id="form-spinner" class="spinner-border spinner-border-sm me-2" style="display: none;"></span>
                                        –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å –≤–∏–∑–∏—Ç
                                    </button>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <!-- –°–µ–∫—Ü–∏—è —Å –ø–æ–∏—Å–∫–æ–º –∏ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–µ–π -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">–ü–æ–∏—Å–∫ —Å –∞–≤—Ç–æ–∫–æ–º–ø–ª–∏—Ç–æ–º</h3>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-8">
                                <input type="text" class="form-control" 
                                       placeholder="–ü–æ–∏—Å–∫ –ø–æ –∏–º–µ–Ω–∏ –≥–æ—Å—Ç—è..."
                                       hx-get="{% url 'visit_history' %}"
                                       hx-trigger="keyup changed delay:300ms"
                                       hx-target="#search-results"
                                       hx-indicator="#search-spinner"
                                       hx-push-url="true">
                            </div>
                            <div class="col-md-4">
                                <div id="search-spinner" class="text-center" style="display: none;">
                                    <div class="spinner-border spinner-border-sm text-primary"></div>
                                    –ü–æ–∏—Å–∫...
                                </div>
                            </div>
                        </div>
                        
                        <div id="search-results" class="mt-4">
                            <!-- –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ–∏—Å–∫–∞ –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è —Å—é–¥–∞ -->
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- –°–µ–∫—Ü–∏—è —Å –¥–µ–π—Å—Ç–≤–∏—è–º–∏ –∏ –æ–±—Ä–∞—Ç–Ω–æ–π —Å–≤—è–∑—å—é -->
        <div class="row mb-4">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">–ë—ã—Å—Ç—Ä—ã–µ –¥–µ–π—Å—Ç–≤–∏—è</h3>
                    </div>
                    <div class="card-body">
                        <div class="btn-group-vertical w-100" role="group">
                            <button type="button" class="btn btn-success"
                                    hx-post="{% url 'register_guest' %}"
                                    hx-trigger="click"
                                    hx-confirm="–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å —Ç–µ—Å—Ç–æ–≤—ã–π –≤–∏–∑–∏—Ç?"
                                    hx-swap="none">
                                ‚úÖ –ë—ã—Å—Ç—Ä–∞—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è
                            </button>
                            
                            <button type="button" class="btn btn-warning"
                                    hx-post="{% url 'get_counters_api' %}"
                                    hx-trigger="click"
                                    hx-swap="none">
                                üîÑ –û–±–Ω–æ–≤–∏—Ç—å —Å—á–µ—Ç—á–∏–∫–∏
                            </button>
                            
                            <button type="button" class="btn btn-info"
                                    onclick="window.HTMXUtils.showToast('–≠—Ç–æ —Ç–µ—Å—Ç–æ–≤–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ!', 'info')">
                                üí¨ –ü–æ–∫–∞–∑–∞—Ç—å —Ç–æ—Å—Ç
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">–ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª—è–µ–º—ã–µ –¥–∞–Ω–Ω—ã–µ</h3>
                    </div>
                    <div class="card-body">
                        <div hx-get="{% url 'get_counters_api' %}"
                             hx-trigger="every 5s"
                             hx-swap="innerHTML"
                             hx-indicator="#auto-update-spinner">
                            <div class="text-muted">–ó–∞–≥—Ä—É–∑–∫–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏...</div>
                        </div>
                        
                        <div id="auto-update-spinner" class="text-center mt-2" style="display: none;">
                            <div class="spinner-grow spinner-grow-sm text-primary"></div>
                            –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ...
                        </div>
                        
                        <div class="mt-3">
                            <button type="button" class="btn btn-sm btn-outline-secondary"
                                    onclick="window.HTMXUtils.stopPolling('#auto-update-container')">
                                ‚è∏Ô∏è –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∞–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- –°–µ–∫—Ü–∏—è —Å –∏–Ω—Ñ–∏–Ω–∏—Ç–Ω—ã–º —Å–∫—Ä–æ–ª–ª–æ–º -->
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">–ò—Å—Ç–æ—Ä–∏—è –≤–∏–∑–∏—Ç–æ–≤ —Å –ª–µ–Ω–∏–≤–æ–π –∑–∞–≥—Ä—É–∑–∫–æ–π</h3>
                    </div>
                    <div class="card-body">
                        <div id="visit-list">
                            <!-- –ü–µ—Ä–≤–æ–Ω–∞—á–∞–ª—å–Ω—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã -->
                            {% for visit in recent_visits|slice:":5" %}
                            <div class="d-flex align-items-center mb-2 p-2 border rounded">
                                <div class="avatar avatar-sm bg-azure-lt me-3">
                                    {{ visit.guest.full_name|slice:":2" }}
                                </div>
                                <div class="flex-fill">
                                    <div class="font-weight-medium">{{ visit.guest.full_name }}</div>
                                    <div class="text-muted small">{{ visit.entry_time|date:"d.m.Y H:i" }}</div>
                                </div>
                                <div class="text-end">
                                    <span class="badge bg-green">{{ visit.status }}</span>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                        
                        <!-- –¢—Ä–∏–≥–≥–µ—Ä –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ —Å–ª–µ–¥—É—é—â–∏—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤ -->
                        <div hx-get="{% url 'visit_history' %}?page=2"
                             hx-trigger="revealed"
                             hx-swap="afterend"
                             hx-target="#visit-list"
                             class="text-center mt-3">
                            <div class="spinner-border spinner-border-sm text-primary"></div>
                            –ó–∞–≥—Ä—É–∑–∫–∞ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –∑–∞–ø–∏—Å–µ–π...
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–∏ -->
<div class="modal" id="demo-modal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">HTMX –≤ –º–æ–¥–∞–ª—å–Ω–æ–º –æ–∫–Ω–µ</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" 
                 hx-get="{% url 'visit_history' %}"
                 hx-trigger="load"
                 hx-swap="innerHTML">
                <div class="text-center">
                    <div class="spinner-border text-primary"></div>
                    <div class="mt-2">–ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ...</div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // –î–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—è –ø—Ä–æ–≥—Ä–∞–º–º–Ω–æ–≥–æ –≤—ã–∑–æ–≤–∞ —Ç–æ—Å—Ç–æ–≤
    setTimeout(function() {
        if (window.HTMXUtils) {
            window.HTMXUtils.showToast('–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ –¥–µ–º–æ HTMX!', 'success');
        }
    }, 1000);
    
    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è —Å–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã—Ö —Å–æ–±—ã—Ç–∏–π
    document.addEventListener('htmx:afterSwap', function(event) {
        console.log('HTMX: –°–æ–¥–µ—Ä–∂–∏–º–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–æ', event.target);
    });
});
</script>
{% endblock %}
