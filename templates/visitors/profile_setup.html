{% extends "base.html" %}
{% load static %}

{% block title %}Настройка профиля{% endblock %}

{% block content %}
<div class="page-header d-print-none">
    <div class="container-xl">
        <div class="row g-2 justify-content-center text-center">
            <div class="col-md-8">
                <h2 class="page-title justify-content-center text-center">Настройка профиля</h2>
                <div class="text-muted mt-1 justify-content-center text-center">Завершите настройку вашего аккаунта</div>
            </div>
        </div>
    </div>
</div>

<div class="page-body">
    <div class="container-xl">
        <div class="row justify-content-center">
            <div class="col-lg-6">
                <div class="card">
                    <div class="card-body">
                        <div class="card-title">Завершение настройки профиля</div>
                        <div class="text-muted mb-4">Пожалуйста, укажите ваш рабочий телефон и выберите департамент для завершения настройки.</div>

                        {% if form.non_field_errors %}
                        <div class="alert alert-danger">
                            {% for error in form.non_field_errors %}{{ error }}{% if not forloop.last %}<br>{% endif %}{% endfor %}
                        </div>
                        {% endif %}

                        <form method="post" novalidate>
                            {% csrf_token %}
                            {% if request.GET.next %}
                                <input type="hidden" name="next" value="{{ request.GET.next }}">
                            {% endif %}

                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="guest_phone_masked" class="form-label required">Номер телефона:</label>
                                    <input type="text" id="guest_phone_masked" class="form-control" placeholder="+7 771 111 11 11" maxlength="16">
                                    {% if form.phone_number.errors %}
                                        <div class="invalid-feedback d-block">{% for e in form.phone_number.errors %}{{ e }}{% endfor %}</div>
                                    {% endif %}
                                    
                                    <!-- Скрытое поле для хранения значения без маски -->
                                    <input type="hidden" name="{{ form.phone_number.html_name }}" id="{{ form.phone_number.id_for_label }}" value="{{ form.phone_number.value|default:'' }}">
                                </div>
                            </div>

                            <div class="mb-3">
                                <label class="form-label" for="{{ form.department.id_for_label }}">
                                    {{ form.department.label }}
                                </label>
                                <div class="input-group input-group-flat">
                                    <span class="input-group-text">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="icon" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                                            <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
                                            <path d="M3 21l18 0"></path>
                                            <path d="M9 8l1 0"></path>
                                            <path d="M9 12l1 0"></path>
                                            <path d="M9 16l1 0"></path>
                                            <path d="M14 8l1 0"></path>
                                            <path d="M14 12l1 0"></path>
                                            <path d="M14 16l1 0"></path>
                                            <path d="M5 21v-16a2 2 0 0 1 2 -2h10a2 2 0 0 1 2 2v16"></path>
                                        </svg>
                                    </span>
                                    {{ form.department }}
                                </div>
                                {% if form.department.help_text %}
                                    <div class="form-text">{{ form.department.help_text }}</div>
                                {% endif %}
                                {% if form.department.errors %}
                                    <div class="invalid-feedback d-block">{% for e in form.department.errors %}{{e}}{% endfor %}</div>
                                {% endif %}
                            </div>

                            <div class="form-footer">
                                <button type="submit" class="btn btn-primary w-100">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="icon" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                                        <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
                                        <path d="M5 12l5 5l10 -10"></path>
                                    </svg>
                                    Сохранить и продолжить
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
                <div class="text-center mt-3">
                    <form action="{% url 'account_logout' %}" method="post" class="d-inline">
                        {% csrf_token %}
                        <button type="submit" class="btn btn-link">
                            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-logout" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                                <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
                                <path d="M14 8v-2a2 2 0 0 0 -2 -2h-7a2 2 0 0 0 -2 2v12a2 2 0 0 0 2 2h7a2 2 0 0 0 2 -2v-2"></path>
                                <path d="M9 12h12l-3 -3"></path>
                                <path d="M18 15l3 -3"></path>
                            </svg>
                            Выйти
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {

        // Маска для телефона
        const phoneMaskElement = document.getElementById('guest_phone_masked');
        const phoneHiddenElement = document.getElementById('{{ form.phone_number.id_for_label }}');
        
        if (phoneMaskElement && phoneHiddenElement) {
            const phoneMask = IMask(phoneMaskElement, {
                mask: '+{7} 000 000 00 00',
                lazy: false
            });
            
            // Инициализация значением из hidden-поля, если оно есть
            if (phoneHiddenElement.value) {
                // Форматируем значение, убирая все, кроме цифр
                let phoneValue = phoneHiddenElement.value.replace(/\D/g, '');
                if (phoneValue.startsWith('7')) {
                    phoneMask.unmaskedValue = phoneValue.substring(1); // убираем код страны в маске
                } else if (phoneValue.startsWith('8') && phoneValue.length === 11) {
                    phoneMask.unmaskedValue = '7' + phoneValue.substring(1);
                } else {
                    phoneMask.unmaskedValue = phoneValue;
                }
            }
              // Обновление hidden-поля при вводе
            phoneMaskElement.addEventListener('input', function() {
                // Сохраняем строго в формате +7XXXXXXXXXX
                let d = phoneMask.unmaskedValue.replace(/\D/g, '');
                if (d.length === 11 && d.startsWith('8')) d = '7' + d.substring(1);
                if (d.length === 10) d = '7' + d;
                if (d.startsWith('7')) {
                    phoneHiddenElement.value = '+7' + d.substring(1);
                }
                
                // Визуальная валидация номера телефона
                validatePhoneNumber();
            });
            
            // Функция для валидации номера телефона
            function validatePhoneNumber() {
                // Номер считается валидным, если в нем ровно 10 цифр (без учета +7)
                const isValid = phoneMask.unmaskedValue && phoneMask.unmaskedValue.length === 10;
                
                if (phoneMask.unmaskedValue.length > 0) {
                    if (isValid) {
                        phoneMaskElement.classList.remove('is-invalid');
                        phoneMaskElement.classList.add('is-valid');
                    } else {
                        phoneMaskElement.classList.remove('is-valid');
                        phoneMaskElement.classList.add('is-invalid');
                    }
                } else {
                    // Если поле пустое, убираем все классы валидации
                    phoneMaskElement.classList.remove('is-valid', 'is-invalid');
                }
                
                return isValid;
            }
            
            // Проверка при потере фокуса
            phoneMaskElement.addEventListener('blur', validatePhoneNumber);
            
            // Проверка при отправке формы
            const form = phoneMaskElement.closest('form');
            if (form) {
                form.addEventListener('submit', function(e) {
                    if (!validatePhoneNumber() && phoneMask.unmaskedValue.length > 0) {
                        e.preventDefault();
                        phoneMaskElement.focus();
                    }
                });
            }
            
            // Начальная валидация
            if (phoneMask.unmaskedValue.length > 0) {
                validatePhoneNumber();
            }
        }
        // Классика: добавить классы Bootstrap и проставить invalid для ошибок
        document.querySelectorAll('form input:not([type=hidden]), form select').forEach(function(control) {
            if (control.tagName === 'SELECT') {
                if (!control.classList.contains('form-select')) {
                    control.classList.add('form-select');
                }
            } else {
                if (!control.classList.contains('form-control')) {
                    control.classList.add('form-control');
                }
            }
            const errorDiv = control.closest('.mb-3')?.querySelector('.invalid-feedback');
            if (errorDiv && errorDiv.innerText.trim() !== '') {
                control.classList.add('is-invalid');
            } else {
                control.classList.remove('is-invalid');
            }
        });
    });


</script>
{% endblock %}