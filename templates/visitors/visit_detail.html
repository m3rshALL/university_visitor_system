{% extends "base.html" %}
{% load static %} {# Можно добавить, если нужны статические файлы #}

{% block title %}Детали визита №{{ visit.id }}{% endblock %}

{% block content %}
<h2>Детали визита №{{ visit.id }}</h2>
<hr>

<div class="row">
    {# --- Информация о госте --- #}
    <div class="col-md-6 mb-3">
        <div class="card">
            <div class="card-header">
                Информация о госте
            </div>
            <div class="card-body">
                <dl class="row mb-0">
                    <dt class="col-sm-4">ФИО:</dt>
                    <dd class="col-sm-8">{{ visit.guest.full_name }}</dd>

                    <dt class="col-sm-4">ИИН:</dt>
                    <dd class="col-sm-8">{{ visit.guest.iin|default:"Не указан" }}</dd>

                    <dt class="col-sm-4">Телефон:</dt>
                    <dd class="col-sm-8">{{ visit.guest.phone_number|default:"Не указан" }}</dd>

                    <dt class="col-sm-4">Email:</dt>
                    <dd class="col-sm-8">{{ visit.guest.email|default:"Не указан" }}</dd>
                </dl>
            </div>
        </div>
    </div>
    {# ------------------------- #}

    {# --- Информация о визите --- #}
    <div class="col-md-6 mb-3">
        <div class="card">
            <div class="card-header">
                Информация о визите
            </div>
            <div class="card-body">
                <dl class="row mb-0">
                    <dt class="col-sm-4">Время входа:</dt>
                    <dd class="col-sm-8">
                        {% if visit.entry_time %} {{ visit.entry_time|date:"Y-m-d H:i" }}
                        {% elif visit.status == 'AWAITING' %} {# Используйте ваше значение STATUS_AWAITING_ARRIVAL #}
                            {% if visit.expected_entry_time %} <span class="text-muted fst-italic" title="Планируемое">Ожид: {{ visit.expected_entry_time|date:"Y-m-d H:i" }}</span>
                            {% else %} <span class="text-muted fst-italic">Ожидается</span> {% endif %}
                        {% elif visit.status == 'CANCELLED' %} {# Используйте ваше значение STATUS_CANCELLED #}
                            <span class="badge bg-danger">Отменен</span>
                        {% else %} - {% endif %}
                    </dd>

                    <dt class="col-sm-4">Время выхода:</dt>
                    <dd class="col-sm-8">
                        {# --- ИСПРАВЛЕННАЯ Ячейка для Времени Выхода --- #}
                    <td>
                        {% if visit.exit_time %} {{ visit.exit_time|date:"Y-m-d H:i" }}
                        {% elif visit.status == 'CHECKED_IN' %} <span class="badge bg-success">В здании</span>
                        {% elif visit.status == 'AWAITING' %} <span class="text-muted">-</span> {# Ожидающим не показываем статус выхода #}
                        {% elif visit.status == 'CANCELLED' %} <span class="text-muted">-</span> {# Отмененным тоже #}
                        {% else %} <span class="text-muted">-</span> {% endif %}
                    </td>
                    {# ------------------------------------------- #}
                    </dd>

                    <dt class="col-sm-4">Цель визита:</dt>
                    <dd class="col-sm-8">{{ visit.purpose|default:"Не указана" }}</dd>

                    <dt class="col-sm-4">Департамент:</dt>
                    <dd class="col-sm-8">{{ visit.department.name }}</dd>

                    <dt class="col-sm-4">Принимающий:</dt>
                    <dd class="col-sm-8">{{ visit.employee.get_full_name|default:visit.employee.username }}</dd>

                    <dt class="col-sm-4">Email сотрудника:</dt>
                    <dd class="col-sm-8">{{ visit.employee.email|default:"Не указан" }}</dd>

                    <dt class="col-sm-4">Конт. тел. (визит):</dt>
                    <dd class="col-sm-8">{{ visit.employee_contact_phone|default:"Не указан" }}</dd>

                    <dt class="col-sm-4">Кем зарегистрирован:</dt>
                    <dd class="col-sm-8">{{ visit.registered_by.get_full_name|default:visit.registered_by.username }}</dd>

                </dl>
            </div>
        </div>
    </div>
    {# ------------------------ #}

</div>

<div class="mt-3">
    <a href="{% url 'visit_history' %}" class="btn btn-secondary">
        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-arrow-left" viewBox="0 0 16 16">
          <path fill-rule="evenodd" d="M15 8a.5.5 0 0 0-.5-.5H2.707l3.147-3.146a.5.5 0 1 0-.708-.708l-4 4a.5.5 0 0 0 0 .708l4 4a.5.5 0 0 0 .708-.708L2.707 8.5H14.5A.5.5 0 0 0 15 8z"/>
        </svg>
        Назад к истории визитов
    </a>
    {% if not visit.exit_time %}
        {# Можно добавить кнопку "Гость вышел" и сюда, если нужно #}
        <form action="{% url 'mark_guest_exit' visit.id %}" method="post" class="d-inline ms-2">
            {% csrf_token %}
            <button type="submit" class="btn btn-warning">Гость вышел</button>
        </form>
    {% endif %}
</div>

{% endblock %}