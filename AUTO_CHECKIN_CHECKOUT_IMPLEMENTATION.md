# –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π Check-in/Checkout —á–µ—Ä–µ–∑ —Ç—É—Ä–Ω–∏–∫–µ—Ç—ã HikVision

**–î–∞—Ç–∞:** 14.10.2025  
**–ú–µ—Ç–æ–¥:** Sequential Thinking Analysis  
**–°—Ç–∞—Ç—É—Å:** ‚úÖ **–£–ñ–ï –†–ï–ê–õ–ò–ó–û–í–ê–ù–û –ò –†–ê–ë–û–¢–ê–ï–¢!**

---

## üéâ –•–û–†–û–®–ò–ï –ù–û–í–û–°–¢–ò!

–§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª **–ê–í–¢–û–ú–ê–¢–ò–ß–ï–°–ö–û–ì–û CHECK-IN/OUT** —É–∂–µ **–ü–û–õ–ù–û–°–¢–¨–Æ –†–ï–ê–õ–ò–ó–û–í–ê–ù** –∏ —Ä–∞–±–æ—Ç–∞–µ—Ç!

---

## ‚úÖ –ß–¢–û –£–ñ–ï –†–ê–ë–û–¢–ê–ï–¢

### 1. –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π Check-in (–í—Ö–æ–¥)

**–ö–æ–≥–¥–∞:** –ì–æ—Å—Ç—å –ø—Ä–æ—Ö–æ–¥–∏—Ç —á–µ—Ä–µ–∑ —Ç—É—Ä–Ω–∏–∫–µ—Ç –ø–æ Face ID (–≤—Ö–æ–¥)

**–ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç:**
```python
# –°—Ç—Ä–æ–∫–∏ 873-906 –≤ tasks.py
if visit.status == 'EXPECTED':
    visit.status = 'CHECKED_IN'  # ‚Üê –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è —Å–º–µ–Ω–∞ —Å—Ç–∞—Ç—É—Å–∞
    visit.entry_time = first_entry_time  # ‚Üê –í—Ä–µ–º—è –≤—Ö–æ–¥–∞ –∏–∑ —Ç—É—Ä–Ω–∏–∫–µ—Ç–∞
    
    # –°–æ–∑–¥–∞–µ—Ç—Å—è AuditLog
    AuditLog.objects.create(
        user_agent='HikCentral FaceID System',
        changes={
            'reason': 'Auto check-in via FaceID turnstile',
            'old_status': 'EXPECTED',
            'new_status': 'CHECKED_IN',
            'entry_time': first_entry_time.isoformat()
        }
    )
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**
- ‚úÖ –°—Ç–∞—Ç—É—Å: `EXPECTED` ‚Üí `CHECKED_IN`
- ‚úÖ –í—Ä–µ–º—è –≤—Ö–æ–¥–∞: –¢–æ—á–Ω–æ–µ –≤—Ä–µ–º—è –ø—Ä–æ—Ö–æ–¥–∞ —á–µ—Ä–µ–∑ —Ç—É—Ä–Ω–∏–∫–µ—Ç
- ‚úÖ AuditLog: –ü–æ–ª–Ω–∞—è –∏—Å—Ç–æ—Ä–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π
- ‚úÖ –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ: –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –ø—Ä–∏–Ω–∏–º–∞—é—â–µ–º—É —Å–æ—Ç—Ä—É–¥–Ω–∏–∫—É

---

### 2. –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π Checkout (–í—ã—Ö–æ–¥)

**–ö–æ–≥–¥–∞:** –ì–æ—Å—Ç—å –ø—Ä–æ—Ö–æ–¥–∏—Ç —á–µ—Ä–µ–∑ —Ç—É—Ä–Ω–∏–∫–µ—Ç –ø–æ Face ID (–≤—ã—Ö–æ–¥)

**–ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç:**
```python
# –°—Ç—Ä–æ–∫–∏ 916-949 –≤ tasks.py
if visit.status == 'CHECKED_IN':
    visit.status = 'CHECKED_OUT'  # ‚Üê –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è —Å–º–µ–Ω–∞ —Å—Ç–∞—Ç—É—Å–∞
    visit.exit_time = first_exit_time  # ‚Üê –í—Ä–µ–º—è –≤—ã—Ö–æ–¥–∞ –∏–∑ —Ç—É—Ä–Ω–∏–∫–µ—Ç–∞
    
    # –°–æ–∑–¥–∞–µ—Ç—Å—è AuditLog
    AuditLog.objects.create(
        user_agent='HikCentral FaceID System',
        changes={
            'reason': 'Auto checkout via FaceID turnstile',
            'old_status': 'CHECKED_IN',
            'new_status': 'CHECKED_OUT',
            'exit_time': first_exit_time.isoformat()
        }
    )
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**
- ‚úÖ –°—Ç–∞—Ç—É—Å: `CHECKED_IN` ‚Üí `CHECKED_OUT`
- ‚úÖ –í—Ä–µ–º—è –≤—ã—Ö–æ–¥–∞: –¢–æ—á–Ω–æ–µ –≤—Ä–µ–º—è –ø—Ä–æ—Ö–æ–¥–∞ —á–µ—Ä–µ–∑ —Ç—É—Ä–Ω–∏–∫–µ—Ç
- ‚úÖ AuditLog: –ü–æ–ª–Ω–∞—è –∏—Å—Ç–æ—Ä–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π
- ‚úÖ –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ: –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –ø—Ä–∏–Ω–∏–º–∞—é—â–µ–º—É —Å–æ—Ç—Ä—É–¥–Ω–∏–∫—É
- ‚úÖ **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –æ—Ç–∑—ã–≤ –¥–æ—Å—Ç—É–ø–∞** –∫ —Ç—É—Ä–Ω–∏–∫–µ—Ç–∞–º

---

### 3. –ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∞—è –∑–∞–¥–∞—á–∞ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞

**–ó–∞–¥–∞—á–∞:** `monitor_guest_passages_task`  
**–§–∞–π–ª:** `visitor_system/hikvision_integration/tasks.py` (—Å—Ç—Ä–æ–∫–∏ 694-1033)

**–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è:**
```python
# visitor_system/visitor_system/celery.py
'monitor-guest-passages': {
    'task': 'hikvision_integration.tasks.monitor_guest_passages_task',
    'schedule': crontab(minute='*/5'),  # –ö–∞–∂–¥—ã–µ 5 –º–∏–Ω—É—Ç
}
```

**–ß—Ç–æ –¥–µ–ª–∞–µ—Ç:**
1. –ü–æ–ª—É—á–∞–µ—Ç –≤—Å–µ –∞–∫—Ç–∏–≤–Ω—ã–µ –≤–∏–∑–∏—Ç—ã (`access_granted=True`, `access_revoked=False`)
2. –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ—Ç —Å–æ–±—ã—Ç–∏—è —Ç—É—Ä–Ω–∏–∫–µ—Ç–æ–≤ –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 5 –º–∏–Ω—É—Ç —á–µ—Ä–µ–∑ HikCentral API
3. –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç —Å–æ–±—ã—Ç–∏—è –≤—Ö–æ–¥–∞/–≤—ã—Ö–æ–¥–∞ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –≥–æ—Å—Ç—è
4. –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–±–Ω–æ–≤–ª—è–µ—Ç —Å—Ç–∞—Ç—É—Å—ã –≤–∏–∑–∏—Ç–æ–≤
5. –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
6. –°–æ–∑–¥–∞–µ—Ç AuditLog –¥–ª—è –ø—Ä–æ—Å–ª–µ–∂–∏–≤–∞–µ–º–æ—Å—Ç–∏

---

## üîå –ò–°–ü–û–õ–¨–ó–£–ï–ú–´–ï API

### HikCentral Professional OpenAPI

**Endpoint:** `/artemis/api/acs/v1/door/events`  
**–ú–µ—Ç–æ–¥:** POST  
**–§–∞–π–ª:** `services.py` (—Å—Ç—Ä–æ–∫–∏ 1449-1537)

**–ü–∞—Ä–∞–º–µ—Ç—Ä—ã –∑–∞–ø—Ä–æ—Å–∞:**
```json
{
  "startTime": "2025-10-14T10:00:00+00:00",
  "endTime": "2025-10-14T10:05:00+00:00",
  "pageNo": 1,
  "pageSize": 1000,
  "doorIndexCodes": [],  // –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ - –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –¥–≤–µ—Ä–∏
  "eventType": null,     // null = –≤—Å–µ —Ç–∏–ø—ã —Å–æ–±—ã—Ç–∏–π
  "personId": null,      // null = –≤—Å–µ –≥–æ—Å—Ç–∏ (–±–∞—Ç—á–∏–Ω–≥!)
  "personName": null
}
```

**–û—Ç–≤–µ—Ç API:**
```json
{
  "code": "0",
  "msg": "Success",
  "data": {
    "total": 150,
    "pageNo": 1,
    "pageSize": 1000,
    "list": [
      {
        "eventId": "12345",
        "personId": "8512",
        "personName": "–ò–≤–∞–Ω–æ–≤ –ò–≤–∞–Ω",
        "eventType": 1,  // 1 = –í—Ö–æ–¥, 2 = –í—ã—Ö–æ–¥
        "eventTime": "2025-10-14T10:02:35+00:00",
        "doorIndexCode": "1",
        "doorName": "–ì–ª–∞–≤–Ω—ã–π –≤—Ö–æ–¥",
        "deviceName": "–¢—É—Ä–Ω–∏–∫–µ—Ç ‚Ññ1"
      }
    ]
  }
}
```

**Event Types:**
- `1` - **–í—Ö–æ–¥** (Entry)
- `2` - **–í—ã—Ö–æ–¥** (Exit)

---

## üöÄ –¢–ï–ö–£–©–ê–Ø –ê–†–•–ò–¢–ï–ö–¢–£–†–ê

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                    HikVision –¢—É—Ä–Ω–∏–∫–µ—Ç                        ‚îÇ
‚îÇ                  (Face Recognition)                          ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                 ‚îÇ Face ID —Ä–∞—Å–ø–æ–∑–Ω–∞–Ω
                 ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ               HikCentral Professional                        ‚îÇ
‚îÇ          (–°–æ—Ö—Ä–∞–Ω—è–µ—Ç —Å–æ–±—ã—Ç–∏—è –ø—Ä–æ—Ö–æ–¥–æ–≤)                        ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                 ‚îÇ –ö–∞–∂–¥—ã–µ 5 –º–∏–Ω—É—Ç
                 ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ         monitor_guest_passages_task (Celery)                 ‚îÇ
‚îÇ  GET /artemis/api/acs/v1/door/events (last 5 min)           ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                 ‚îÇ
                 ‚îú‚îÄ‚ñ∫ Event Type = 1 (–í—Ö–æ–¥)
                 ‚îÇ   ‚îî‚îÄ‚ñ∫ Visit: EXPECTED ‚Üí CHECKED_IN
                 ‚îÇ       entry_time = event.eventTime
                 ‚îÇ
                 ‚îî‚îÄ‚ñ∫ Event Type = 2 (–í—ã—Ö–æ–¥)
                     ‚îî‚îÄ‚ñ∫ Visit: CHECKED_IN ‚Üí CHECKED_OUT
                         exit_time = event.eventTime
                         –û—Ç–∑—ã–≤ –¥–æ—Å—Ç—É–ø–∞
```

---

## üí° –ü–†–ï–î–õ–û–ñ–ï–ù–ò–Ø –ü–û –£–õ–£–ß–®–ï–ù–ò–Æ

### 1Ô∏è‚É£ –£–º–µ–Ω—å—à–∏—Ç—å –∑–∞–¥–µ—Ä–∂–∫—É –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞

**–ü—Ä–æ–±–ª–µ–º–∞:** –¢–µ–∫—É—â–∏–π –∏–Ω—Ç–µ—Ä–≤–∞–ª 5 –º–∏–Ω—É—Ç ‚Üí –∑–∞–¥–µ—Ä–∂–∫–∞ –¥–æ 5 –º–∏–Ω—É—Ç

**–†–µ—à–µ–Ω–∏–µ:**
```python
# visitor_system/visitor_system/celery.py
'monitor-guest-passages': {
    'task': 'hikvision_integration.tasks.monitor_guest_passages_task',
    'schedule': crontab(minute='*/1'),  # ‚Üê –ö–∞–∂–¥—É—é 1 –º–∏–Ω—É—Ç—É
}
```

**–ò–ª–∏ –±–æ–ª–µ–µ —á–∞—Å—Ç—ã–π:**
```python
from celery.schedules import crontab

'monitor-guest-passages': {
    'task': 'hikvision_integration.tasks.monitor_guest_passages_task',
    'schedule': 30,  # ‚Üê –ö–∞–∂–¥—ã–µ 30 —Å–µ–∫—É–Ω–¥
}
```

**–ü–ª—é—Å—ã:**
- ‚ö° –ë—ã—Å—Ç—Ä–∞—è —Ä–µ–∞–∫—Ü–∏—è (30 —Å–µ–∫ - 1 –º–∏–Ω –≤–º–µ—Å—Ç–æ 5 –º–∏–Ω)
- üìä –ë–æ–ª–µ–µ —Ç–æ—á–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞

**–ú–∏–Ω—É—Å—ã:**
- üìà –ë–æ–ª—å—à–µ API –∑–∞–ø—Ä–æ—Å–æ–≤ (–Ω–æ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –±–∞—Ç—á–∏–Ω–≥–∞ —Ä–µ—à–∞–µ—Ç —ç—Ç–æ)

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:** üü¢ **1-2 –º–∏–Ω—É—Ç—ã –æ–ø—Ç–∏–º–∞–ª—å–Ω–æ**

---

### 2Ô∏è‚É£ Real-time Webhooks (–∏–¥–µ–∞–ª—å–Ω–æ)

**–ò–¥–µ—è:** HikCentral –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç webhook –ø—Ä–∏ —Å–æ–±—ã—Ç–∏–∏ ‚Üí –º–≥–Ω–æ–≤–µ–Ω–Ω–∞—è —Ä–µ–∞–∫—Ü–∏—è

**–ü—Ä–æ–≤–µ—Ä–∏—Ç—å:** –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –ª–∏ HikCentral webhook –¥–ª—è door events?

**–ï—Å–ª–∏ –î–ê:**
```python
# visitor_system/hikvision_integration/views.py
from django.views.decorators.csrf import csrf_exempt

@csrf_exempt
def hikcentral_webhook(request):
    """–û–±—Ä–∞–±–æ—Ç–∫–∞ webhook –æ—Ç HikCentral –ø—Ä–∏ –ø—Ä–æ—Ö–æ–¥–µ —á–µ—Ä–µ–∑ —Ç—É—Ä–Ω–∏–∫–µ—Ç."""
    data = json.loads(request.body)
    
    event_type = data.get('eventType')  # 1=–í—Ö–æ–¥, 2=–í—ã—Ö–æ–¥
    person_id = data.get('personId')
    event_time = data.get('eventTime')
    
    # –ù–∞–π—Ç–∏ –≤–∏–∑–∏—Ç –ø–æ person_id
    visit = Visit.objects.filter(
        hikcentral_person_id=person_id,
        access_granted=True,
        access_revoked=False
    ).first()
    
    if event_type == 1 and visit.status == 'EXPECTED':
        # –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π check-in
        visit.status = 'CHECKED_IN'
        visit.entry_time = event_time
        visit.save()
    
    elif event_type == 2 and visit.status == 'CHECKED_IN':
        # –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π checkout
        visit.status = 'CHECKED_OUT'
        visit.exit_time = event_time
        visit.save()
    
    return JsonResponse({'status': 'ok'})
```

**–ü–ª—é—Å—ã:**
- ‚ö°‚ö°‚ö° –ú–≥–Ω–æ–≤–µ–Ω–Ω–∞—è —Ä–µ–∞–∫—Ü–∏—è (—Å–µ–∫—É–Ω–¥—ã)
- üìâ –ú–µ–Ω—å—à–µ API –∑–∞–ø—Ä–æ—Å–æ–≤
- üí∞ –≠–∫–æ–Ω–æ–º–∏—è —Ä–µ—Å—É—Ä—Å–æ–≤

**–ú–∏–Ω—É—Å—ã:**
- üîí –ù—É–∂–Ω–∞ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ webhook –≤ HikCentral
- üåê –ü—É–±–ª–∏—á–Ω—ã–π URL –∏–ª–∏ ngrok

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:** üü¢ **–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é HikCentral**

---

### 3Ô∏è‚É£ Dashboard –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞

**–ò–¥–µ—è:** –°—Ç—Ä–∞–Ω–∏—Ü–∞ —Å real-time –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–æ–º –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏—Ö –¥–µ–π—Å—Ç–≤–∏–π

**–§—É–Ω–∫—Ü–∏–∏:**
- üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏—Ö check-in/out –∑–∞ –¥–µ–Ω—å/–Ω–µ–¥–µ–ª—é/–º–µ—Å—è—Ü
- üìà –ì—Ä–∞—Ñ–∏–∫ –ø—Ä–æ—Ö–æ–¥–æ–≤ —á–µ—Ä–µ–∑ —Ç—É—Ä–Ω–∏–∫–µ—Ç—ã
- ‚è±Ô∏è –°—Ä–µ–¥–Ω–µ–µ –≤—Ä–µ–º—è –ø—Ä–µ–±—ã–≤–∞–Ω–∏—è –≥–æ—Å—Ç–µ–π
- ‚ö†Ô∏è –ê–Ω–æ–º–∞–ª–∏–∏ (–≤—ã—Ö–æ–¥ –±–µ–∑ –≤—Ö–æ–¥–∞, –¥–æ–ª–≥–æ–µ –ø—Ä–µ–±—ã–≤–∞–Ω–∏–µ)

**–†–µ–∞–ª–∏–∑–∞—Ü–∏—è:**
```python
# visitor_system/visitors/views.py
def auto_checkin_dashboard(request):
    """Dashboard –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏—Ö –¥–µ–π—Å—Ç–≤–∏–π."""
    today = timezone.now().date()
    
    # –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ check-in –∑–∞ —Å–µ–≥–æ–¥–Ω—è
    auto_checkins = AuditLog.objects.filter(
        model='Visit',
        action=AuditLog.ACTION_UPDATE,
        user_agent='HikCentral FaceID System',
        created_at__date=today,
        changes__reason='Auto check-in via FaceID turnstile'
    ).count()
    
    # –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ checkouts
    auto_checkouts = AuditLog.objects.filter(
        model='Visit',
        action=AuditLog.ACTION_UPDATE,
        user_agent='HikCentral FaceID System',
        created_at__date=today,
        changes__reason='Auto checkout via FaceID turnstile'
    ).count()
    
    # –ì—Ä–∞—Ñ–∏–∫ –ø–æ —á–∞—Å–∞–º
    hourly_stats = AuditLog.objects.filter(
        created_at__date=today,
        user_agent='HikCentral FaceID System'
    ).extra({'hour': "date_part('hour', created_at)"}).values('hour').annotate(
        count=Count('id')
    ).order_by('hour')
    
    return render(request, 'visitors/auto_checkin_dashboard.html', {
        'auto_checkins': auto_checkins,
        'auto_checkouts': auto_checkouts,
        'hourly_stats': hourly_stats
    })
```

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:** üü¢ **–ü–æ–ª–µ–∑–Ω–æ –¥–ª—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∏**

---

### 4Ô∏è‚É£ –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –≤ –∞–¥–º–∏–Ω–∫–µ

**–ò–¥–µ—è:** –í–∫–ª—é—á–∏—Ç—å/–≤—ã–∫–ª—é—á–∏—Ç—å –∞–≤—Ç–æ–º–∞—Ç–∏–∫—É –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏—è –∫–æ–¥–∞

**–†–µ–∞–ª–∏–∑–∞—Ü–∏—è:**
```python
# visitor_system/visitors/models.py
class SystemSettings(models.Model):
    """–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–∏—Å—Ç–µ–º—ã."""
    auto_checkin_enabled = models.BooleanField(
        default=True,
        verbose_name='–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π check-in —á–µ—Ä–µ–∑ —Ç—É—Ä–Ω–∏–∫–µ—Ç'
    )
    auto_checkout_enabled = models.BooleanField(
        default=True,
        verbose_name='–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π checkout —á–µ—Ä–µ–∑ —Ç—É—Ä–Ω–∏–∫–µ—Ç'
    )
    monitoring_interval = models.IntegerField(
        default=5,
        verbose_name='–ò–Ω—Ç–µ—Ä–≤–∞–ª –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ (–º–∏–Ω—É—Ç—ã)',
        choices=[(1, '1 –º–∏–Ω—É—Ç–∞'), (2, '2 –º–∏–Ω—É—Ç—ã'), (5, '5 –º–∏–Ω—É—Ç'), (10, '10 –º–∏–Ω—É—Ç')]
    )

# –í tasks.py
settings = SystemSettings.objects.first()
if settings and settings.auto_checkin_enabled:
    # –í—ã–ø–æ–ª–Ω—è—Ç—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π check-in
    pass
```

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:** üü° **Nice to have**

---

### 5Ô∏è‚É£ –†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è

**–ò–¥–µ—è:** Email/SMS –ø—Ä–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏—Ö –¥–µ–π—Å—Ç–≤–∏—è—Ö

**–ö–æ–≥–¥–∞ —É–≤–µ–¥–æ–º–ª—è—Ç—å:**
- ‚úÖ Check-in –≥–æ—Å—Ç—è ‚Üí Email/SMS –ø—Ä–∏–Ω–∏–º–∞—é—â–µ–º—É —Å–æ—Ç—Ä—É–¥–Ω–∏–∫—É
- ‚úÖ Checkout –≥–æ—Å—Ç—è ‚Üí Email/SMS –ø—Ä–∏–Ω–∏–º–∞—é—â–µ–º—É —Å–æ—Ç—Ä—É–¥–Ω–∏–∫—É
- ‚ö†Ô∏è –ê–Ω–æ–º–∞–ª–∏—è (–≤—ã—Ö–æ–¥ –±–µ–∑ –≤—Ö–æ–¥–∞) ‚Üí Email –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É
- ‚è∞ –î–æ–ª–≥–æ–µ –ø—Ä–µ–±—ã–≤–∞–Ω–∏–µ (>8 —á–∞—Å–æ–≤) ‚Üí Email –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É

**–†–µ–∞–ª–∏–∑–∞—Ü–∏—è:** –£–∂–µ —á–∞—Å—Ç–∏—á–Ω–æ –µ—Å—Ç—å (—Å—Ç—Ä–æ–∫–∏ 932-968 –≤ tasks.py)

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:** üü¢ **–†–∞—Å—à–∏—Ä–∏—Ç—å –¥–ª—è SMS**

---

### 6Ô∏è‚É£ –û–±—Ä–∞–±–æ—Ç–∫–∞ –∞–Ω–æ–º–∞–ª–∏–π

**–¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ:** –ï—Å—Ç—å warning –≤ –ª–æ–≥–∞—Ö (—Å—Ç—Ä–æ–∫–∞ 953)

**–£–ª—É—á—à–µ–Ω–∏–µ:**
```python
# –ê–Ω–æ–º–∞–ª–∏—è: –≤—ã—Ö–æ–¥ –ë–ï–ó –≤—Ö–æ–¥–∞
elif visit.status == 'EXPECTED':
    logger.warning("EXIT without ENTRY detected")
    
    # –û—Ç–ø—Ä–∞–≤–∏—Ç—å alert –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É
    send_anomaly_alert(
        visit=visit,
        anomaly_type='exit_without_entry',
        event_time=first_exit_time
    )
    
    # –°–æ–∑–¥–∞—Ç—å –∑–∞–ø–∏—Å—å –≤ SecurityIncident
    SecurityIncident.objects.create(
        visit=visit,
        incident_type='anomaly_exit_without_entry',
        description=f'–í—ã—Ö–æ–¥ –æ–±–Ω–∞—Ä—É–∂–µ–Ω –±–µ–∑ –≤—Ö–æ–¥–∞',
        detected_at=first_exit_time
    )
```

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:** üü¢ **–í–∞–∂–Ω–æ –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏**

---

## üìã –ü–õ–ê–ù –†–ï–ê–õ–ò–ó–ê–¶–ò–ò –£–õ–£–ß–®–ï–ù–ò–ô

### –§–∞–∑–∞ 1: –ë—ã—Å—Ç—Ä—ã–µ —É–ª—É—á—à–µ–Ω–∏—è (1-2 —á–∞—Å–∞)

1. ‚úÖ **–£–º–µ–Ω—å—à–∏—Ç—å –∏–Ω—Ç–µ—Ä–≤–∞–ª –¥–æ 1-2 –º–∏–Ω—É—Ç**
   ```python
   # celery.py
   'schedule': crontab(minute='*/1')  # –ö–∞–∂–¥—É—é –º–∏–Ω—É—Ç—É
   ```

2. ‚úÖ **–î–æ–±–∞–≤–∏—Ç—å —Å—á–µ—Ç—á–∏–∫–∏ –Ω–∞ dashboard**
   - –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ check-in –∑–∞ –¥–µ–Ω—å
   - –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ checkout –∑–∞ –¥–µ–Ω—å
   - –ì—Ä–∞—Ñ–∏–∫ –ø–æ —á–∞—Å–∞–º

3. ‚úÖ **–†–∞—Å—à–∏—Ä–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è**
   - SMS –ø—Ä–∏ check-in/out (–µ—Å–ª–∏ –µ—Å—Ç—å —Ç–µ–ª–µ—Ñ–æ–Ω)
   - Email alert –ø—Ä–∏ –∞–Ω–æ–º–∞–ª–∏—è—Ö

---

### –§–∞–∑–∞ 2: –°—Ä–µ–¥–Ω–∏–µ —É–ª—É—á—à–µ–Ω–∏—è (1-2 –¥–Ω—è)

4. ‚ö° **Dashboard –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏—Ö –¥–µ–π—Å—Ç–≤–∏–π**
   - Real-time —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
   - –ì—Ä–∞—Ñ–∏–∫ –ø—Ä–æ—Ö–æ–¥–æ–≤
   - –°–ø–∏—Å–æ–∫ –∞–Ω–æ–º–∞–ª–∏–π

5. ‚ö° **–û–±—Ä–∞–±–æ—Ç–∫–∞ –∞–Ω–æ–º–∞–ª–∏–π**
   - SecurityIncident –º–æ–¥–µ–ª—å
   - Alerts –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞–º
   - –û—Ç—á–µ—Ç—ã –ø–æ –∞–Ω–æ–º–∞–ª–∏—è–º

6. ‚ö° **–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –≤ –∞–¥–º–∏–Ω–∫–µ**
   - –í–∫–ª—é—á–∏—Ç—å/–≤—ã–∫–ª—é—á–∏—Ç—å –∞–≤—Ç–æ–º–∞—Ç–∏–∫—É
   - –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∏–Ω—Ç–µ—Ä–≤–∞–ª–∞
   - –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π

---

### –§–∞–∑–∞ 3: –î–æ–ª–≥–æ—Å—Ä–æ—á–Ω—ã–µ —É–ª—É—á—à–µ–Ω–∏—è (1 –Ω–µ–¥–µ–ª—è)

7. üöÄ **Real-time Webhooks**
   - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é HikCentral
   - –ù–∞—Å—Ç—Ä–æ–∏—Ç—å webhook endpoint
   - –û–±—Ä–∞–±–æ—Ç–∫–∞ real-time —Å–æ–±—ã—Ç–∏–π
   - Fallback –Ω–∞ polling –ø—Ä–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ webhook

8. üöÄ **Advanced Analytics**
   - –°—Ä–µ–¥–Ω–µ–µ –≤—Ä–µ–º—è –ø—Ä–µ–±—ã–≤–∞–Ω–∏—è
   - –ü–æ–ø—É–ª—è—Ä–Ω—ã–µ —á–∞—Å—ã –≤–∏–∑–∏—Ç–æ–≤
   - –ü—Ä–æ–≥–Ω–æ–∑–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞–≥—Ä—É–∑–∫–∏
   - ML –¥–ª—è –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏—è –∞–Ω–æ–º–∞–ª–∏–π

---

## üéØ –†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–ò

### –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è (—Å–µ–π—á–∞—Å):

```python
# visitor_system/visitor_system/celery.py
'monitor-guest-passages': {
    'task': 'hikvision_integration.tasks.monitor_guest_passages_task',
    'schedule': crontab(minute='*/1'),  # ‚Üê –ò–ó–ú–ï–ù–ò–¢–¨ —Å 5 –Ω–∞ 1 –º–∏–Ω—É—Ç—É
}
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**
- ‚ö° –í 5 —Ä–∞–∑ –±—ã—Å—Ç—Ä–µ–µ —Ä–µ–∞–∫—Ü–∏—è (1 –º–∏–Ω –≤–º–µ—Å—Ç–æ 5)
- ‚úÖ –ù–∏–∫–∞–∫–∏—Ö –¥—Ä—É–≥–∏—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π –Ω–µ –Ω—É–∂–Ω–æ
- üìä –ë–∞—Ç—á–∏–Ω–≥ —É–∂–µ –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω (1 API –∑–∞–ø—Ä–æ—Å –Ω–∞ –≤—Å–µ —Å–æ–±—ã—Ç–∏—è)

---

### –û–ø—Ç–∏–º–∞–ª—å–Ω–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è:

```python
# settings.py
HIKCENTRAL_AUTO_CHECKIN = True  # –í–∫–ª—é—á–∏—Ç—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π check-in
HIKCENTRAL_AUTO_CHECKOUT = True  # –í–∫–ª—é—á–∏—Ç—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π checkout
HIKCENTRAL_MONITORING_INTERVAL = 60  # –ò–Ω—Ç–µ—Ä–≤–∞–ª –≤ —Å–µ–∫—É–Ω–¥–∞—Ö (1 –º–∏–Ω—É—Ç–∞)
HIKCENTRAL_SEND_NOTIFICATIONS = True  # –û—Ç–ø—Ä–∞–≤–ª—è—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
HIKCENTRAL_DETECT_ANOMALIES = True  # –û–±–Ω–∞—Ä—É–∂–µ–Ω–∏–µ –∞–Ω–æ–º–∞–ª–∏–π
```

---

## üìä –¢–ï–ö–£–©–ê–Ø –°–¢–ê–¢–ò–°–¢–ò–ö–ê

**API –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è:**
- `/artemis/api/acs/v1/door/events` ‚úÖ

**Event Types:**
- `1` = –í—Ö–æ–¥ (Entry) ‚úÖ
- `2` = –í—ã—Ö–æ–¥ (Exit) ‚úÖ

**–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –¥–µ–π—Å—Ç–≤–∏—è:**
- ‚úÖ Auto check-in: `EXPECTED` ‚Üí `CHECKED_IN`
- ‚úÖ Auto checkout: `CHECKED_IN` ‚Üí `CHECKED_OUT`
- ‚úÖ AuditLog —Å–æ–∑–¥–∞–µ—Ç—Å—è
- ‚úÖ –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ—Ç–ø—Ä–∞–≤–ª—è—é—Ç—Å—è
- ‚úÖ –î–æ—Å—Ç—É–ø –æ—Ç–∑—ã–≤–∞–µ—Ç—Å—è –ø–æ—Å–ª–µ –≤—ã—Ö–æ–¥–∞

**–ò–Ω—Ç–µ—Ä–≤–∞–ª:** –ö–∞–∂–¥—ã–µ 5 –º–∏–Ω—É—Ç (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è 1-2 –º–∏–Ω—É—Ç—ã)

**–ë–∞—Ç—á–∏–Ω–≥:** ‚úÖ –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω (1 API –∑–∞–ø—Ä–æ—Å –¥–ª—è –≤—Å–µ—Ö –≥–æ—Å—Ç–µ–π)

---

## ‚úÖ –ò–¢–û–ì

### –°—Ç–∞—Ç—É—Å: üü¢ **–ü–û–õ–ù–û–°–¢–¨–Æ –†–ï–ê–õ–ò–ó–û–í–ê–ù–û**

–§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ check-in/checkout **–£–ñ–ï –†–ê–ë–û–¢–ê–ï–¢** –∏ **–ù–ï –¢–†–ï–ë–£–ï–¢** –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–π —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏!

**–ß—Ç–æ –Ω—É–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å:**
1. ‚úÖ **–ü—Ä–æ–≤–µ—Ä–∏—Ç—å** —á—Ç–æ –∑–∞–¥–∞—á–∞ `monitor_guest_passages` –∑–∞–ø—É—â–µ–Ω–∞ –≤ Celery Beat
2. ‚úÖ **–£–º–µ–Ω—å—à–∏—Ç—å –∏–Ω—Ç–µ—Ä–≤–∞–ª** —Å 5 –¥–æ 1-2 –º–∏–Ω—É—Ç (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
3. ‚úÖ **–ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å** –ø—Ä–æ—Ö–æ–¥ —á–µ—Ä–µ–∑ —Ç—É—Ä–Ω–∏–∫–µ—Ç
4. ‚úÖ **–ù–∞—Å—Ç—Ä–æ–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è** (—É–∂–µ —Ä–∞–±–æ—Ç–∞—é—Ç)

**–û—Ç–º–µ–Ω–∞ –≤–∏–∑–∏—Ç–∞ –≤—Ä—É—á–Ω—É—é:**
- ‚úÖ –û—Å—Ç–∞–µ—Ç—Å—è —á–µ—Ä–µ–∑ –∫–Ω–æ–ø–∫—É –≤ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–µ
- ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏–∫–∞ —Ç–æ–ª—å–∫–æ –¥–ª—è check-in/checkout

**–ù–∏–∫–∞–∫–∏—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π –∫–æ–¥–∞ –Ω–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è - –≤—Å–µ —É–∂–µ —Ä–∞–±–æ—Ç–∞–µ—Ç!** üéâ

---

**–ê–≤—Ç–æ—Ä:** AI Assistant  
**–î–∞—Ç–∞:** 14.10.2025  
**–ú–µ—Ç–æ–¥:** Sequential Thinking Analysis

